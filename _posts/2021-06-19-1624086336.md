---
title: Spring Boot æ¶ˆæ¯é˜Ÿåˆ— RocketMQ å…¥é—¨
categories: Spring Boot RocketMQ æ¶ˆæ¯é˜Ÿåˆ—
tags: 
---
# 1\. æ¦‚è¿°

å¦‚æœèƒ–å‹è¿˜æ²¡äº†è§£è¿‡åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ— Apache RocketMQ ï¼Œå»ºè®®å…ˆé˜…è¯»ä¸‹è‰¿è‰¿å†™çš„ ã€ŠèŠ‹é“ RocketMQ æç®€å…¥é—¨ã€‹
æ–‡ç« ã€‚è™½ç„¶è¿™ç¯‡æ–‡ç« æ ‡é¢˜æ˜¯å®‰è£…éƒ¨ç½²ï¼Œå®é™…å¯ä»¥ç†è§£æˆã€Šä¸€æ–‡å¸¦ä½ å¿«é€Ÿå…¥é—¨ RocketMQã€‹ï¼Œå“ˆå“ˆå“ˆã€‚

è€ƒè™‘è¿™æ˜¯ RocketMQ å¦‚ä½•åœ¨ Spring Boot æ•´åˆä¸ä½¿ç”¨çš„æ–‡ç« ï¼Œæ‰€ä»¥è¿˜æ˜¯ç®€å•ä»‹ç»ä¸‹ RocketMQ æ˜¯ä»€ä¹ˆï¼Ÿ

> FROM ã€Šæ¶ˆæ¯ä¸­é—´ä»¶ Apache RocketMQã€‹
>
> RocketMQ
> æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼ŒåŸºäºé«˜å¯ç”¨åˆ†å¸ƒå¼é›†ç¾¤æŠ€æœ¯ï¼Œæä¾›ä½å»¶æ—¶çš„ã€é«˜å¯é çš„æ¶ˆæ¯å‘å¸ƒä¸è®¢é˜…æœåŠ¡ã€‚åŒæ—¶ï¼Œå¹¿æ³›åº”ç”¨äºå¤šä¸ªé¢†åŸŸï¼ŒåŒ…æ‹¬å¼‚æ­¥é€šä¿¡è§£è€¦ã€ä¼ä¸šè§£å†³æ–¹æ¡ˆã€é‡‘èæ”¯ä»˜ã€ç”µä¿¡ã€ç”µå­å•†åŠ¡ã€å¿«é€’ç‰©æµã€å¹¿å‘Šè¥é”€ã€ç¤¾äº¤ã€å³æ—¶é€šä¿¡ã€ç§»åŠ¨åº”ç”¨ã€æ‰‹æ¸¸ã€è§†é¢‘ã€ç‰©è”ç½‘ã€è½¦è”ç½‘ç­‰ã€‚
>
> å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
>
>   * èƒ½å¤Ÿä¿è¯ä¸¥æ ¼çš„æ¶ˆæ¯é¡ºåº
>   * æä¾›ä¸°å¯Œçš„æ¶ˆæ¯æ‹‰å–æ¨¡å¼
>   * é«˜æ•ˆçš„è®¢é˜…è€…æ°´å¹³æ‰©å±•èƒ½åŠ›
>   * å®æ—¶çš„æ¶ˆæ¯è®¢é˜…æœºåˆ¶
>   * äº¿çº§æ¶ˆæ¯å †ç§¯èƒ½åŠ›
>

>
> psï¼š Metaq 3.0 ç‰ˆæœ¬æ”¹åï¼Œäº§å“åç§°æ”¹ä¸º RocketMQ

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šæ¯” ã€ŠèŠ‹é“ RocketMQ æç®€å…¥é—¨ã€‹ æä¾›æ›´å¤šçš„ç”Ÿäº§è€… Producer å’Œæ¶ˆè´¹è€… Consumer çš„ä½¿ç”¨ç¤ºä¾‹ã€‚ä¾‹å¦‚è¯´ï¼š

  * Producer ä¸‰ç§å‘é€æ¶ˆæ¯çš„æ–¹å¼ã€‚
  * Producer å‘é€ **é¡ºåº** æ¶ˆæ¯ï¼ŒConsumer **é¡ºåº** æ¶ˆè´¹æ¶ˆæ¯ã€‚
  * Producer å‘é€ **å®šæ—¶** æ¶ˆæ¯ã€‚
  * Producer **æ‰¹é‡** å‘é€æ¶ˆæ¯ã€‚
  * Producer å‘é€ **äº‹åŠ¡** æ¶ˆæ¯ã€‚
  * Consumer **å¹¿æ’­** å’Œ **é›†ç¾¤** æ¶ˆè´¹æ¶ˆæ¯ã€‚

èƒ–å‹ä½ å°±è¯´ï¼Œè‰¿è‰¿æ˜¯ä¸æ˜¯å¾ˆè‰¯å¿ƒã€‚ğŸ˜œ

# 2\. RocketMQ-Spring

RocketMQ-Spring é¡¹ç›®ï¼ŒRocketMQ å¯¹ Spring çš„é›†æˆæ”¯æŒã€‚ä¸»è¦æœ‰ä¸¤æ–¹é¢çš„åŠŸèƒ½ï¼š

  * åŠŸèƒ½ä¸€ï¼šæ”¯æŒ Spring Message è§„èŒƒï¼Œæ–¹ä¾¿å¼€å‘è€…ä»å…¶å®ƒ MQ å¿«é€Ÿåˆ‡æ¢åˆ° RocketMQ ã€‚
  * åŠŸèƒ½äºŒï¼šå¸®åŠ©å¼€å‘è€…åœ¨ Spring Boot ä¸­å¿«é€Ÿé›†æˆ RocketMQ ã€‚

æˆ‘ä»¬å…ˆä¸€èµ·äº†è§£ä¸‹ **åŠŸèƒ½ä¸€** ã€‚å¯¹äºå¤§å¤šæ•°å›½å†…çš„å¼€å‘è€…ï¼Œç›¸ä¿¡å¯¹ Spring Message
æ˜¯æ¯”è¾ƒé™Œç”Ÿçš„ï¼ŒåŒ…æ‹¬è‰¿è‰¿è‡ªå·±ã€‚æ‰€å¹¸è‰¿è‰¿æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ”¶è—å®¶ï¼Œæ— æ„ä¸­çœ‹åˆ°æœ‰ç¯‡æ–‡ç« ä»‹ç»äº† RocketMQ-Spring åœ¨è¿™å—çš„è®¾è®¡ä¸Šçš„æƒ³æ³•ï¼š

> FROM ã€Šæˆ‘ç”¨è¿™ç§æ–¹æ³•åœ¨ Spring ä¸­å®ç°æ¶ˆæ¯çš„å‘é€å’Œæ¶ˆæ¯ã€‹
>
> Spring Messaging æ˜¯ Spring Framework 4 ä¸­æ·»åŠ çš„æ¨¡å—ï¼Œæ˜¯Spring
> ä¸æ¶ˆæ¯ç³»ç»Ÿé›†æˆçš„ä¸€ä¸ªæ‰©å±•æ€§çš„æ”¯æŒã€‚å®ƒå®ç°äº†ä»åŸºäº JmsTemplate çš„ç®€å•çš„ä½¿ç”¨ JMS æ¥å£åˆ°å¼‚æ­¥æ¥æ”¶æ¶ˆæ¯çš„ä¸€æ•´å¥—å®Œæ•´çš„åŸºç¡€æ¶æ„ï¼ŒSpring
> AMQP æä¾›äº†è¯¥åè®®æ‰€è¦æ±‚çš„ç±»ä¼¼çš„åŠŸèƒ½é›†ã€‚åœ¨ä¸ Spring Boot
> çš„é›†æˆåï¼Œå®ƒæ‹¥æœ‰äº†è‡ªåŠ¨é…ç½®èƒ½åŠ›ï¼Œèƒ½å¤Ÿåœ¨æµ‹è¯•å’Œè¿è¡Œæ—¶ä¸ç›¸åº”çš„æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿè¿›è¡Œé›†æˆã€‚
>
> å•çº¯å¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼ŒSpring Messaging æä¾›äº†ä¸€å¥—æŠ½è±¡çš„ API
> æˆ–è€…è¯´æ˜¯çº¦å®šçš„æ ‡å‡†ï¼Œå¯¹æ¶ˆæ¯å‘é€ç«¯å’Œæ¶ˆæ¯æ¥æ”¶ç«¯çš„æ¨¡å¼è¿›è¡Œè§„å®šï¼Œä¸åŒçš„æ¶ˆæ¯ä¸­é—´ä»¶æä¾›å•†å¯ä»¥åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹æä¾›è‡ªå·±çš„ Spring å®ç°ï¼š
>
>   * åœ¨æ¶ˆæ¯å‘é€ç«¯ï¼Œéœ€è¦å®ç°çš„æ˜¯ä¸€ä¸ª XXXTemplate å½¢å¼çš„ Java Bean ï¼Œç»“åˆ Spring Boot
> çš„è‡ªåŠ¨åŒ–é…ç½®é€‰é¡¹æä¾›å¤šä¸ªä¸åŒçš„å‘é€æ¶ˆæ¯æ–¹æ³•ï¼›
>   * åœ¨æ¶ˆæ¯çš„æ¶ˆè´¹ç«¯ï¼Œæ˜¯ä¸€ä¸ª XXXMessageListener æ¥å£ï¼ˆå®ç°æ–¹å¼é€šå¸¸ä¼šä½¿ç”¨ä¸€ä¸ªæ³¨è§£æ¥å£°æ˜ä¸€ä¸ªæ¶ˆæ¯é©±åŠ¨çš„ POJO
> ï¼‰ï¼Œæä¾›å›è°ƒæ–¹æ³•æ¥ç›‘å¬å’Œæ¶ˆè´¹æ¶ˆæ¯ï¼Œè¿™ä¸ªæ¥å£åŒæ ·å¯ä»¥ä½¿ç”¨ Spring Boot çš„è‡ªåŠ¨åŒ–é€‰é¡¹å’Œä¸€äº›å®šåˆ¶åŒ–çš„å±æ€§ã€‚
>

>
> å¦‚æœæœ‰å…´è¶£æ·±å…¥çš„äº†è§£ Spring Messaging åŠé’ˆå¯¹ä¸åŒçš„æ¶ˆæ¯äº§å“çš„ä½¿ç”¨ï¼Œæ¨èé˜…è¯»è¿™ä¸ªæ–‡ä»¶ã€‚å‚è€ƒ Spring Messaging
> çš„æ—¢æœ‰å®ç°ï¼Œ RocketMQ çš„ spring-boot-starter ä¸­éµå¾ªäº†ç›¸å…³çš„è®¾è®¡æ¨¡å¼ï¼Œå¹¶ç»“åˆ RocketMQ è‡ªèº«çš„åŠŸèƒ½ç‰¹ç‚¹æä¾›äº†ç›¸åº”çš„
> API(å¦‚ï¼Œé¡ºåºï¼Œå¼‚æ­¥å’Œäº‹åŠ¡åŠæ¶ˆæ¯ç­‰)ã€‚

è¿™æ ·ä¸€æ’¸ï¼Œæ˜¯ä¸æ˜¯æ¸…æ™°å¤šäº†ã€‚ç®€å•æ¥è¯´ï¼ŒRocketMQ-Spring å°±æ˜¯åŸºäº Spring Message æ¥å®ç° RocketMQ çš„å‘é€ç«¯å’Œæ¥æ”¶ç«¯ã€‚

æˆ‘ä»¬å†ä¸€èµ·äº†è§£ä¸‹ **åŠŸèƒ½äºŒ** ã€‚æ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯æä¾›äº† RocketMQ çš„ spring-boot-starter åŠŸèƒ½ï¼Œå®ç° RocketMQ
çš„è‡ªåŠ¨åŒ–é…ç½®ã€‚

ä¸è¿‡ï¼Œè¿™é‡Œè‰¿è‰¿è¿˜æ˜¯æƒ³å¼±å¼±åæ§½ä¸€å¥ï¼ŒRocketMQ çš„ **å®˜æ–¹** spring-boot-starter çœŸçš„æœ‰ç‚¹å‡ºçš„å¤ªæ™šäº†ã€‚å¦‚ä¸‹æ˜¯æ•´ç†çš„æ—¶é—´è½´ï¼š

  * 2014-08 Spring Boot 1 æ­£å¼å‘å¸ƒã€‚
  * 2018-03 Spring Boot 2 æ­£å¼å‘å¸ƒã€‚
  * 2018-12 RocketMQ å›¢é˜Ÿå‘å¸ƒ RocketMQ é›†æˆåˆ° Spring Boot çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”æä¾›äº†ä¸­æ–‡æ–‡æ¡£ã€‚

# 3\. å¿«é€Ÿå…¥é—¨

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼šlab-31-rocketmq-demo ã€‚

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬å…ˆæ¥å¯¹ RocketMQ-Spring åšä¸€ä¸ªå¿«é€Ÿå…¥é—¨ï¼Œå®ç° Producer ä¸‰ç§å‘é€æ¶ˆæ¯çš„æ–¹å¼çš„åŠŸèƒ½ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ª Consumer
æ¶ˆè´¹æ¶ˆæ¯ã€‚

è€ƒè™‘åˆ°ä¸€ä¸ªåº”ç”¨æ—¢å¯ä»¥ä½¿ç”¨ç”Ÿäº§è€… Producer ï¼Œåˆå¯ä»¥ä½¿ç”¨æ¶ˆè´¹è€… Consumer ï¼Œæ‰€ä»¥ç¤ºä¾‹å°±åšæˆä¸€ä¸ª lab-31-rocketmq-demo
é¡¹ç›®ã€‚

## 3.1 å¼•å…¥ä¾èµ–

åœ¨ `pom.xml` æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ç›¸å…³ä¾èµ–ã€‚

    
    
    <?xml version="1.0" encoding="UTF-8"?>
    <project xmlns="http://maven.apache.org/POM/4.0.0"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
        <parent>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-parent</artifactId>
            <version>2.2.1.RELEASE</version>
            <relativePath/> <!-- lookup parent from repository -->
        </parent>
        <modelVersion>4.0.0</modelVersion>
    
        <artifactId>lab-31-rocketmq-demo</artifactId>
    
        <dependencies>
            <!-- å®ç°å¯¹ RocketMQ çš„è‡ªåŠ¨åŒ–é…ç½® -->
            <dependency>
                <groupId>org.apache.rocketmq</groupId>
                <artifactId>rocketmq-spring-boot-starter</artifactId>
                <version>2.0.4</version>
            </dependency>
    
            <!-- æ–¹ä¾¿ç­‰ä¼šå†™å•å…ƒæµ‹è¯• -->
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-test</artifactId>
                <scope>test</scope>
            </dependency>
        </dependencies>
    
    </project>

## 3.2 åº”ç”¨é…ç½®æ–‡ä»¶

åœ¨ `resources` ç›®å½•ä¸‹ï¼Œåˆ›å»º `application.yaml` é…ç½®æ–‡ä»¶ã€‚é…ç½®å¦‚ä¸‹ï¼š

    
    
    # rocketmq é…ç½®é¡¹ï¼Œå¯¹åº” RocketMQProperties é…ç½®ç±»
    rocketmq:
      name-server: 127.0.0.1:9876 # RocketMQ Namesrv
      # Producer é…ç½®é¡¹
      producer:
        group: demo-producer-group # ç”Ÿäº§è€…åˆ†ç»„
        send-message-timeout: 3000 # å‘é€æ¶ˆæ¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤ä¸º 3000 ã€‚
        compress-message-body-threshold: 4096 # æ¶ˆæ¯å‹ç¼©é˜€å€¼ï¼Œå½“æ¶ˆæ¯ä½“çš„å¤§å°è¶…è¿‡è¯¥é˜€å€¼åï¼Œè¿›è¡Œæ¶ˆæ¯å‹ç¼©ã€‚é»˜è®¤ä¸º 4 * 1024B
        max-message-size: 4194304 # æ¶ˆæ¯ä½“çš„æœ€å¤§å…è®¸å¤§å°ã€‚ã€‚é»˜è®¤ä¸º 4 * 1024 * 1024B
        retry-times-when-send-failed: 2 # åŒæ­¥å‘é€æ¶ˆæ¯æ—¶ï¼Œå¤±è´¥é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤ä¸º 2 æ¬¡ã€‚
        retry-times-when-send-async-failed: 2 # å¼‚æ­¥å‘é€æ¶ˆæ¯æ—¶ï¼Œå¤±è´¥é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤ä¸º 2 æ¬¡ã€‚
        retry-next-server: false # å‘é€æ¶ˆæ¯ç»™ Broker æ—¶ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡è¯•å¦å¤–ä¸€å° Broker ã€‚é»˜è®¤ä¸º false
        access-key: # Access Key ï¼Œå¯é˜…è¯» https://github.com/apache/rocketmq/blob/master/docs/cn/acl/user_guide.md æ–‡æ¡£
        secret-key: # Secret Key
        enable-msg-trace: true # æ˜¯å¦å¼€å¯æ¶ˆæ¯è½¨è¿¹åŠŸèƒ½ã€‚é»˜è®¤ä¸º true å¼€å¯ã€‚å¯é˜…è¯» https://github.com/apache/rocketmq/blob/master/docs/cn/msg_trace/user_guide.md æ–‡æ¡£
        customized-trace-topic: RMQ_SYS_TRACE_TOPIC # è‡ªå®šä¹‰æ¶ˆæ¯è½¨è¿¹çš„ Topic ã€‚é»˜è®¤ä¸º RMQ_SYS_TRACE_TOPIC ã€‚
      # Consumer é…ç½®é¡¹
      consumer:
        listeners: # é…ç½®æŸä¸ªæ¶ˆè´¹åˆ†ç»„ï¼Œæ˜¯å¦ç›‘å¬æŒ‡å®š Topic ã€‚ç»“æ„ä¸º Map<æ¶ˆè´¹è€…åˆ†ç»„, <Topic, Boolean>> ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸é…ç½®è¡¨ç¤ºç›‘å¬ã€‚
          test-consumer-group:
            topic1: false # å…³é—­ test-consumer-group å¯¹ topic1 çš„ç›‘å¬æ¶ˆè´¹

  * åœ¨ `rocketmq` é…ç½®é¡¹ï¼Œè®¾ç½® RocketMQ çš„é…ç½®ï¼Œå¯¹åº” RocketMQProperties é…ç½®ç±»ã€‚
  * RocketMQ-Spring RocketMQAutoConfiguration è‡ªåŠ¨åŒ–é…ç½®ç±»ï¼Œå®ç° RocketMQ çš„è‡ªåŠ¨é…ç½®ï¼Œåˆ›å»ºç›¸åº”çš„ Producer å’Œ Consumer ã€‚
  * `rocketmq.name-server` é…ç½®é¡¹ï¼Œè®¾ç½® RocketMQ Namesrv åœ°å€ã€‚å¦‚æœå¤šä¸ªï¼Œä½¿ç”¨é€—å·åˆ†éš”ã€‚
  * `rocketmq.producer` é…ç½®é¡¹ï¼Œä¸€çœ‹å°±çŸ¥é“æ˜¯ RocketMQ Producer æ‰€ç‹¬æœ‰ã€‚ 
    * `group` é…ç½®ï¼Œç”Ÿäº§è€…åˆ†ç»„ã€‚
    * `retry-next-server` é…ç½®ï¼Œå‘é€æ¶ˆæ¯ç»™ Broker æ—¶ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡è¯•å¦å¤–ä¸€å° Broker ã€‚é»˜è®¤ä¸º `false` ã€‚å¦‚æœèƒ–å‹ä½¿ç”¨å¤š **ä¸»** Broker çš„æƒ…å†µä¸‹ï¼Œéœ€è¦è®¾ç½® `true` ï¼Œè¿™æ ·æ‰ä¼šåœ¨å‘é€æ¶ˆæ¯å¤±è´¥æ—¶ï¼Œé‡è¯•å¦å¤–ä¸€å° Broker ã€‚
    * å…¶å®ƒé…ç½®ï¼Œä¸€èˆ¬é»˜è®¤å³å¯ã€‚
  * `rocketmq.consumer` é…ç½®é¡¹ï¼Œä¸€çœ‹å°±çŸ¥é“æ˜¯ RocketMQ Consumer æ‰€ç‹¬æœ‰ã€‚ 
    * `listener` é…ç½®ï¼Œé…ç½®æŸä¸ªæ¶ˆè´¹åˆ†ç»„ï¼Œæ˜¯å¦ç›‘å¬æŒ‡å®š Topic ã€‚ç»“æ„ä¸º `Map<æ¶ˆè´¹è€…åˆ†ç»„, <Topic, Boolean>>` ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ **ä¸é…ç½®è¡¨ç¤ºç›‘å¬** ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªæœ‰æˆ‘ä»¬åœ¨æƒ³ä¸ç›‘å¬æ¶ˆè´¹æŸä¸ªæ¶ˆè´¹åˆ†ç»„çš„æŸä¸ª Topic æ—¶ï¼Œæ‰éœ€è¦é… `listener` é…ç½®ã€‚

## 3.3 Application

åˆ›å»º `Application.java` ç±»ï¼Œé…ç½® `@SpringBootApplication` æ³¨è§£å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Application.java
    
    @SpringBootApplication
    public class Application {
    
        public static void main(String[] args) {
            SpringApplication.run(Application.class, args);
        }
    
    }

## 3.5 Demo01Message

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.message` åŒ…ä¸‹ï¼Œåˆ›å»º Demo01Message
æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo01Message.java
    
    public class Demo01Message {
    
        public static final String TOPIC = "DEMO_01";
    
        /**
         * ç¼–å·
         */
        private Integer id;
    
        // ... çœç•¥ set/get/toString æ–¹æ³•
    
    }

  * `TOPIC` é™æ€å±æ€§ï¼Œæˆ‘ä»¬è®¾ç½®è¯¥æ¶ˆæ¯ç±»å¯¹åº” Topic ä¸º `"DEMO_01"` ã€‚

## 3.6 Demo01Producer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.producer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo01Producer
ç±»ï¼Œå®ƒä¼šä½¿ç”¨ RocketMQ-Spring å°è£…æä¾›çš„ RocketMQTemplate ï¼Œå®ç°ä¸‰ç§å‘é€æ¶ˆæ¯çš„æ–¹å¼ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo01Producer.java
    
    @Component
    public class Demo01Producer {
    
        @Autowired
        private RocketMQTemplate rocketMQTemplate;
    
        public SendResult syncSend(Integer id) {
            // åˆ›å»º Demo01Message æ¶ˆæ¯
            Demo01Message message = new Demo01Message();
            message.setId(id);
            // åŒæ­¥å‘é€æ¶ˆæ¯
            return rocketMQTemplate.syncSend(Demo01Message.TOPIC, message);
        }
    
        public void asyncSend(Integer id, SendCallback callback) {
            // åˆ›å»º Demo01Message æ¶ˆæ¯
            Demo01Message message = new Demo01Message();
            message.setId(id);
            // å¼‚æ­¥å‘é€æ¶ˆæ¯
            rocketMQTemplate.asyncSend(Demo01Message.TOPIC, message, callback);
        }
    
        public void onewaySend(Integer id) {
            // åˆ›å»º Demo01Message æ¶ˆæ¯
            Demo01Message message = new Demo01Message();
            message.setId(id);
            // oneway å‘é€æ¶ˆæ¯
            rocketMQTemplate.sendOneWay(Demo01Message.TOPIC, message);
        }
    
    }

  * ä¸‰ä¸ªæ–¹æ³•ï¼Œå¯¹åº”ä¸‰ä¸ª RocketMQ å‘é€æ¶ˆæ¯çš„æ–¹å¼ï¼Œåˆ†åˆ«è°ƒç”¨ RocketMQTemplate æä¾›çš„ `#syncSend(...)` å’Œ `#asyncSend(...)` ä»¥åŠ `#sendOneWay(...)` æ–¹æ³•ã€‚

æˆ‘ä»¬æ¥ç®€å•èŠä¸‹ RocketMQTemplate ç±»ï¼Œå®ƒç»§æ‰¿ Spring Messaging å®šä¹‰çš„
AbstractMessageSendingTemplate æŠ½è±¡ç±»ï¼Œä»¥è¾¾åˆ°èå…¥ Spring Messaging ä½“ç³»ä¸­ã€‚

åœ¨ RocketMQTemplate ä¸­ï¼Œä¼šåˆ›å»ºä¸€ä¸ª RocketMQ DefaultMQProducer ç”Ÿäº§è€… `producer` ï¼Œæ‰€ä»¥
RocketMQTemplate åç»­çš„å„ç§å‘é€æ¶ˆæ¯çš„æ–¹æ³•ï¼Œéƒ½æ˜¯ä½¿ç”¨å®ƒã€‚ğŸ˜ˆ å½“ç„¶ï¼Œå› ä¸º RocketMQTemplate çš„å°è£…ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨
Spring Messaging ä¸€æ ·çš„æ–¹å¼ï¼Œè¿›è¡Œæ¶ˆæ¯çš„å‘é€ï¼Œè€Œæ— éœ€ç›´æ¥ä½¿ç”¨ RocketMQ æä¾›çš„ Producer å‘é€æ¶ˆæ¯ã€‚

å¯¹äºèƒ–å‹æ¥è¯´ï¼Œå¯èƒ½æœ€å…³å¿ƒçš„æ˜¯ï¼Œæ¶ˆæ¯ Message æ˜¯æ€ä¹ˆåºåˆ—åŒ–çš„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ RocketMQUtil#convertToRocketMessage(â€¦)
æ–¹æ³•çš„ä»£ç ï¼š

    
    
    // RocketMQTemplate.java
    
    public SendResult syncSend(String destination, Object payload, long timeout) {
        Message<?> message = MessageBuilder.withPayload(payload).build(); // <X>
        // ... çœç•¥å…¶å®ƒä»£ç 
    }
    
    //  RocketMQUti.java
    
    public static org.apache.rocketmq.common.message.Message convertToRocketMessage(
        MessageConverter messageConverter, String charset,
        String destination, org.springframework.messaging.Message<?> message) {
        Object payloadObj = message.getPayload();
        byte[] payloads;
        try {
            if (null == payloadObj) {
                throw new RuntimeException("the message cannot be empty");
            }
            // å¦‚æœæ˜¯ String ç±»å‹ï¼Œåˆ™ç›´æ¥è·å¾—å…¶ byte[] å†…å®¹ã€‚
            if (payloadObj instanceof String) {
                payloads = ((String)payloadObj).getBytes(Charset.forName(charset));
            // å¦‚æœæ˜¯ byte[] ç±»å‹ï¼Œåˆ™ç›´æ¥ä½¿ç”¨å³å¯
            } else if (payloadObj instanceof byte[]) {
                payloads = (byte[])message.getPayload();
            // å¦‚æœæ˜¯å¤æ‚å¯¹è±¡ç±»å‹ï¼Œåˆ™ä½¿ç”¨ MessageConverter è¿›è¡Œè½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œç„¶åå†è·å¾—å­—ç¬¦ä¸²çš„ byte[] å†…å®¹ã€‚
            } else {
                String jsonObj = (String)messageConverter.fromMessage(message, payloadObj.getClass());
                if (null == jsonObj) {
                    throw new RuntimeException(String.format(
                        "empty after conversion [messageConverter:%s,payloadClass:%s,payloadObj:%s]",
                        messageConverter.getClass(), payloadObj.getClass(), payloadObj));
                }
                payloads = jsonObj.getBytes(Charset.forName(charset));
            }
        } catch (Exception e) {
            throw new RuntimeException("convert to RocketMQ message failed.", e);
        }
        // è½¬æ¢æˆ RocketMQ Message
        return getAndWrapMessage(destination, message.getHeaders(), payloads);
    }

  * åœ¨ `<X>` å¤„ï¼ŒRocketMQTemplate ä¼šé€šè¿‡ Spring Messaging çš„ MessageBuilder å°†æˆ‘ä»¬ä¼ å…¥çš„æ¶ˆæ¯ `payload` è½¬æ¢æˆ Spring Messaging çš„ Message æ¶ˆæ¯å¯¹è±¡ã€‚
  * `RocketMQUtil#convertToRocketMessage(...)` çš„ä»£ç ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹è‰¿è‰¿æ·»åŠ çš„æ³¨é‡Šï¼Œè¿›è¡Œä¸‹ç†è§£ã€‚å› ä¸ºæˆ‘ä»¬ä¸€èˆ¬æ¶ˆæ¯éƒ½æ˜¯ **å¤æ‚å¯¹è±¡** ç±»å‹ï¼Œæ‰€ä»¥ä¼šé‡‡ç”¨ MessageConverter è¿›è¡Œè½¬æ¢ã€‚RocketMQ-Spring çš„é»˜è®¤ä½¿ç”¨ MappingJackson2MessageConverter æˆ– MappingFastJsonMessageConverter ï¼Œå³ä½¿ç”¨ **JSON** æ ¼å¼åºåˆ—åŒ–å’Œååºåˆ—åŒ– Message æ¶ˆæ¯å†…å®¹ã€‚ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸¤ä¸ª MessageConverter ï¼Œèƒ–å‹å¯ä»¥è‡ªå·±çœ‹çœ‹ RocketMQ-Spring çš„ MessageConverterConfiguration é…ç½®ç±»ã€‚

## 3.7 Demo01Consumer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.consumer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo01Consumer
ç±»ï¼Œå®ç° Rocket-Spring å®šä¹‰çš„ RocketMQListener æ¥å£ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo01Consumer.java
    
    @Component
    @RocketMQMessageListener(
            topic = Demo01Message.TOPIC,
            consumerGroup = "demo01-consumer-group-" + Demo01Message.TOPIC
    )
    public class Demo01Consumer implements RocketMQListener<Demo01Message> {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Override
        public void onMessage(Demo01Message message) {
            logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
        }
    
    }

  * åœ¨ç±»ä¸Šï¼Œæ·»åŠ äº† `@RocketMQMessageListener` æ³¨è§£ï¼Œå£°æ˜æ¶ˆè´¹çš„ Topic æ˜¯ `"DEMO_01"` ï¼Œæ¶ˆè´¹è€…åˆ†ç»„æ˜¯ `"demo01-consumer-group-DEMO_01"` ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å»ºè®®ä¸€ä¸ªæ¶ˆè´¹è€…åˆ†ç»„ï¼Œä»…æ¶ˆè´¹ä¸€ä¸ª Topic ã€‚è¿™æ ·åšä¼šæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š 
    * æ¯ä¸ªæ¶ˆè´¹è€…åˆ†ç»„èŒè´£å•ä¸€ï¼Œåªæ¶ˆè´¹ä¸€ä¸ª Topic ã€‚
    * æ¯ä¸ªæ¶ˆè´¹è€…åˆ†ç»„æ˜¯ç‹¬å ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯å¤šä¸ª Topic éš”ç¦»åœ¨ä¸åŒçº¿ç¨‹æ± ï¼Œä¿è¯éš”ç¦»æ€§ï¼Œä»è€Œé¿å…ä¸€ä¸ª Topic æ¶ˆè´¹å¾ˆæ…¢ï¼Œå½±å“åˆ°å¦å¤–çš„ Topic çš„æ¶ˆè´¹ã€‚
  * å®ç° RocketMQListener æ¥å£ï¼Œåœ¨ `T` æ³›å‹é‡Œï¼Œè®¾ç½®æ¶ˆè´¹çš„æ¶ˆæ¯å¯¹åº”çš„ç±»ã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬å°±è®¾ç½®äº† Demo01Message ç±»ã€‚

## 3.9 Demo01AConsumer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.consumer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo01AConsumer
ç±»ï¼Œå®ç° Rocket-Spring å®šä¹‰çš„ RocketMQListener æ¥å£ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    @Component
    @RocketMQMessageListener(
            topic = Demo01Message.TOPIC,
            consumerGroup = "demo01-A-consumer-group-" + Demo01Message.TOPIC
    )
    public class Demo01AConsumer implements RocketMQListener<MessageExt> {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Override
        public void onMessage(MessageExt message) {
            logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
        }
    
    }

  * æ•´ä½“å’Œ ã€Œ3.8 Demo01Consumerã€ æ˜¯ä¸€è‡´çš„ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªå·®å¼‚ç‚¹ï¼Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åˆé¢å¤–åˆ›å»ºäº†è¿™ä¸ªæ¶ˆè´¹è€…çš„åŸå› ã€‚

**å·®å¼‚ä¸€** ï¼Œåœ¨ç±»ä¸Šï¼Œæ·»åŠ äº† `@RocketMQMessageListener` æ³¨è§£ï¼Œå£°æ˜æ¶ˆè´¹çš„ Topic **è¿˜æ˜¯** `"DEMO_01"`
ï¼Œæ¶ˆè´¹è€…åˆ†ç»„ä¿® **æ”¹æˆ** äº† `"demo01-A-consumer-group-DEMO_01"` ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æµ‹è¯• RocketMQ
é›†ç¾¤æ¶ˆè´¹çš„ç‰¹æ€§ã€‚

> é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰ï¼šé›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹å¹³å‡åˆ†æ‘Šæ¶ˆæ¯ã€‚

  * ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬å‘é€ä¸€æ¡ Topic ä¸º `"DEMO_01"` çš„æ¶ˆæ¯ï¼Œå¯ä»¥åˆ†åˆ«è¢« `"demo01-A-consumer-group-DEMO_01"` å’Œ `"demo01-consumer-group-DEMO_01"` éƒ½æ¶ˆè´¹ä¸€æ¬¡ã€‚
  * ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å¯åŠ¨ä¸¤ä¸ªè¯¥ç¤ºä¾‹çš„å®ä¾‹ï¼Œåˆ™æ¶ˆè´¹è€…åˆ†ç»„ `"demo01-A-consumer-group-DEMO_01"` å’Œ `"demo01-consumer-group-DEMO_01"` éƒ½ä¼šæœ‰å¤šä¸ª Consumer ç¤ºä¾‹ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å†å‘é€ä¸€æ¡ Topic ä¸º `"DEMO_01"` çš„æ¶ˆæ¯ï¼Œåªä¼šè¢« `"demo01-A-consumer-group-DEMO_01"` çš„ä¸€ä¸ª Consumer æ¶ˆè´¹ä¸€æ¬¡ï¼Œä¹ŸåŒæ ·åªä¼šè¢« `"demo01-consumer-group-DEMO_01"` çš„ä¸€ä¸ª Consumer æ¶ˆè´¹ä¸€æ¬¡ã€‚

å¥½å¥½ç†è§£ä¸Šè¿°çš„ä¸¤æ®µè¯ï¼Œéå¸¸é‡è¦ã€‚

é€šè¿‡ **é›†ç¾¤æ¶ˆè´¹** çš„æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°é’ˆå¯¹ç›¸åŒ Topic ï¼Œä¸åŒæ¶ˆè´¹è€…åˆ†ç»„å®ç°å„è‡ªçš„ä¸šåŠ¡é€»è¾‘ã€‚ä¾‹å¦‚è¯´ï¼šç”¨æˆ·æ³¨å†ŒæˆåŠŸæ—¶ï¼Œå‘é€ä¸€æ¡ Topic ä¸º
`"USER_REGISTER"` çš„æ¶ˆæ¯ã€‚ç„¶åï¼Œä¸åŒæ¨¡å—ä½¿ç”¨ä¸åŒçš„æ¶ˆè´¹è€…åˆ†ç»„ï¼Œè®¢é˜…è¯¥ Topic ï¼Œå®ç°å„è‡ªçš„æ‹“å±•é€»è¾‘ï¼š

  * ç§¯åˆ†æ¨¡å—ï¼šåˆ¤æ–­å¦‚æœæ˜¯æ‰‹æœºæ³¨å†Œï¼Œç»™ç”¨æˆ·å¢åŠ  20 ç§¯åˆ†ã€‚
  * ä¼˜æƒ åŠµæ¨¡å—ï¼šå› ä¸ºæ˜¯æ–°ç”¨æˆ·ï¼Œæ‰€ä»¥å‘æ”¾æ–°ç”¨æˆ·ä¸“äº«ä¼˜æƒ åŠµã€‚
  * ç«™å†…ä¿¡æ¨¡å—ï¼šå› ä¸ºæ˜¯æ–°ç”¨æˆ·ï¼Œæ‰€ä»¥å‘é€æ–°ç”¨æˆ·çš„æ¬¢è¿è¯­çš„ç«™å†…ä¿¡ã€‚
  * â€¦ ç­‰ç­‰

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†æ³¨å†ŒæˆåŠŸåçš„ä¸šåŠ¡æ‹“å±•é€»è¾‘ï¼Œå®ç°ä¸šåŠ¡ä¸Šçš„è§£è€¦ï¼Œæœªæ¥ä¹Ÿæ›´åŠ å®¹æ˜“æ‹“å±•ã€‚åŒæ—¶ï¼Œä¹Ÿæé«˜äº†æ³¨å†Œæ¥å£çš„æ€§èƒ½ï¼Œé¿å…ç”¨æˆ·éœ€è¦ç­‰å¾…ä¸šåŠ¡æ‹“å±•é€»è¾‘æ‰§è¡Œå®Œæˆåï¼Œæ‰å“åº”æ³¨å†ŒæˆåŠŸã€‚

**å·®å¼‚äºŒ** ï¼Œå®ç° RocketMQListener æ¥å£ï¼Œåœ¨ `T` æ³›å‹é‡Œï¼Œè®¾ç½®æ¶ˆè´¹çš„æ¶ˆæ¯å¯¹åº”çš„ç±»ä¸æ˜¯ Demo01Message ç±»ï¼Œè€Œæ˜¯
RocketMQ å†…ç½®çš„ MessageExt ç±»ã€‚é€šè¿‡ MessageExt
ç±»ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°æ¶ˆè´¹çš„æ¶ˆæ¯çš„æ›´å¤šä¿¡æ¯ï¼Œä¾‹å¦‚è¯´æ¶ˆæ¯çš„æ‰€å±é˜Ÿåˆ—ã€åˆ›å»ºæ—¶é—´ç­‰ç­‰å±æ€§ï¼Œä¸è¿‡æ¶ˆæ¯çš„å†…å®¹(`body`)å°±éœ€è¦è‡ªå·±å»ååºåˆ—åŒ–ã€‚å½“ç„¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šä½¿ç”¨
MessageExt ç±»ã€‚

## 3.10 ç®€å•æµ‹è¯•

åˆ›å»º Demo01ProducerTest æµ‹è¯•ç±»ï¼Œç¼–å†™ä¸‰ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo01Producer ä¸‰ç§å‘é€æ¶ˆæ¯çš„æ–¹å¼ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo01ProducerTest.java
    
    @RunWith(SpringRunner.class)
    @SpringBootTest(classes = Application.class)
    public class Demo01ProducerTest {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Autowired
        private Demo01Producer producer;
    
        @Test
        public void testSyncSend() throws InterruptedException {
            int id = (int) (System.currentTimeMillis() / 1000);
            SendResult result = producer.syncSend(id);
            logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€ç»“æœï¼š[{}]]", id, result);
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
        @Test
        public void testASyncSend() throws InterruptedException {
            int id = (int) (System.currentTimeMillis() / 1000);
            producer.asyncSend(id, new SendCallback() {
    
                @Override
                public void onSuccess(SendResult result) {
                    logger.info("[testASyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸï¼Œç»“æœä¸ºï¼š[{}]]", id, result);
                }
    
                @Override
                public void onException(Throwable e) {
                    logger.info("[testASyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€å¼‚å¸¸]]", id, e);
                }
    
            });
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
        @Test
        public void testOnewaySend() throws InterruptedException {
            int id = (int) (System.currentTimeMillis() / 1000);
            producer.onewaySend(id);
            logger.info("[testOnewaySend][å‘é€ç¼–å·ï¼š[{}] å‘é€å®Œæˆ]", id);
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
    }

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testSyncSend()` æ–¹æ³•ï¼Œæµ‹è¯•åŒæ­¥å‘é€æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

    
    
    # Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸ
    2019-12-05 13:48:57.342  INFO 79342 --- [           main] c.i.s.l.r.producer.Demo01ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575438537] å‘é€ç»“æœï¼š[SendResult [sendStatus=SEND_OK, msgId=C0A8032C35EE18B4AAC2126A02770000, offsetMsgId=C0A8032C00002A9F000000000010E628, messageQueue=MessageQueue [topic=DEMO_01, brokerName=broker-a, queueId=0], queueOffset=255]]]
    
    # Demo01AConsumer æ¶ˆè´¹äº†ä¸€æ¬¡è¯¥æ¶ˆæ¯
    2019-12-05 13:48:57.347  INFO 79342 --- [MessageThread_1] c.i.s.l.r.consumer.Demo01AConsumer       : [onMessage][çº¿ç¨‹ç¼–å·:45 æ¶ˆæ¯å†…å®¹ï¼šMessageExt [queueId=0, storeSize=284, queueOffset=255, sysFlag=0, bornTimestamp=1575438537338, bornHost=/192.168.3.44:57823, storeTimestamp=1575438537340, storeHost=/192.168.3.44:10911, msgId=C0A8032C00002A9F000000000010E628, commitLogOffset=1107496, bodyCRC=1962202087, reconsumeTimes=0, preparedTransactionOffset=0, toString()=Message{topic='DEMO_01', flag=0, properties={MIN_OFFSET=0, MAX_OFFSET=256, CONSUME_START_TIME=1575438537347, id=b0e72a1c-cb11-5152-7d0d-c034b118a3e5, UNIQ_KEY=C0A8032C35EE18B4AAC2126A02770000, CLUSTER=DefaultCluster, WAIT=false, contentType=application/json, timestamp=1575438537333}, body=[123, 34, 105, 100, 34, 58, 49, 53, 55, 53, 52, 51, 56, 53, 51, 55, 125], transactionId='null'}]]
    
    # Demo01Consumer æ¶ˆè´¹äº†ä¸€æ¬¡è¯¥æ¶ˆæ¯
    2019-12-05 13:49:00.150  INFO 79342 --- [MessageThread_1] c.i.s.l.r.consumer.Demo01Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:51 æ¶ˆæ¯å†…å®¹ï¼šDemo01Message{id=1575438537}]

  * é€šè¿‡æ—¥å¿—æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å‘é€çš„æ¶ˆæ¯ï¼Œåˆ†åˆ«è¢« Demo01AConsumer å’Œ Demo01Consumer ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼ˆæ¶ˆè´¹è€…åˆ†ç»„ï¼‰éƒ½æ¶ˆè´¹äº†ä¸€æ¬¡ã€‚
  * åŒæ—¶ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…åœ¨ä¸åŒçš„çº¿ç¨‹æ± ä¸­ï¼Œæ¶ˆè´¹äº†è¿™æ¡æ¶ˆæ¯ã€‚è™½ç„¶è¯´ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸¤æ¡æ—¥å¿—é‡Œï¼Œæˆ‘ä»¬éƒ½çœ‹åˆ°äº†çº¿ç¨‹åä¸º `"MessageThread_1"` ï¼Œä½†æ˜¯çº¿ç¨‹ç¼–å·åˆ†åˆ«æ˜¯ 45 å’Œ 51 ã€‚ğŸ˜ˆ å› ä¸ºï¼Œæ¯ä¸ª RocketMQ Consumer çš„æ¶ˆè´¹çº¿ç¨‹æ± åˆ›å»ºçš„çº¿ç¨‹éƒ½æ˜¯ä»¥ `"MessageThread_"` å¼€å¤´ï¼ŒåŒæ—¶è¿™é‡Œç›¸åŒçš„çº¿ç¨‹åç»“æœä¸åŒçš„çº¿ç¨‹ç¼–å·ï¼Œå¾ˆå®¹æ˜“åˆ¤æ–­å‡ºæ—¶å€™ç”¨äº†ä¸¤ä¸ªä¸åŒçš„æ¶ˆè´¹çº¿ç¨‹æ± ã€‚

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testASyncSend()` æ–¹æ³•ï¼Œæµ‹è¯•å¼‚æ­¥å‘é€æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

> å‹æƒ…æç¤ºï¼šæ³¨æ„ï¼Œä¸è¦å…³é—­ `#testSyncSend()` å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬è¦æ¨¡æ‹Ÿæ¯ä¸ªæ¶ˆè´¹è€…é›†ç¾¤ï¼Œéƒ½æœ‰å¤šä¸ª Consumer èŠ‚ç‚¹ã€‚
    
    
    // Producer å¼‚æ­¥å‘é€æ¶ˆæ¯æˆåŠŸ
    2019-12-05 13:56:34.366  INFO 79642 --- [ublicExecutor_4] c.i.s.l.r.producer.Demo01ProducerTest    : [testASyncSend][å‘é€ç¼–å·ï¼š[1575438994] å‘é€æˆåŠŸï¼Œç»“æœä¸ºï¼š[SendResult [sendStatus=SEND_OK, msgId=C0A8032C371A18B4AAC21270FBB70000, offsetMsgId=C0A8032C00002A9F000000000010E8CA, messageQueue=MessageQueue [topic=DEMO_01, brokerName=broker-a, queueId=3], queueOffset=256]]]
    
    # Demo01AConsumer æ¶ˆè´¹äº†ä¸€æ¬¡è¯¥æ¶ˆæ¯
    2019-12-05 13:56:34.370  INFO 79642 --- [MessageThread_1] c.i.s.l.r.consumer.Demo01AConsumer       : [onMessage][çº¿ç¨‹ç¼–å·:47 æ¶ˆæ¯å†…å®¹ï¼šMessageExt [queueId=3, storeSize=284, queueOffset=256, sysFlag=0, bornTimestamp=1575438994361, bornHost=/192.168.3.44:57926, storeTimestamp=1575438994364, storeHost=/192.168.3.44:10911, msgId=C0A8032C00002A9F000000000010E8CA, commitLogOffset=1108170, bodyCRC=412662346, reconsumeTimes=0, preparedTransactionOffset=0, toString()=Message{topic='DEMO_01', flag=0, properties={MIN_OFFSET=0, MAX_OFFSET=257, CONSUME_START_TIME=1575438994370, id=80b9f381-febe-6cda-02e7-43bf8f8a5c8a, UNIQ_KEY=C0A8032C371A18B4AAC21270FBB70000, CLUSTER=DefaultCluster, WAIT=false, contentType=application/json, timestamp=1575438994356}, body=[123, 34, 105, 100, 34, 58, 49, 53, 55, 53, 52, 51, 56, 57, 57, 52, 125], transactionId='null'}]]
    
    # Demo01Consumer æ¶ˆè´¹äº†ä¸€æ¬¡è¯¥æ¶ˆæ¯
    2019-12-05 13:56:34.402  INFO 79642 --- [MessageThread_1] c.i.s.l.r.consumer.Demo01Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:46 æ¶ˆæ¯å†…å®¹ï¼šDemo01Message{id=1575438994}]

  * å’Œ `#testSyncSend()` æ–¹æ³•æ‰§è¡Œçš„ç»“æœï¼Œæ˜¯ä¸€è‡´çš„ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬æ‰“å¼€ `#testSyncSend()` æ–¹æ³•æ‰€åœ¨çš„æ§åˆ¶å°ï¼Œä¸ä¼šçœ‹åˆ°æœ‰æ¶ˆæ¯æ¶ˆè´¹çš„æ—¥å¿—ã€‚è¯´æ˜ï¼Œç¬¦åˆé›†ç¾¤æ¶ˆè´¹çš„æœºåˆ¶ï¼š **é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹å¹³å‡åˆ†æ‘Šæ¶ˆæ¯ã€‚** ã€‚
  * ğŸ˜ˆ ä¸è¿‡å¦‚ä¸Šçš„æ—¥å¿—ï¼Œä¹Ÿå¯èƒ½å‡ºç°åœ¨ `#testSyncSend()` æ–¹æ³•æ‰€åœ¨çš„æ§åˆ¶å°ï¼Œè€Œä¸åœ¨ `#testASyncSend()` æ–¹æ³•æ‰€åœ¨çš„æ§åˆ¶å°ã€‚

## 3.11 @RocketMQMessageListener

åœ¨ ã€Œ3.8 Demo01Consumerã€ ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨äº† `@RocketMQMessageListener` æ³¨è§£ï¼Œè®¾ç½®æ¯ä¸ª RocketMQ
æ¶ˆè´¹è€… Consumer çš„æ¶ˆæ¯ç›‘å¬å™¨çš„é…ç½®ã€‚

`@RocketMQMessageListener` æ³¨è§£çš„ **å¸¸ç”¨** å±æ€§å¦‚ä¸‹ï¼š

    
    
    /**
     * Consumer æ‰€å±æ¶ˆè´¹è€…åˆ†ç»„
     *
     * Consumers of the same role is required to have exactly same subscriptions and consumerGroup to correctly achieve
     * load balance. It's required and needs to be globally unique.
     *
     * See <a href="http://rocketmq.apache.org/docs/core-concept/">here</a> for further discussion.
     */
    String consumerGroup();
    
    /**
     * æ¶ˆè´¹çš„ Topic
     *
     * Topic name.
     */
    String topic();
    
    /**
     * é€‰æ‹©å™¨ç±»å‹ã€‚é»˜è®¤åŸºäº Message çš„ Tag é€‰æ‹©ã€‚
     *
     * Control how to selector message.
     *
     * @see SelectorType
     */
    SelectorType selectorType() default SelectorType.TAG;
    /**
     * é€‰æ‹©å™¨çš„è¡¨è¾¾å¼ã€‚
     * è®¾ç½®ä¸º * æ—¶ï¼Œè¡¨ç¤ºå…¨éƒ¨ã€‚
     *
     * å¦‚æœä½¿ç”¨ SelectorType.TAG ç±»å‹ï¼Œåˆ™è®¾ç½®æ¶ˆè´¹ Message çš„å…·ä½“ Tag ã€‚
     * å¦‚æœä½¿ç”¨ SelectorType.SQL92 ç±»å‹ï¼Œå¯è§ https://rocketmq.apache.org/rocketmq/filter-messages-by-sql92-in-rocketmq/ æ–‡æ¡£
     *
     * Control which message can be select. Grammar please see {@link SelectorType#TAG} and {@link SelectorType#SQL92}
     */
    String selectorExpression() default "*";
    
    /**
     * æ¶ˆè´¹æ¨¡å¼ã€‚å¯é€‰æ‹©å¹¶å‘æ¶ˆè´¹ï¼Œè¿˜æ˜¯é¡ºåºæ¶ˆè´¹ã€‚
     *
     * Control consume mode, you can choice receive message concurrently or orderly.
     */
    ConsumeMode consumeMode() default ConsumeMode.CONCURRENTLY;
    
    /**
     * æ¶ˆæ¯æ¨¡å‹ã€‚å¯é€‰æ‹©æ˜¯é›†ç¾¤æ¶ˆè´¹ï¼Œè¿˜æ˜¯å¹¿æ’­æ¶ˆè´¹ã€‚
     *
     * Control message mode, if you want all subscribers receive message all message, broadcasting is a good choice.
     */
    MessageModel messageModel() default MessageModel.CLUSTERING;
    
    /**
     * æ¶ˆè´¹çš„çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
     *
     * Max consumer thread number.
     */
    int consumeThreadMax() default 64;
    
    /**
     * æ¶ˆè´¹å•æ¡æ¶ˆæ¯çš„è¶…æ—¶æ—¶é—´
     *
     * Max consumer timeout, default 30s.
     */
    long consumeTimeout() default 30000L;

`@RocketMQMessageListener` æ³¨è§£çš„ **ä¸å¸¸ç”¨** å±æ€§å¦‚ä¸‹ï¼š

    
    
    // é»˜è®¤ä»é…ç½®æ–‡ä»¶è¯»å–çš„å ä½ç¬¦
    String NAME_SERVER_PLACEHOLDER = "${rocketmq.name-server:}";
    String ACCESS_KEY_PLACEHOLDER = "${rocketmq.consumer.access-key:}";
    String SECRET_KEY_PLACEHOLDER = "${rocketmq.consumer.secret-key:}";
    String TRACE_TOPIC_PLACEHOLDER = "${rocketmq.consumer.customized-trace-topic:}";
    String ACCESS_CHANNEL_PLACEHOLDER = "${rocketmq.access-channel:}";
    
    /**
     * The property of "access-key".
     */
     String accessKey() default ACCESS_KEY_PLACEHOLDER;
     /**
     * The property of "secret-key".
     */
    String secretKey() default SECRET_KEY_PLACEHOLDER;
    
    /**
     * Switch flag instance for message trace.
     */
    boolean enableMsgTrace() default true;
    /**
     * The name value of message trace topic.If you don't config,you can use the default trace topic name.
     */
    String customizedTraceTopic() default TRACE_TOPIC_PLACEHOLDER;
    
    /**
     * Consumer è¿æ¥çš„ RocketMQ Namesrv åœ°å€ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ `rocketmq.name-server` é…ç½®é¡¹å³å¯ã€‚
     *
     * å¦‚æœä¸€ä¸ªé¡¹ç›®ä¸­ï¼ŒConsumer éœ€è¦ä½¿ç”¨ä¸åŒçš„ RocketMQ Namesrv ï¼Œåˆ™éœ€è¦é…ç½®è¯¥å±æ€§ã€‚
     *
     * The property of "name-server".
     */
    String nameServer() default NAME_SERVER_PLACEHOLDER;
    
    /**
     * è®¿é—®é€šé“ã€‚ç›®å‰æœ‰ LOCAL å’Œ CLOUD ä¸¤ç§é€šé“ã€‚
     *
     * LOCAL ï¼ŒæŒ‡çš„æ˜¯æœ¬åœ°éƒ¨ç½²çš„ RocketMQ å¼€æºé¡¹ç›®ã€‚
     * CLOUD ï¼ŒæŒ‡çš„æ˜¯é˜¿é‡Œäº‘çš„ ONS æœåŠ¡ã€‚å…·ä½“å¯è§ https://help.aliyun.com/document_detail/128585.html æ–‡æ¡£ã€‚
     *
     * The property of "access-channel".
     */
    String accessChannel() default ACCESS_CHANNEL_PLACEHOLDER;

## 3.12 @ExtRocketMQTemplateConfiguration

RocketMQ-Spring è€ƒè™‘åˆ°å¼€å‘è€…å¯èƒ½éœ€è¦è¿æ¥å¤šä¸ªä¸åŒçš„ RocketMQ é›†ç¾¤ï¼Œæ‰€ä»¥æä¾›äº†
`@ExtRocketMQTemplateConfiguration` æ³¨è§£ï¼Œå®ç°é…ç½®è¿æ¥ä¸åŒ RocketMQ é›†ç¾¤çš„ Producer çš„
RocketMQTemplate Bean å¯¹è±¡ã€‚

`@ExtRocketMQTemplateConfiguration` æ³¨è§£çš„å…·ä½“å±æ€§ï¼Œå’Œæˆ‘ä»¬åœ¨ ã€Œ3.2 åº”ç”¨é…ç½®æ–‡ä»¶ã€ çš„
`rocketmq.producer` é…ç½®é¡¹æ˜¯ä¸€è‡´çš„ï¼Œå°±ä¸é‡å¤èµ˜è¿°å•¦ã€‚

`@ExtRocketMQTemplateConfiguration` æ³¨è§£çš„ç®€å•ä½¿ç”¨ç¤ºä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š

    
    
    @ExtRocketMQTemplateConfiguration(nameServer = "${demo.rocketmq.extNameServer:demo.rocketmq.name-server}")
    public class ExtRocketMQTemplate extends RocketMQTemplate {
    }

  * åœ¨ç±»ä¸Šï¼Œæ·»åŠ  `@ExtRocketMQTemplateConfiguration` æ³¨è§£ï¼Œå¹¶è®¾ç½®è¿æ¥çš„ RocketMQ Namesrv åœ°å€ã€‚
  * åŒæ—¶ï¼Œéœ€è¦ç»§æ‰¿ RocketMQTemplate ç±»ï¼Œä»è€Œä½¿æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ `@Autowire` æˆ– `@Resource` æ³¨è§£ï¼Œæ³¨å…¥ RocketMQTemplate Bean å±æ€§ã€‚

# 4\. æ‰¹é‡å‘é€æ¶ˆæ¯

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼šlab-31-rocketmq-demo ã€‚

åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ Producer æ‰¹é‡å‘é€æ¶ˆæ¯ï¼Œæé«˜å‘é€æ€§èƒ½ã€‚åœ¨ RocketMQTemplate
ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªæ–¹æ³•æ–¹æ³•æ‰¹é‡å‘é€æ¶ˆæ¯çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // RocketMQTemplate.java
    
    public <T extends Message> SendResult syncSend(String destination, Collection<T> messages, long timeout) {
        // ... çœç•¥å…·ä½“ä»£ç å®ç°
    }

  * é€šè¿‡æ–¹æ³•å‚æ•° `destination` å¯çŸ¥ï¼Œå¿…é¡»å‘é€ç›¸åŒ Topic çš„æ¶ˆæ¯ã€‚
  * è¦æ³¨æ„æ–¹æ³•å‚æ•° `messages` ï¼Œæ¯ä¸ªé›†åˆçš„å…ƒç´ å¿…é¡»æ˜¯ Spring Messaging å®šä¹‰çš„ Message æ¶ˆæ¯ã€‚ğŸ˜ˆ RocketMQTemplate é‡è½½äº†éå¸¸å¤šçš„ `#syncSend(...)` æ–¹æ³•ï¼Œä¸€å®šè¦å°å¿ƒå“Ÿã€‚
  * é€šè¿‡æ–¹æ³•åå¯çŸ¥ï¼Œè¿™ä¸ªæ˜¯ **åŒæ­¥** æ‰¹é‡å‘é€æ¶ˆæ¯ã€‚

æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œè™½ç„¶æ˜¯æ‰¹é‡å‘é€å¤šæ¡æ¶ˆæ¯ï¼Œä½†æ˜¯æ˜¯ä»¥æ‰€æœ‰æ¶ˆæ¯åŠ èµ·æ¥çš„å¤§å°ï¼Œä¸èƒ½è¶…è¿‡æ¶ˆæ¯çš„æœ€å¤§å¤§å°çš„é™åˆ¶ï¼Œè€Œä¸æ˜¯æŒ‰ç…§å•æ¡è®¡ç®—ã€‚ğŸ˜ˆ
æ‰€ä»¥ï¼Œä¸€æ¬¡æ€§å‘é€çš„æ¶ˆæ¯ç‰¹åˆ«å¤šï¼Œè¿˜æ˜¯éœ€è¦ **åˆ†æ‰¹çš„** è¿›è¡Œæ‰¹é‡å‘é€ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹æœ¬å°èŠ‚çš„ç¤ºä¾‹ã€‚åç»­çš„å°èŠ‚ï¼Œå¦‚æœéå¿…è¦çš„è¯´æ˜ï¼Œæˆ‘ä»¬éƒ½ç›´æ¥åœ¨ lab-31-rocketmq-demo é¡¹ç›®ä¸­ï¼Œè¿›è¡Œç¤ºä¾‹çš„å¢åŠ ã€‚

## 4.1 Demo02Message

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.message` åŒ…ä¸‹ï¼Œåˆ›å»º Demo02Message
æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo02Message.java
    
    public class Demo02Message {
    
        public static final String TOPIC = "DEMO_02";
    
        /**
         * ç¼–å·
         */
        private Integer id;
    
        // ... çœç•¥ set/get/toString æ–¹æ³•
    
    }

  * `TOPIC` é™æ€å±æ€§ï¼Œæˆ‘ä»¬è®¾ç½®è¯¥æ¶ˆæ¯ç±»å¯¹åº” Topic ä¸º `"DEMO_02"` ã€‚
  * å…¶å®ƒéƒ½å’Œ ã€Œ3.5 Demo01Messageã€ æ˜¯ä¸€æ ·çš„ã€‚é‡æ–°ç”³æ˜çš„åŸå› æ˜¯ï¼Œé¿å…æ±¡æŸ“ ã€Œ3. å¿«é€Ÿå…¥é—¨ã€ ã€‚ğŸ˜ˆ åç»­ï¼Œæ¯ä¸ªå°èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¹Ÿä¼šé€šè¿‡åˆ›å»ºæ–°çš„ Message ç±»ï¼Œä¿è¯å¤šä¸ªç¤ºä¾‹ä¹‹é—´çš„ç‹¬ç«‹ã€‚

## 4.2 Demo02Producer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.producer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo02Producer
ç±»ï¼Œå®ƒä¼šä½¿ç”¨ RocketMQTemplate å®ç°æ‰¹é‡å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo02Producer.java
    
    @Component
    public class Demo02Producer {
    
        @Autowired
        private RocketMQTemplate rocketMQTemplate;
    
        public SendResult sendBatch(Collection<Integer> ids) {
            // <X> åˆ›å»ºå¤šæ¡ Demo02Message æ¶ˆæ¯
            List<Message> messages = new ArrayList<>(ids.size());
            for (Integer id : ids) {
                // åˆ›å»º Demo02Message æ¶ˆæ¯
                Demo02Message message = new Demo02Message().setId(id);
                // æ„å»º Spring Messaging å®šä¹‰çš„ Message æ¶ˆæ¯
                messages.add(MessageBuilder.withPayload(message).build());
            }
            // åŒæ­¥æ‰¹é‡å‘é€æ¶ˆæ¯
            return rocketMQTemplate.syncSend(Demo02Message.TOPIC, messages, 30 * 1000L);
        }
    
    }

  * æ³¨æ„ï¼Œåœ¨ `<X>` å¤„ï¼Œæˆ‘ä»¬å°±åˆ›å»ºäº† **Spring Messaging å®šä¹‰çš„ Message æ¶ˆæ¯** çš„æ•°ç»„ï¼Œç”¨äºä¸‹é¢ä½¿ç”¨ RocketMQTemplate æ‰¹é‡å‘é€æ¶ˆæ¯ã€‚

## 4.3 Demo02Consumer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.consumer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo02Consumer
ç±»ï¼Œå®ç° Rocket-Spring å®šä¹‰çš„ RocketMQListener æ¥å£ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo02Consumer.java
    
    @Component
    @RocketMQMessageListener(
            topic = Demo02Message.TOPIC,
            consumerGroup = "demo02-consumer-group-" + Demo02Message.TOPIC
    )
    public class Demo02Consumer implements RocketMQListener<Demo02Message> {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Override
        public void onMessage(Demo02Message message) {
            logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
        }
    
    }

  * è™½ç„¶è¯´ï¼ŒDemo02Message æ¶ˆæ¯æ˜¯æ‰¹é‡å‘é€çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥å’Œ ã€Œ3.8 Demo1Consumerã€ ä¸€æ ·ï¼Œé€æ¡æ¶ˆè´¹æ¶ˆæ¯ã€‚

## 4.4 ç®€å•æµ‹è¯•

åˆ›å»º Demo02ProducerTest æµ‹è¯•ç±»ï¼Œç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo02Producer æ‰¹é‡å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo02ProducerTest.java
    
    @RunWith(SpringRunner.class)
    @SpringBootTest(classes = Application.class)
    public class Demo02ProducerTest {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Autowired
        private Demo02Producer producer;
    
        @Test
        public void testSendBatch() throws InterruptedException {
            List<Integer> ids = Arrays.asList(1, 2, 3);
            SendResult result = producer.sendBatch(ids);
            logger.info("[testSendBatch][å‘é€ç¼–å·ï¼š[{}] å‘é€ç»“æœï¼š[{}]]", ids, result);
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
    }

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testSendBatch()` æ–¹æ³•ï¼Œæµ‹è¯•æ‰¹é‡å‘é€æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

    
    
    # Producer æ‰¹é‡å‘é€ä¸‰æ¡æ¶ˆæ¯æˆåŠŸ
    
    2019-12-05 15:04:50.173  INFO 82497 --- [           main] c.i.s.l.r.producer.Demo02ProducerTest    : [testSendBatch][å‘é€ç¼–å·ï¼š[[1, 2, 3]] å‘é€ç»“æœï¼š[SendResult [sendStatus=SEND_OK, msgId=C0A8032C424118B4AAC212AF7AF60000,C0A8032C424118B4AAC212AF7AF60001,C0A8032C424118B4AAC212AF7AF60002, offsetMsgId=C0A8032C00002A9F000000000011150C,C0A8032C00002A9F0000000000111608,C0A8032C00002A9F0000000000111704, messageQueue=MessageQueue [topic=DEMO_02, brokerName=broker-a, queueId=0], queueOffset=1]]]
    
    # ä¸‰æ¡æ¶ˆæ¯ï¼Œè¢«é€æ¡æ¶ˆè´¹
    2019-12-05 15:04:52.979  INFO 82497 --- [MessageThread_6] c.i.s.l.r.consumer.Demo02Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:61 æ¶ˆæ¯å†…å®¹ï¼šDemo01Message{id=3}]
    2019-12-05 15:04:52.979  INFO 82497 --- [MessageThread_1] c.i.s.l.r.consumer.Demo02Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:56 æ¶ˆæ¯å†…å®¹ï¼šDemo01Message{id=1}]
    2019-12-05 15:04:52.979  INFO 82497 --- [MessageThread_3] c.i.s.l.r.consumer.Demo02Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:59 æ¶ˆæ¯å†…å®¹ï¼šDemo01Message{id=2}]

  * ğŸ˜ˆ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸‰æ¡æ¶ˆæ¯ï¼Œè¢« Demo02Consumer **å¹¶å‘** æ¶ˆè´¹å®Œæˆã€‚

# 5\. å®šæ—¶æ¶ˆæ¯

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼šlab-31-rocketmq-demo ã€‚

åœ¨ RocketMQ ä¸­ï¼Œæä¾›å®šæ—¶æ¶ˆæ¯çš„åŠŸèƒ½ã€‚

> **å®šæ—¶æ¶ˆæ¯** ï¼Œæ˜¯æŒ‡æ¶ˆæ¯å‘åˆ° Broker åï¼Œä¸èƒ½ç«‹åˆ»è¢« Consumer æ¶ˆè´¹ï¼Œè¦åˆ°ç‰¹å®šçš„æ—¶é—´ç‚¹æˆ–è€…ç­‰å¾…ç‰¹å®šçš„æ—¶é—´åæ‰èƒ½è¢«æ¶ˆè´¹ã€‚

ä¸è¿‡ï¼ŒRocketMQ æš‚æ—¶ä¸æ”¯æŒä»»æ„çš„æ—¶é—´ç²¾åº¦çš„å»¶è¿Ÿï¼Œè€Œæ˜¯å›ºåŒ–äº† 18 ä¸ªå»¶è¿Ÿçº§åˆ«ã€‚å¦‚ä¸‹è¡¨æ ¼ï¼š

å»¶è¿Ÿçº§åˆ«| æ—¶é—´| å»¶è¿Ÿçº§åˆ«| æ—¶é—´| å»¶è¿Ÿçº§åˆ«| æ—¶é—´  
---|---|---|---|---|---  
1| 1s| 7| 3m| 13| 9m  
2| 5s| 8| 4m| 14| 10m  
3| 10s| 9| 5m| 15| 20m  
4| 30s| 10| 6m| 16| 30m  
5| 1m| 11| 7m| 17| 1h  
6| 2m| 12| 8m| 18| 2h  
  
å¦‚æœèƒ–å‹æƒ³è¦ä»»ä¸€æ—¶åˆ»çš„å®šæ—¶æ¶ˆæ¯ï¼Œå¯ä»¥è€ƒè™‘å€ŸåŠ© MySQL + Job æ¥å®ç°ã€‚åˆæˆ–è€…è€ƒè™‘ä½¿ç”¨ DDMQ(æ»´æ»´æ‰“è½¦åŸºäº RocketMQ å’Œ Kafka
æ”¹é€ çš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ—) ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹æœ¬å°èŠ‚çš„ç¤ºä¾‹ã€‚

## 5.1 Demo03Message

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.message` åŒ…ä¸‹ï¼Œåˆ›å»º Demo03Message
æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    public class Demo03Message {
    
        public static final String TOPIC = "DEMO_03";
    
        /**
         * ç¼–å·
         */
        private Integer id;
    
        // ... çœç•¥ set/get/toString æ–¹æ³•
    
    }

  * `TOPIC` é™æ€å±æ€§ï¼Œæˆ‘ä»¬è®¾ç½®è¯¥æ¶ˆæ¯ç±»å¯¹åº” Topic ä¸º `"DEMO_03"` ã€‚

## 5.2 Demo03Producer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.producer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo03Producer
ç±»ï¼Œå®ƒä¼šä½¿ç”¨ RocketMQTemplate å®ç°å‘é€å®šæ—¶æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo03Producer.java
    
    @Component
    public class Demo03Producer {
    
        @Autowired
        private RocketMQTemplate rocketMQTemplate;
    
        public SendResult syncSendDelay(Integer id, int delayLevel) {
            // åˆ›å»º Demo03Message æ¶ˆæ¯
            Message message = MessageBuilder.withPayload(new Demo03Message().setId(id))
                    .build();
            // åŒæ­¥å‘é€æ¶ˆæ¯
            return rocketMQTemplate.syncSend(Demo03Message.TOPIC, message, 30 * 1000,
                    delayLevel);
        }
    
        public void asyncSendDelay(Integer id, int delayLevel, SendCallback callback) {
            // åˆ›å»º Demo03Message æ¶ˆæ¯
            Message message = MessageBuilder.withPayload(new Demo03Message().setId(id))
                    .build();
            // åŒæ­¥å‘é€æ¶ˆæ¯
            rocketMQTemplate.asyncSend(Demo03Message.TOPIC, message, callback, 30 * 1000,
                    delayLevel);
        }
    
    }

  * å®šæ—¶æ¶ˆæ¯ï¼Œç›®å‰åªæ”¯æŒ **åŒæ­¥** å’Œ **å¼‚æ­¥** å‘é€å®šæ—¶æ¶ˆæ¯ã€‚

## 5.3 Demo03Consumer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.consumer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo03Consumer
ç±»ï¼Œå®ç° Rocket-Spring å®šä¹‰çš„ RocketMQListener æ¥å£ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo03Consumer.java
    
    @Component
    @RocketMQMessageListener(
            topic = Demo03Message.TOPIC,
            consumerGroup = "demo03-consumer-group-" + Demo03Message.TOPIC
    )
    public class Demo03Consumer implements RocketMQListener<Demo03Message> {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Override
        public void onMessage(Demo03Message message) {
            logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
        }
    
    }

  * å’Œ ã€Œ3.8 Demo1Consumerã€ æ˜¯ä¸€æ ·ï¼Œè¿˜æ˜¯é€æ¡æ¶ˆè´¹æ¶ˆæ¯ã€‚

## 5.4 ç®€å•æµ‹è¯•

åˆ›å»º Demo03ProducerTest æµ‹è¯•ç±»ï¼Œç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo03Producer å‘é€å®šæ—¶æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo03ProducerTest.java
    
    @RunWith(SpringRunner.class)
    @SpringBootTest(classes = Application.class)
    public class Demo03ProducerTest {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Autowired
        private Demo03Producer producer;
    
        @Test
        public void testSyncSendDelay() throws InterruptedException {
            int id = (int) (System.currentTimeMillis() / 1000);
            SendResult result = producer.syncSendDelay(id, 3); // å»¶è¿Ÿçº§åˆ« 3 ï¼Œå³ 10 ç§’åæ¶ˆè´¹
            logger.info("[testSyncSendDelay][å‘é€ç¼–å·ï¼š[{}] å‘é€ç»“æœï¼š[{}]]", id, result);
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
    }

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testSyncSendDelay()` æ–¹æ³•ï¼Œæµ‹è¯•å‘é€å®šæ—¶æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

    
    
    # Producer å‘é€å®šæ—¶æ¶ˆæ¯æˆåŠŸ
    2019-12-05 15:53:27.222  INFO 85492 --- [           main] c.i.s.l.r.producer.Demo03ProducerTest    : [testSyncSendDelay][å‘é€ç¼–å·ï¼š[1575446007] å‘é€ç»“æœï¼š[SendResult [sendStatus=SEND_OK, msgId=C0A8032C4DF418B4AAC212DBFDB00006, offsetMsgId=C0A8032C00002A9F00000000001155C2, messageQueue=MessageQueue [topic=DEMO_03, brokerName=broker-a, queueId=0], queueOffset=5]]]
    
    # å› ä¸ºè¯¥æ¶ˆæ¯çš„å»¶è¿Ÿçº§åˆ«æ˜¯ 3 ï¼Œæ‰€ä»¥ 10 ç§’åè¢« Demo03Consumer æ¶ˆè´¹åˆ°
    2019-12-05 15:53:37.226  INFO 85492 --- [MessageThread_1] c.i.s.l.r.consumer.Demo03Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:60 æ¶ˆæ¯å†…å®¹ï¼šDemo03Message{id=1575446007}]

  * å‘é€çš„æ¶ˆæ¯ï¼Œå»¶è¿Ÿ 10 ç§’è¢« Demo03Consumer æ¶ˆè´¹ã€‚

# 6\. æ¶ˆè´¹é‡è¯•

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼šlab-31-rocketmq-demo ã€‚

RocketMQ æä¾› **æ¶ˆè´¹é‡è¯•** çš„æœºåˆ¶ã€‚åœ¨æ¶ˆæ¯ **æ¶ˆè´¹å¤±è´¥** çš„æ—¶å€™ï¼ŒRocketMQ ä¼šé€šè¿‡ **æ¶ˆè´¹é‡è¯•** æœºåˆ¶ï¼Œé‡æ–°æŠ•é€’è¯¥æ¶ˆæ¯ç»™
Consumer ï¼Œè®© Consumer æœ‰æœºä¼šé‡æ–°æ¶ˆè´¹æ¶ˆæ¯ï¼Œå®ç°æ¶ˆè´¹æˆåŠŸã€‚

å½“ç„¶ï¼ŒRocketMQ å¹¶ä¸ä¼šæ— é™é‡æ–°æŠ•é€’æ¶ˆæ¯ç»™ Consumer é‡æ–°æ¶ˆè´¹ï¼Œè€Œæ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¾¾åˆ° 16 æ¬¡é‡è¯•æ¬¡æ•°æ—¶ï¼ŒConsumer
è¿˜æ˜¯æ¶ˆè´¹å¤±è´¥æ—¶ï¼Œè¯¥æ¶ˆæ¯å°±ä¼šè¿›å…¥åˆ° **æ­»ä¿¡é˜Ÿåˆ—** ã€‚

>
> æ­»ä¿¡é˜Ÿåˆ—ç”¨äºå¤„ç†æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚å½“ä¸€æ¡æ¶ˆæ¯åˆæ¬¡æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šè‡ªåŠ¨è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼›è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œè‹¥æ¶ˆè´¹ä¾ç„¶å¤±è´¥ï¼Œåˆ™è¡¨æ˜æ¶ˆè´¹è€…åœ¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ­£ç¡®åœ°æ¶ˆè´¹è¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸ä¼šç«‹åˆ»å°†æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œæ˜¯å°†å…¶å‘é€åˆ°è¯¥æ¶ˆè´¹è€…å¯¹åº”çš„ç‰¹æ®Šé˜Ÿåˆ—ä¸­ã€‚
>
> RocketMQ å°†è¿™ç§æ­£å¸¸æƒ…å†µä¸‹æ— æ³•è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ç§°ä¸ºæ­»ä¿¡æ¶ˆæ¯ï¼ˆDead-Letter
> Messageï¼‰ï¼Œå°†å­˜å‚¨æ­»ä¿¡æ¶ˆæ¯çš„ç‰¹æ®Šé˜Ÿåˆ—ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead-Letter Queueï¼‰ã€‚åœ¨ RocketMQ ä¸­ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ console
> æ§åˆ¶å°å¯¹æ­»ä¿¡é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿›è¡Œé‡å‘æ¥ä½¿å¾—æ¶ˆè´¹è€…å®ä¾‹å†æ¬¡è¿›è¡Œæ¶ˆè´¹ã€‚

æ¯æ¡æ¶ˆæ¯çš„å¤±è´¥é‡è¯•ï¼Œæ˜¯æœ‰ä¸€å®šçš„é—´éš”æ—¶é—´ã€‚å®é™…ä¸Šï¼Œæ¶ˆè´¹é‡è¯•æ˜¯åŸºäºã€Œ5. å®šæ—¶æ¶ˆæ¯ã€ æ¥å®ç°ï¼Œç¬¬ä¸€æ¬¡é‡è¯•æ¶ˆè´¹æŒ‰ç…§å»¶è¿Ÿçº§åˆ«ä¸º **3** å¼€å§‹ã€‚ğŸ˜ˆ æ‰€ä»¥ï¼Œé»˜è®¤ä¸º
16 æ¬¡é‡è¯•æ¶ˆè´¹ï¼Œä¹Ÿéå¸¸å¥½ç†è§£ï¼Œæ¯•ç«Ÿå»¶è¿Ÿçº§åˆ«æœ€é«˜ä¸º 18 å‘€ã€‚

ä¸è¿‡è¦æ³¨æ„ï¼Œåªæœ‰ **é›†ç¾¤æ¶ˆè´¹** æ¨¡å¼ä¸‹ï¼Œæ‰æœ‰æ¶ˆæ¯é‡è¯•ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹æœ¬å°èŠ‚çš„ç¤ºä¾‹ã€‚

## 6.1 Demo04Message

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.message` åŒ…ä¸‹ï¼Œåˆ›å»º Demo04Message
æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    public class Demo04Message {
    
        public static final String TOPIC = "DEMO_04";
    
        /**
         * ç¼–å·
         */
        private Integer id;
    
        // ... çœç•¥ set/get/toString æ–¹æ³•
    
    }

  * `TOPIC` é™æ€å±æ€§ï¼Œæˆ‘ä»¬è®¾ç½®è¯¥æ¶ˆæ¯ç±»å¯¹åº” Topic ä¸º `"DEMO_04"` ã€‚

## 6.2 Demo04Producer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.producer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo04Producer
ç±»ï¼Œå®ƒä¼šä½¿ç”¨ RocketMQ-Spring å°è£…æä¾›çš„ RocketMQTemplate ï¼Œå®ç°åŒæ­¥å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo04Producer.java
    
    @Component
    public class Demo04Producer {
    
        @Autowired
        private RocketMQTemplate rocketMQTemplate;
    
        public SendResult syncSend(Integer id) {
            // åˆ›å»º Demo04Message æ¶ˆæ¯
            Demo04Message message = new Demo04Message();
            message.setId(id);
            // åŒæ­¥å‘é€æ¶ˆæ¯
            return rocketMQTemplate.syncSend(Demo04Message.TOPIC, message);
        }
    
    }

  * ä»£ç ä¸Šï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œå’Œ ã€Œ3.6 Demo01Producerã€ çš„åŒæ­¥å‘é€æ¶ˆæ¯çš„ä»£ç æ˜¯ä¸€è‡´çš„ï¼Œé™¤äº†æ¶ˆæ¯æ¢æˆäº† Demo04Message ã€‚

## 6.3 Demo04Consumer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.consumer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo04Consumer
ç±»ï¼Œå®ç° Rocket-Spring å®šä¹‰çš„ RocketMQListener æ¥å£ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo04Consumer.java
    
    @Component
    @RocketMQMessageListener(
            topic = Demo04Message.TOPIC,
            consumerGroup = "demo04-consumer-group-" + Demo04Message.TOPIC
    )
    public class Demo04Consumer implements RocketMQListener<Demo04Message> {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Override
        public void onMessage(Demo04Message message) {
            logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
            // <X> æ³¨æ„ï¼Œæ­¤å¤„æŠ›å‡ºä¸€ä¸ª RuntimeException å¼‚å¸¸ï¼Œæ¨¡æ‹Ÿæ¶ˆè´¹å¤±è´¥
            throw new RuntimeException("æˆ‘å°±æ˜¯æ•…æ„æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸");
        }
    
    }

  * åœ¨ `<X>` å¤„ï¼Œæˆ‘ä»¬åœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶å€™ï¼ŒæŠ›å‡ºä¸€ä¸ª RuntimeException å¼‚å¸¸ï¼Œæ¨¡æ‹Ÿæ¶ˆè´¹å¤±è´¥ã€‚

## 6.4 ç®€å•æµ‹è¯•

åˆ›å»º Demo04ProducerTest æµ‹è¯•ç±»ï¼Œç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo04Producer åŒæ­¥å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo04ProducerTest.java
    
    @RunWith(SpringRunner.class)
    @SpringBootTest(classes = Application.class)
    public class Demo04ProducerTest {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Autowired
        private Demo04Producer producer;
    
        @Test
        public void testSyncSend() throws InterruptedException {
            int id = (int) (System.currentTimeMillis() / 1000);
            SendResult result = producer.syncSend(id);
            logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€ç»“æœï¼š[{}]]", id, result);
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
    }

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testSyncSend()` æ–¹æ³•ï¼ŒåŒæ­¥å‘é€æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

    
    
    # Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸ
    2019-12-05 16:42:00.603  INFO 87651 --- [           main] c.i.s.l.r.producer.Demo04ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575448920] å‘é€ç»“æœï¼š[SendResult [sendStatus=SEND_OK, msgId=C0A8032C566318B4AAC2130872110000, offsetMsgId=C0A8032C00002A9F0000000000122185, messageQueue=MessageQueue [topic=DEMO_04, brokerName=broker-a, queueId=1], queueOffset=0]]]
    
    # Demo04Consumer ç¬¬ä¸€æ¬¡æ¶ˆè´¹å¤±è´¥ï¼ŒæŠ›å‡º RuntimeException å¼‚å¸¸
    2019-12-05 16:42:23.497  INFO 87651 --- [MessageThread_1] c.i.s.l.r.consumer.Demo04Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:57 æ¶ˆæ¯å†…å®¹ï¼šDemo04Message{id=1575448920}]
    2019-12-05 16:42:23.501  WARN 87651 --- [MessageThread_1] a.r.s.s.DefaultRocketMQListenerContainer : consume message failed. messageExt:MessageExt [queueId=1, storeSize=284, queueOffset=0, sysFlag=0, bornTimestamp=1575448920596, bornHost=/192.168.3.44:62472, storeTimestamp=1575448920601, storeHost=/192.168.3.44:10911, msgId=C0A8032C00002A9F0000000000122185, commitLogOffset=1188229, bodyCRC=1839505431, reconsumeTimes=0, preparedTransactionOffset=0, toString()=Message{topic='DEMO_04', flag=0, properties={MIN_OFFSET=0, MAX_OFFSET=1, CONSUME_START_TIME=1575448943433, id=d9d1ced2-bc75-3378-4c31-1c0a3691f1bc, UNIQ_KEY=C0A8032C566318B4AAC2130872110000, CLUSTER=DefaultCluster, WAIT=false, contentType=application/json, timestamp=1575448920588}, body=[123, 34, 105, 100, 34, 58, 49, 53, 55, 53, 52, 52, 56, 57, 50, 48, 125], transactionId='null'}]
    
    java.lang.RuntimeException: æˆ‘å°±æ˜¯æ•…æ„æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸
    // æ­¤å¤„ï¼Œçœç•¥å †æ ˆ...
    
    # Demo04Consumer ç¬¬ä¸€æ¬¡é‡è¯•æ¶ˆè´¹å¤±è´¥ï¼ŒæŠ›å‡º RuntimeException å¼‚å¸¸ã€‚é—´éš”äº† 10 ç§’ï¼Œå¯¹åº”å»¶è¿Ÿçº§åˆ« 3 ã€‚
    2019-12-05 16:42:33.509  INFO 87651 --- [MessageThread_2] c.i.s.l.r.consumer.Demo04Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:58 æ¶ˆæ¯å†…å®¹ï¼šDemo04Message{id=1575448920}]
    2019-12-05 16:42:33.510  WARN 87651 --- [MessageThread_2] a.r.s.s.DefaultRocketMQListenerContainer : consume message failed. messageExt:MessageExt [queueId=0, storeSize=451, queueOffset=0, sysFlag=0, bornTimestamp=1575448920596, bornHost=/192.168.3.44:62472, storeTimestamp=1575448953506, storeHost=/192.168.3.44:10911, msgId=C0A8032C00002A9F000000000012272C, commitLogOffset=1189676, bodyCRC=1839505431, reconsumeTimes=1, preparedTransactionOffset=0, toString()=Message{topic='DEMO_04', flag=0, properties={CONSUME_START_TIME=1575448953509, MIN_OFFSET=0, REAL_TOPIC=%RETRY%demo04-consumer-group-DEMO_04, ORIGIN_MESSAGE_ID=C0A8032C00002A9F0000000000122185, RETRY_TOPIC=DEMO_04, MAX_OFFSET=1, id=d9d1ced2-bc75-3378-4c31-1c0a3691f1bc, UNIQ_KEY=C0A8032C566318B4AAC2130872110000, CLUSTER=DefaultCluster, WAIT=false, contentType=application/json, DELAY=3, timestamp=1575448920588, REAL_QID=0}, body=[123, 34, 105, 100, 34, 58, 49, 53, 55, 53, 52, 52, 56, 57, 50, 48, 125], transactionId='null'}]
    
    java.lang.RuntimeException: æˆ‘å°±æ˜¯æ•…æ„æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸
    // æ­¤å¤„ï¼Œçœç•¥å †æ ˆ...
    
    # Demo04Consumer ç¬¬äºŒæ¬¡é‡è¯•æ¶ˆè´¹å¤±è´¥ï¼ŒæŠ›å‡º RuntimeException å¼‚å¸¸ã€‚é—´éš”äº† 30 ç§’ï¼Œå¯¹åº”å»¶è¿Ÿçº§åˆ« 4 ã€‚
    2019-12-05 16:43:03.519  INFO 87651 --- [MessageThread_3] c.i.s.l.r.consumer.Demo04Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:59 æ¶ˆæ¯å†…å®¹ï¼šDemo04Message{id=1575448920}]
    2019-12-05 16:43:03.519  WARN 87651 --- [MessageThread_3] a.r.s.s.DefaultRocketMQListenerContainer : consume message failed. messageExt:MessageExt [queueId=0, storeSize=451, queueOffset=1, sysFlag=0, bornTimestamp=1575448920596, bornHost=/192.168.3.44:62472, storeTimestamp=1575448983514, storeHost=/192.168.3.44:10911, msgId=C0A8032C00002A9F0000000000122AA1, commitLogOffset=1190561, bodyCRC=1839505431, reconsumeTimes=2, preparedTransactionOffset=0, toString()=Message{topic='DEMO_04', flag=0, properties={CONSUME_START_TIME=1575448983519, MIN_OFFSET=0, REAL_TOPIC=%RETRY%demo04-consumer-group-DEMO_04, ORIGIN_MESSAGE_ID=C0A8032C00002A9F0000000000122185, RETRY_TOPIC=DEMO_04, MAX_OFFSET=2, id=d9d1ced2-bc75-3378-4c31-1c0a3691f1bc, UNIQ_KEY=C0A8032C566318B4AAC2130872110000, CLUSTER=DefaultCluster, WAIT=false, contentType=application/json, DELAY=4, timestamp=1575448920588, REAL_QID=0}, body=[123, 34, 105, 100, 34, 58, 49, 53, 55, 53, 52, 52, 56, 57, 50, 48, 125], transactionId='null'}]
    
    java.lang.RuntimeException: æˆ‘å°±æ˜¯æ•…æ„æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸
    // æ­¤å¤„ï¼Œçœç•¥å †æ ˆ...

  * ä»æ—¥å¿—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¶ˆæ¯å› ä¸ºæ¶ˆè´¹å¤±è´¥åï¼Œåˆé‡è¯•æ¶ˆè´¹äº†å¤šæ¬¡ã€‚

# 7\. å¹¿æ’­æ¶ˆè´¹

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼šlab-31-rocketmq-demo ã€‚

åœ¨ä¸Šè¿°çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„éƒ½æ˜¯ä½¿ç”¨é›†ç¾¤æ¶ˆè´¹ã€‚è€Œåœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ **å¹¿æ’­æ¶ˆè´¹** ã€‚

> å¹¿æ’­æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹éƒ½æ¥æ”¶å…¨é‡çš„æ¶ˆæ¯ã€‚

ä¾‹å¦‚è¯´ï¼Œåœ¨åº”ç”¨ä¸­ï¼Œç¼“å­˜äº†æ•°æ®å­—å…¸ç­‰é…ç½®è¡¨åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥é€šè¿‡ RocketMQ å¹¿æ’­æ¶ˆè´¹ï¼Œå®ç°æ¯ä¸ªåº”ç”¨èŠ‚ç‚¹éƒ½æ¶ˆè´¹æ¶ˆæ¯ï¼Œåˆ·æ–°æœ¬åœ°å†…å­˜çš„ç¼“å­˜ã€‚

åˆä¾‹å¦‚è¯´ï¼Œæˆ‘ä»¬åŸºäº WebSocket å®ç°äº† IM èŠå¤©ï¼Œåœ¨æˆ‘ä»¬ç»™ç”¨æˆ·ä¸»åŠ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“ç”¨æˆ·è¿æ¥çš„æ˜¯å“ªä¸ªæä¾› WebSocket
çš„åº”ç”¨ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ RocketMQ å¹¿æ’­æ¶ˆè´¹ï¼Œæ¯ä¸ªåº”ç”¨åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯å’Œè‡ªå·±æä¾›çš„ WebSocket æœåŠ¡è¿æ¥ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ¨é€æ¶ˆæ¯ç»™ç”¨æˆ·ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹æœ¬å°èŠ‚çš„ç¤ºä¾‹ã€‚

## 7.1 Demo05Message

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.message` åŒ…ä¸‹ï¼Œåˆ›å»º Demo05Message
æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    public class Demo05Message {
    
        public static final String TOPIC = "DEMO_05";
    
        /**
         * ç¼–å·
         */
        private Integer id;
    
        // ... çœç•¥ set/get/toString æ–¹æ³•
    
    }

  * `TOPIC` é™æ€å±æ€§ï¼Œæˆ‘ä»¬è®¾ç½®è¯¥æ¶ˆæ¯ç±»å¯¹åº” Topic ä¸º `"DEMO_05"` ã€‚

## 7.2 Demo05Producer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.producer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo04Producer
ç±»ï¼Œå®ƒä¼šä½¿ç”¨ RocketMQ-Spring å°è£…æä¾›çš„ RocketMQTemplate ï¼Œå®ç°åŒæ­¥å‘é€æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo05Producer.java
    
    @Component
    public class Demo05Producer {
    
        @Autowired
        private RocketMQTemplate rocketMQTemplate;
    
        public SendResult syncSend(Integer id) {
            // åˆ›å»º Demo05Message æ¶ˆæ¯
            Demo05Message message = new Demo05Message();
            message.setId(id);
            // åŒæ­¥å‘é€æ¶ˆæ¯
            return rocketMQTemplate.syncSend(Demo05Message.TOPIC, message);
        }
    
    }

  * ä»£ç ä¸Šï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œå’Œ ã€Œ3.6 Demo01Producerã€ çš„åŒæ­¥å‘é€æ¶ˆæ¯çš„ä»£ç æ˜¯ä¸€è‡´çš„ï¼Œé™¤äº†æ¶ˆæ¯æ¢æˆäº† Demo05Message ã€‚

## 7.3 Demo05Consumer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.consumer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo05Consumer
ç±»ï¼Œå®ç° Rocket-Spring å®šä¹‰çš„ RocketMQListener æ¥å£ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo05Consumer.java
    
    @Component
    @RocketMQMessageListener(
            topic = Demo05Message.TOPIC,
            consumerGroup = "demo05-consumer-group-" + Demo05Message.TOPIC,
            messageModel = MessageModel.BROADCASTING // è®¾ç½®ä¸ºå¹¿æ’­æ¶ˆè´¹
    )
    public class Demo05Consumer implements RocketMQListener<Demo05Message> {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Override
        public void onMessage(Demo05Message message) {
            logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
        }
    
    }

  * å·®å¼‚ç‚¹ï¼Œä¸»è¦æ˜¯ `@RocketMQMessageListener` æ³¨è§£ï¼Œé€šè¿‡è®¾ç½®äº† `messageModel = MessageModel.BROADCASTING` ï¼Œè¡¨ç¤ºä½¿ç”¨ **å¹¿æ’­æ¶ˆè´¹** ã€‚

## 7.4 ç®€å•æµ‹è¯•

åˆ›å»º Demo05ProducerTest æµ‹è¯•ç±»ï¼Œç”¨äºæµ‹è¯•å¹¿æ’­æ¶ˆè´¹ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo05ProducerTest.java
    
    @RunWith(SpringRunner.class)
    @SpringBootTest(classes = Application.class)
    public class Demo05ProducerTest {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Autowired
        private Demo05Producer producer;
    
        @Test
        public void test() throws InterruptedException {
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
        @Test
        public void testSyncSend() throws InterruptedException {
            int id = (int) (System.currentTimeMillis() / 1000);
            SendResult result = producer.syncSend(id);
            logger.info("[testSyncSend][å‘é€ç¼–å·ï¼š[{}] å‘é€ç»“æœï¼š[{}]]", id, result);
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
    }

  * é¦–å…ˆï¼Œæ‰§è¡Œ `#test()` æµ‹è¯•æ–¹æ³•ï¼Œå…ˆå¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹è€…åˆ†ç»„ `"demo05-consumer-group-DEMO_05"` çš„ Consumer èŠ‚ç‚¹ã€‚
  * ç„¶åï¼Œæ‰§è¡Œ `#testSyncSend()` æµ‹è¯•æ–¹æ³•ï¼Œå…ˆå¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹è€…åˆ†ç»„ `"demo05-consumer-group-DEMO_05"` çš„ Consumer èŠ‚ç‚¹ã€‚åŒæ—¶ï¼Œè¯¥æµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ `Demo05ProducerTest#syncSend(id)` æ–¹æ³•ï¼ŒåŒæ­¥å‘é€äº†ä¸€æ¡æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

    
    
    // #### testSyncSend æ–¹æ³•å¯¹åº”çš„æ§åˆ¶å° ####
    
    # Producer åŒæ­¥å‘é€æ¶ˆæ¯æˆåŠŸ
    2019-12-05 17:26:00.439  INFO 89499 --- [           main] c.i.s.l.r.producer.Demo05ProducerTest    : [testSyncSend][å‘é€ç¼–å·ï¼š[1575451560] å‘é€ç»“æœï¼š[SendResult [sendStatus=SEND_OK, msgId=C0A8032C5D9B18B4AAC21330B9F00000, offsetMsgId=C0A8032C00002A9F0000000000124421, messageQueue=MessageQueue [topic=DEMO_05, brokerName=broker-a, queueId=0], queueOffset=1]]]
    
    # Demo05Consumer æ¶ˆè´¹äº†è¯¥æ¶ˆæ¯
    2019-12-05 17:26:03.271  INFO 89499 --- [MessageThread_1] c.i.s.l.r.consumer.Demo05Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:63 æ¶ˆæ¯å†…å®¹ï¼šDemo05Message{id=1575451560}]
    
    // ### test æ–¹æ³•å¯¹åº”çš„æ§åˆ¶å° ####
    
    # Demo05Consumer ä¹Ÿæ¶ˆè´¹äº†è¯¥æ¶ˆæ¯
    2019-12-05 17:26:00.440  INFO 89490 --- [MessageThread_1] c.i.s.l.r.consumer.Demo05Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:70 æ¶ˆæ¯å†…å®¹ï¼šDemo05Message{id=1575451560}]

  * æ¶ˆè´¹è€…åˆ†ç»„ `"demo05-consumer-group-DEMO_05"` çš„ **ä¸¤ä¸ª** Consumer èŠ‚ç‚¹ï¼Œéƒ½æ¶ˆè´¹äº†è¿™æ¡å‘é€çš„æ¶ˆæ¯ã€‚ç¬¦åˆå¹¿æ’­æ¶ˆè´¹çš„é¢„æœŸ~

# 8\. é¡ºåºæ¶ˆæ¯

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼šlab-31-rocketmq-demo ã€‚

RocketMQ æä¾›äº†ä¸¤ç§é¡ºåºçº§åˆ«ï¼š

  * æ™®é€šé¡ºåºæ¶ˆæ¯ ï¼šProducer å°†ç›¸å…³è”çš„æ¶ˆæ¯å‘é€åˆ°ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚
  * å®Œå…¨ä¸¥æ ¼é¡ºåº ï¼šåœ¨ã€æ™®é€šé¡ºåºæ¶ˆæ¯ã€‘çš„åŸºç¡€ä¸Šï¼ŒConsumer ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚

> ç›®å‰å·²çŸ¥çš„åº”ç”¨åªæœ‰æ•°æ®åº“ binlog åŒæ­¥å¼ºä¾èµ–ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼Œå…¶ä»–åº”ç”¨ç»å¤§éƒ¨åˆ†éƒ½å¯ä»¥å®¹å¿çŸ­æš‚ä¹±åºï¼Œæ¨èä½¿ç”¨æ™®é€šçš„é¡ºåºæ¶ˆæ¯ã€‚
>
> å¦‚ä¸‹æ˜¯ RocketMQ å®˜æ–¹æ–‡æ¡£å¯¹è¿™ä¸¤ç§é¡ºåºçº§åˆ«çš„å®šä¹‰ï¼š
>
>   * æ™®é€šé¡ºåºæ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€…é€šè¿‡åŒä¸€ä¸ªæ¶ˆè´¹é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„ï¼Œä¸åŒæ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯åˆ™å¯èƒ½æ˜¯æ— é¡ºåºçš„ã€‚
>   * ä¸¥æ ¼é¡ºåºæ¶ˆæ¯æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€…æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯å‡æ˜¯æœ‰é¡ºåºçš„ã€‚
>

ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹æœ¬å°èŠ‚çš„ç¤ºä¾‹ã€‚

## 8.1 Demo06Message

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.message` åŒ…ä¸‹ï¼Œåˆ›å»º Demo06Message
æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    public class Demo06Message {
    
        public static final String TOPIC = "DEMO_06";
    
        /**
         * ç¼–å·
         */
        private Integer id;
    
        // ... çœç•¥ set/get/toString æ–¹æ³•
    
    }

  * `TOPIC` é™æ€å±æ€§ï¼Œæˆ‘ä»¬è®¾ç½®è¯¥æ¶ˆæ¯ç±»å¯¹åº” Topic ä¸º `"DEMO_06"` ã€‚

## 8.2 Demo06Producer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.producer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo06Producer
ç±»ï¼Œå®ƒä¼šä½¿ç”¨ RocketMQ-Spring å°è£…æä¾›çš„ RocketMQTemplate ï¼Œå®ç°ä¸‰ç§å‘é€ **é¡ºåº** æ¶ˆæ¯çš„æ–¹å¼ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo06Producer.java
    
    @Component
    public class Demo06Producer {
    
        @Autowired
        private RocketMQTemplate rocketMQTemplate;
    
        public SendResult syncSendOrderly(Integer id) {
            // åˆ›å»º Demo06Message æ¶ˆæ¯
            Demo06Message message = new Demo06Message();
            message.setId(id);
            // åŒæ­¥å‘é€æ¶ˆæ¯
            return rocketMQTemplate.syncSendOrderly(Demo06Message.TOPIC, message, String.valueOf(id));
        }
    
        public void asyncSendOrderly(Integer id, SendCallback callback) {
            // åˆ›å»º Demo06Message æ¶ˆæ¯
            Demo06Message message = new Demo06Message();
            message.setId(id);
            // å¼‚æ­¥å‘é€æ¶ˆæ¯
            rocketMQTemplate.asyncSendOrderly(Demo06Message.TOPIC, message, String.valueOf(id), callback);
        }
    
        public void onewaySendOrderly(Integer id) {
            // åˆ›å»º Demo06Message æ¶ˆæ¯
            Demo06Message message = new Demo06Message();
            message.setId(id);
            // å¼‚æ­¥å‘é€æ¶ˆæ¯
            rocketMQTemplate.sendOneWayOrderly(Demo06Message.TOPIC, message, String.valueOf(id));
        }
    
    }

  * ç›¸æ¯” ã€Œ3.6 Demo01Producerã€ æ¥è¯´ï¼Œè°ƒç”¨äº†å¯¹åº”çš„ **Orderly** æ–¹æ³•ï¼Œä»è€Œå®ç°å‘é€é¡ºåºæ¶ˆæ¯ã€‚
  * åŒæ—¶ï¼Œéœ€è¦ä¼ å…¥æ–¹æ³•å‚æ•° `hashKey` ï¼Œä½œä¸ºé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—çš„é”®ã€‚

    
    
    @param hashKey      use this key to select queue. for example: orderId, productId ...
    

> ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨è®¢å•å·ã€å•†å“å·ã€ç”¨æˆ·ç¼–å·ã€‚

RocketMQTemplate åœ¨å‘é€é¡ºåºæ¶ˆæ¯æ—¶ï¼Œé»˜è®¤é‡‡ç”¨ SelectMessageQueueByHash ç­–ç•¥ã€‚å¦‚æ­¤ï¼Œç›¸åŒçš„ `hashKey`
çš„æ¶ˆæ¯ï¼Œå°±å¯ä»¥å‘é€åˆ°ç›¸åŒçš„ Topic çš„å¯¹åº”é˜Ÿåˆ—ä¸­ã€‚è¿™ç§å½¢å¼ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡æåˆ°çš„ **æ™®é€š** é¡ºåºæ¶ˆæ¯çš„æ–¹å¼ã€‚

## 8.3 Demo06Consumer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.consumer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo06Consumer
ç±»ï¼Œå®ç° Rocket-Spring å®šä¹‰çš„ RocketMQListener æ¥å£ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

åœ¨ RocketMQ ä¸­ï¼ŒProducer å¯ä»¥æ ¹æ®å®šä¹‰ MessageQueueSelector æ¶ˆæ¯é˜Ÿåˆ—é€‰æ‹©ç­–ç•¥ï¼Œé€‰æ‹© Topic
ä¸‹çš„é˜Ÿåˆ—ã€‚ç›®å‰æä¾›ä¸‰ç§ç­–ç•¥ï¼š

SelectMessageQueueByHash ï¼ŒåŸºäº `hashKey` çš„å“ˆå¸Œå€¼å–ä½™ï¼Œé€‰æ‹©å¯¹åº”çš„é˜Ÿåˆ—ã€‚
SelectMessageQueueByRandom ï¼ŒåŸºäºéšæœºçš„ç­–ç•¥ï¼Œé€‰æ‹©é˜Ÿåˆ—ã€‚ SelectMessageQueueByMachineRoom ï¼ŒğŸ˜ˆ
æœ‰ç‚¹çœ‹ä¸æ‡‚ï¼Œç›®å‰æ˜¯ç©ºçš„å®ç°ï¼Œæš‚æ—¶æ— è§†å§ã€‚ æœªä½¿ç”¨ MessageQueueSelector æ—¶ï¼Œé‡‡ç”¨è½®è¯¢çš„ç­–ç•¥ï¼Œé€‰æ‹©é˜Ÿåˆ—ã€‚

    
    
    // Demo06Consumer.java
    
    @Component
    @RocketMQMessageListener(
            topic = Demo06Message.TOPIC,
            consumerGroup = "demo06-consumer-group-" + Demo06Message.TOPIC,
            consumeMode = ConsumeMode.ORDERLY // è®¾ç½®ä¸ºé¡ºåºæ¶ˆè´¹
    )
    public class Demo06Consumer implements RocketMQListener<Demo06Message> {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Override
        public void onMessage(Demo06Message message) {
            logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
    
            // sleep 2 ç§’ï¼Œç”¨äºæŸ¥çœ‹é¡ºåºæ¶ˆè´¹çš„æ•ˆæœ
            try {
                Thread.sleep(2 * 1000L);
            } catch (InterruptedException ignore) {
            }
        }
    
    }

  * å·®å¼‚ç‚¹ï¼Œä¸»è¦æ˜¯ `@RocketMQMessageListener` æ³¨è§£ï¼Œé€šè¿‡è®¾ç½®äº† `consumeMode = ConsumeMode.ORDERLY` ï¼Œè¡¨ç¤ºä½¿ç”¨ **é¡ºåºæ¶ˆè´¹** ã€‚

## 8.4 ç®€å•æµ‹è¯•

åˆ›å»º Demo06ProducerTest æµ‹è¯•ç±»ï¼Œç¼–å†™ä¸‰ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo06Producer ä¸‰ç§å‘é€ **é¡ºåº** æ¶ˆæ¯çš„æ–¹å¼ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo06ProducerTest.java
    
    @RunWith(SpringRunner.class)
    @SpringBootTest(classes = Application.class)
    public class Demo06ProducerTest {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Autowired
        private Demo06Producer producer;
    
        @Test
        public void testSyncSendOrderly() throws InterruptedException {
            // å‘é€å¤šæ¡æ¶ˆæ¯
            for (int i = 0; i < 3; i++) {
                int id = 1024; // å›ºå®šæˆ 1024 ï¼Œæ–¹ä¾¿æˆ‘ä»¬æµ‹è¯•æ˜¯å¦å‘é€åˆ°ç›¸åŒæ¶ˆæ¯é˜Ÿåˆ—
                SendResult result = producer.syncSendOrderly(id);
                logger.info("[testSyncSendOrderly][å‘é€ç¼–å·ï¼š[{}] å‘é€ç»“æœï¼š[{}]]", id, result);
            }
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
        @Test
        public void testASyncSendOrderly() throws InterruptedException {
            for (int i = 0; i < 3; i++) {
                int id = 1024; // å›ºå®šæˆ 1024 ï¼Œæ–¹ä¾¿æˆ‘ä»¬æµ‹è¯•æ˜¯å¦å‘é€åˆ°ç›¸åŒæ¶ˆæ¯é˜Ÿåˆ—
                producer.asyncSendOrderly(id, new SendCallback() {
    
                    @Override
                    public void onSuccess(SendResult result) {
                        logger.info("[testASyncSendOrderly][å‘é€ç¼–å·ï¼š[{}] å‘é€æˆåŠŸï¼Œç»“æœä¸ºï¼š[{}]]", id, result);
                    }
    
                    @Override
                    public void onException(Throwable e) {
                        logger.info("[testASyncSendOrderly][å‘é€ç¼–å·ï¼š[{}] å‘é€å¼‚å¸¸]]", id, e);
                    }
    
                });
            }
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
        @Test
        public void testOnewaySendOrderly() throws InterruptedException {
            for (int i = 0; i < 3; i++) {
                int id = 1024; // å›ºå®šæˆ 1024 ï¼Œæ–¹ä¾¿æˆ‘ä»¬æµ‹è¯•æ˜¯å¦å‘é€åˆ°ç›¸åŒæ¶ˆæ¯é˜Ÿåˆ—
                producer.onewaySendOrderly(id);
                logger.info("[testOnewaySendOrderly][å‘é€ç¼–å·ï¼š[{}] å‘é€å®Œæˆ]", id);
            }
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
    }

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testSyncSendOrderly()` æ–¹æ³•ï¼Œæµ‹è¯•åŒæ­¥å‘é€ **é¡ºåº** æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

    
    
    # Producer åŒæ­¥å‘é€ 3 æ¡é¡ºåºæ¶ˆæ¯æˆåŠŸï¼Œéƒ½å‘é€åˆ°äº† Topic ä¸º DEMO_06 ï¼Œé˜Ÿåˆ—ç¼–å·ä¸º 1 çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸Š
    2019-12-05 21:04:58.887  INFO 94854 --- [           main] c.i.s.l.r.producer.Demo06ProducerTest    : [testSyncSendOrderly][å‘é€ç¼–å·ï¼š[1024] å‘é€ç»“æœï¼š[SendResult [sendStatus=SEND_OK, msgId=C0A8032C728618B4AAC213F934030002, offsetMsgId=C0A8032C00002A9F000000000012D46A, messageQueue=MessageQueue [topic=DEMO_06, brokerName=broker-a, queueId=1], queueOffset=0]]]
    2019-12-05 21:04:58.889  INFO 94854 --- [           main] c.i.s.l.r.producer.Demo06ProducerTest    : [testSyncSendOrderly][å‘é€ç¼–å·ï¼š[1024] å‘é€ç»“æœï¼š[SendResult [sendStatus=SEND_OK, msgId=C0A8032C728618B4AAC213F934080004, offsetMsgId=C0A8032C00002A9F000000000012D580, messageQueue=MessageQueue [topic=DEMO_06, brokerName=broker-a, queueId=1], queueOffset=1]]]
    2019-12-05 21:04:58.891  INFO 94854 --- [           main] c.i.s.l.r.producer.Demo06ProducerTest    : [testSyncSendOrderly][å‘é€ç¼–å·ï¼š[1024] å‘é€ç»“æœï¼š[SendResult [sendStatus=SEND_OK, msgId=C0A8032C728618B4AAC213F9340A0006, offsetMsgId=C0A8032C00002A9F000000000012D696, messageQueue=MessageQueue [topic=DEMO_06, brokerName=broker-a, queueId=1], queueOffset=2]]]
    
    # ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆè´¹
    2019-12-05 21:05:01.647  INFO 94854 --- [MessageThread_1] c.i.s.l.r.consumer.Demo06Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:69 æ¶ˆæ¯å†…å®¹ï¼šDemo06Message{id=1024}]
    2019-12-05 21:05:03.651  INFO 94854 --- [MessageThread_1] a.r.s.s.DefaultRocketMQListenerContainer : consume C0A8032C728618B4AAC213F934030002 cost: 2005 ms
    # ç¬¬äºŒæ¡æ¶ˆæ¯çš„æ¶ˆè´¹
    2019-12-05 21:05:03.653  INFO 94854 --- [MessageThread_1] c.i.s.l.r.consumer.Demo06Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:69 æ¶ˆæ¯å†…å®¹ï¼šDemo06Message{id=1024}]
    2019-12-05 21:05:05.654  INFO 94854 --- [MessageThread_1] a.r.s.s.DefaultRocketMQListenerContainer : consume C0A8032C728618B4AAC213F934080004 cost: 2002 ms
    # ç¬¬ä¸‰æ¡æ¶ˆæ¯çš„æ¶ˆè´¹
    2019-12-05 21:05:05.654  INFO 94854 --- [MessageThread_1] c.i.s.l.r.consumer.Demo06Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:69 æ¶ˆæ¯å†…å®¹ï¼šDemo06Message{id=1024}]
    2019-12-05 21:05:07.657  INFO 94854 --- [MessageThread_1] a.r.s.s.DefaultRocketMQListenerContainer : consume C0A8032C728618B4AAC213F9340A0006 cost: 2003 ms

  * Producer å‘é€é¡ºåºæ¶ˆæ¯æ—¶ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨ `id = 1` ä½œä¸º `hashKey` ï¼Œæ‰€ä»¥éƒ½å‘é€åˆ°äº† Topic ä¸º `"DEMO_06"` ï¼Œé˜Ÿåˆ—ç¼–å·ä¸º 1 çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚
  * Consumer **é¡ºåº** æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œæ˜¯åœ¨ **å•çº¿ç¨‹** ä¸­ï¼Œé¡ºåºæ¶ˆè´¹æ¯æ¡æ¶ˆæ¯ã€‚

# 9\. äº‹åŠ¡æ¶ˆæ¯

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼šlab-31-rocketmq-demo ã€‚

åœ¨åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç›®å‰å”¯ä¸€æä¾› **å®Œæ•´çš„** äº‹åŠ¡æ¶ˆæ¯çš„ï¼Œåªæœ‰ RocketMQ ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œè¿˜æ˜¯å¯ä»¥é¼“å¹ä¸‹çš„ã€‚

å¯èƒ½ä¼šæœ‰èƒ–å‹æ€’å–·è‰¿è‰¿ï¼ŒRabbitMQ å’Œ Kafka ä¹Ÿæœ‰äº‹åŠ¡æ¶ˆæ¯å•Šï¼Œä¹Ÿæ”¯æŒå‘é€äº‹åŠ¡æ¶ˆæ¯çš„å‘é€ï¼Œä»¥åŠåç»­çš„äº‹åŠ¡æ¶ˆæ¯çš„ commitæäº¤æˆ–
rollbackc å›æ»šã€‚ä½†æ˜¯è¦è€ƒè™‘ä¸€ä¸ªæç«¯çš„æƒ…å†µï¼Œåœ¨ **æœ¬åœ°æ•°æ®åº“äº‹åŠ¡å·²ç»æäº¤** çš„æ—¶æ—¶å€™ï¼Œå¦‚æœå› ä¸ºç½‘ç»œåŸå› ï¼Œåˆæˆ–è€…å´©æºƒç­‰ç­‰æ„å¤–ï¼Œå¯¼è‡´äº‹åŠ¡æ¶ˆæ¯æ²¡æœ‰è¢«
commit ï¼Œæœ€ç»ˆå¯¼è‡´è¿™æ¡äº‹åŠ¡æ¶ˆæ¯ä¸¢å¤±ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å‡ºç°é—®é¢˜ã€‚

ç›¸æ¯”æ¥è¯´ï¼ŒRocketMQ æä¾›äº‹åŠ¡å›æŸ¥æœºåˆ¶ï¼Œå¦‚æœåº”ç”¨è¶…è¿‡ä¸€å®šæ—¶é•¿æœª commit æˆ– rollback è¿™æ¡äº‹åŠ¡æ¶ˆæ¯ï¼ŒRocketMQ
ä¼šä¸»åŠ¨å›æŸ¥åº”ç”¨ï¼Œè¯¢é—®è¿™æ¡äº‹åŠ¡æ¶ˆæ¯æ˜¯ commit è¿˜æ˜¯ rollback ï¼Œä»è€Œå®ç°äº‹åŠ¡æ¶ˆæ¯çš„çŠ¶æ€æœ€ç»ˆèƒ½å¤Ÿè¢« commit æˆ–æ˜¯ rollback
ï¼Œè¾¾åˆ°æœ€ç»ˆäº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè‰¿è‰¿åœ¨ä¸Šé¢ä¸“é—¨åŠ ç²—â€œ **å®Œæ•´çš„**
â€ä¸‰ä¸ªå­—çš„åŸå› ã€‚å¯èƒ½ä¸Šè¿°çš„æè¿°ï¼Œå¯¹äºç»å¤§å¤šæ•°æ²¡æœ‰äº†è§£è¿‡åˆ†å¸ƒå¼äº‹åŠ¡çš„èƒ–å‹ï¼Œä¼šæ¯”è¾ƒé™Œç”Ÿï¼Œæ‰€ä»¥æ¨èé˜…è¯»å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

  * ã€Šé˜¿é‡Œäº‘æ¶ˆæ¯é˜Ÿåˆ— MQ â€”â€” äº‹åŠ¡æ¶ˆæ¯ã€‹
  * ã€ŠèŠ‹é“ RocketMQ æºç è§£æ â€”â€” äº‹åŠ¡æ¶ˆæ¯ã€‹

> çƒ­å¿ƒçš„è‰¿è‰¿ï¼šè™½ç„¶è¯´ RabbitMQã€Kafka å¹¶æœªæä¾›å®Œæ•´çš„äº‹åŠ¡æ¶ˆæ¯ï¼Œä½†æ˜¯ç¤¾åŒºé‡Œï¼Œå·²ç»åŸºäºå®ƒä»¬ä¹‹ä¸Šæ‹“å±•ï¼Œæä¾›äº†äº‹åŠ¡å›æŸ¥çš„åŠŸèƒ½ã€‚ä¾‹å¦‚è¯´ï¼šMyth
> ï¼Œé‡‡ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„å¼€æºæ¡†æ¶, åŸºäº Java è¯­è¨€æ¥å¼€å‘ï¼ˆJDK1.8ï¼‰ï¼Œæ”¯æŒ Dubboï¼ŒSpring Cloudï¼ŒMotan ç­‰ RPC
> æ¡†æ¶è¿›è¡Œåˆ†å¸ƒå¼äº‹åŠ¡ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹æœ¬å°èŠ‚çš„ç¤ºä¾‹ã€‚

## 9.1 Demo07Message

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.message` åŒ…ä¸‹ï¼Œåˆ›å»º Demo07Message
æ¶ˆæ¯ç±»ï¼Œæä¾›ç»™å½“å‰ç¤ºä¾‹ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    public class Demo07Message {
    
        public static final String TOPIC = "DEMO_07";
    
        /**
         * ç¼–å·
         */
        private Integer id;
    
        // ... çœç•¥ set/get/toString æ–¹æ³•
    
    }

  * `TOPIC` é™æ€å±æ€§ï¼Œæˆ‘ä»¬è®¾ç½®è¯¥æ¶ˆæ¯ç±»å¯¹åº” Topic ä¸º `"DEMO_07"` ã€‚

## 9.2 Demo07Producer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.producer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo07Producer
ç±»ï¼Œå®ƒä¼šä½¿ç”¨ RocketMQ-Spring å°è£…æä¾›çš„ RocketMQTemplate ï¼Œå®ç°å‘é€ **äº‹åŠ¡** æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo07Producer.java
    
    @Component
    public class Demo07Producer {
    
        private static final String TX_PRODUCER_GROUP = "demo07-producer-group";
    
        @Autowired
        private RocketMQTemplate rocketMQTemplate;
    
        public TransactionSendResult sendMessageInTransaction(Integer id) {
            // <1> åˆ›å»º Demo07Message æ¶ˆæ¯
            Message message = MessageBuilder.withPayload(new Demo07Message().setId(id))
                    .build();
            // <2> å‘é€äº‹åŠ¡æ¶ˆæ¯
            return rocketMQTemplate.sendMessageInTransaction(TX_PRODUCER_GROUP, Demo07Message.TOPIC, message,
                    id);
        }
    
    }

  * `<1>` å¤„ï¼Œåˆ›å»ºå†…å®¹ä¸º Demo07Message çš„ Spring Messaging Message æ¶ˆæ¯ã€‚
  * `<2>` å¤„ï¼Œè°ƒç”¨ `RocketMQTemplate#sendMessageInTransaction(...)` æ–¹æ³•ï¼Œå‘é€äº‹åŠ¡æ¶ˆæ¯ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹è¯¥æ–¹æ³•çš„æ–¹æ³•å‚æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š

    
    
    // RocketMQTemplate.java
    
    /**
     * Send Spring Message in Transaction
     *
     * @param txProducerGroup the validate txProducerGroup name, set null if using the default name
     * @param destination     destination formats: `topicName:tags`
     * @param message         message {@link org.springframework.messaging.Message}
     * @param arg             ext arg
     * @return TransactionSendResult
     * @throws MessagingException
     */
    public TransactionSendResult sendMessageInTransaction(final String txProducerGroup, final String destination,
        final Message<?> message, final Object arg) throws MessagingException {
        try {
            TransactionMQProducer txProducer = this.stageMQProducer(txProducerGroup);
            org.apache.rocketmq.common.message.Message rocketMsg = this.createRocketMqMessage(destination, message);
            return txProducer.sendMessageInTransaction(rocketMsg, arg);
        } catch (MQClientException e) {
            throw RocketMQUtil.convert(e);
        }
    }

  *     * æ–¹æ³•å‚æ•° `txProducerGroup` ï¼Œäº‹åŠ¡æ¶ˆæ¯çš„ç”Ÿäº§è€…åˆ†ç»„ã€‚å› ä¸º RocketMQ æ˜¯å›æŸ¥ï¼ˆè¯·æ±‚ï¼‰æŒ‡å®šæŒ‡å®šç”Ÿäº§åˆ†ç»„ä¸‹çš„ Producer ï¼Œä»è€Œè·å¾—äº‹åŠ¡æ¶ˆæ¯çš„çŠ¶æ€ï¼Œæ‰€ä»¥ä¸€å®šè¦æ­£ç¡®è®¾ç½®ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬è®¾ç½®äº† `"demo07-producer-group"` ã€‚
    * æ–¹æ³•å‚æ•° `destination` ï¼Œæ¶ˆæ¯çš„ Topic + Tag ã€‚
    * æ–¹æ³•å‚æ•° `message` ï¼Œæ¶ˆæ¯ï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«ã€‚
    * æ–¹æ³•å‚æ•° `arg` ï¼Œåç»­æˆ‘ä»¬è°ƒç”¨æœ¬åœ°äº‹åŠ¡æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šä¼ å…¥è¯¥ `arg` ã€‚å¦‚æœè¦ä¼ é€’å¤šä¸ªæ–¹æ³•å‚æ•°ç»™æœ¬åœ°äº‹åŠ¡çš„æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡æ•°ç»„ï¼Œä¾‹å¦‚è¯´ `Object[]{arg1, arg2, arg3}` è¿™æ ·çš„å½¢å¼ã€‚

## 9.3 TransactionListenerImpl

åœ¨ Demo07Producer ç±»ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªå†…éƒ¨ç±» TransactionListenerImpl ï¼Œå®ç° MQ äº‹åŠ¡çš„ç›‘å¬ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo07Producer.java
    
    @RocketMQTransactionListener(txProducerGroup = TX_PRODUCER_GROUP)
    public class TransactionListenerImpl implements RocketMQLocalTransactionListener {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Override
        public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object arg) {
            // ... local transaction process, return rollback, commit or unknown
            logger.info("[executeLocalTransaction][æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œæ¶ˆæ¯ï¼š{} argï¼š{}]", msg, arg);
            return RocketMQLocalTransactionState.UNKNOWN;
        }
    
        @Override
        public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {
            // ... check transaction status and return rollback, commit or unknown
            logger.info("[checkLocalTransaction][å›æŸ¥æ¶ˆæ¯ï¼š{}]", msg);
            return RocketMQLocalTransactionState.COMMIT;
        }
    
    }

  * åœ¨ç±»ä¸Šï¼Œæ·»åŠ  `@RocketMQTransactionListener` æ³¨è§£ï¼Œå£°æ˜ç›‘å¬å™¨çš„æ˜¯ç”Ÿäº§è€…åˆ†ç»„æ˜¯ `"demo07-producer-group"` çš„ Producer å‘é€çš„äº‹åŠ¡æ¶ˆæ¯ã€‚
  * å®ç° RocketMQLocalTransactionListener æ¥å£ï¼Œå®ç°æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å’Œæ£€æŸ¥æœ¬åœ°äº‹åŠ¡çš„æ–¹æ³•ã€‚
  * å®ç° `#executeLocalTransaction(...)` æ–¹æ³•ï¼Œå®ç°æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ã€‚ 
    * æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ª **æ¨¡æ¿æ–¹æ³•** ã€‚åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¹‹å‰ï¼ŒRocketMQTemplate å·²ç»ä½¿ç”¨ Producer å‘é€äº†ä¸€æ¡äº‹åŠ¡æ¶ˆæ¯ã€‚ç„¶åæ ¹æ®è¯¥æ–¹æ³•æ‰§è¡Œçš„è¿”å›çš„ RocketMQLocalTransactionState ç»“æœï¼Œæäº¤è¿˜æ˜¯å›æ»šè¯¥äº‹åŠ¡æ¶ˆæ¯ã€‚
    * è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºäº†æ¨¡æ‹Ÿ RocketMQ å›æŸ¥ Producer æ¥è·å¾—äº‹åŠ¡æ¶ˆæ¯çš„çŠ¶æ€ï¼Œæ‰€ä»¥è¿”å›äº† `RocketMQLocalTransactionState.UNKNOWN` æœªçŸ¥çŠ¶æ€ã€‚
  * å®ç° `#checkLocalTransaction(...)` æ–¹æ³•ï¼Œæ£€æŸ¥æœ¬åœ°äº‹åŠ¡ã€‚ 
    * åœ¨äº‹åŠ¡æ¶ˆæ¯é•¿äº‹ä»¶æœªè¢«æäº¤æˆ–å›æ»šæ—¶ï¼ŒRocketMQ ä¼šå›æŸ¥äº‹åŠ¡æ¶ˆæ¯å¯¹åº”çš„ç”Ÿäº§è€…åˆ†ç»„ä¸‹çš„ Producer ï¼Œè·å¾—äº‹åŠ¡æ¶ˆæ¯çš„çŠ¶æ€ã€‚æ­¤æ—¶ï¼Œè¯¥æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚
    * è¿™é‡Œï¼Œæˆ‘ä»¬ç›´æ¥è¿”å› `RocketMQLocalTransactionState.COMMIT` æäº¤çŠ¶æ€ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œæœ‰ä¸¤ç§æ–¹å¼å®ç°æœ¬åœ°äº‹åŠ¡å›æŸ¥æ—¶ï¼Œè¿”å›äº‹åŠ¡æ¶ˆæ¯çš„çŠ¶æ€ã€‚

**ç¬¬ä¸€ç§** ï¼Œé€šè¿‡ `msg` æ¶ˆæ¯ï¼Œè·å¾—æŸä¸ªä¸šåŠ¡ä¸Šçš„æ ‡è¯†æˆ–è€…ç¼–å·ï¼Œç„¶åå»æ•°æ®åº“ä¸­æŸ¥è¯¢ä¸šåŠ¡è®°å½•ï¼Œä»è€Œåˆ¤æ–­è¯¥äº‹åŠ¡æ¶ˆæ¯çš„çŠ¶æ€æ˜¯æäº¤è¿˜æ˜¯å›æ»šã€‚

**ç¬¬äºŒç§** ï¼Œè®°å½• `msg` çš„äº‹åŠ¡ç¼–å·ï¼Œä¸äº‹åŠ¡çŠ¶æ€åˆ°æ•°æ®åº“ä¸­ã€‚

  * ç¬¬ä¸€æ­¥ï¼Œåœ¨ `#executeLocalTransaction(...)` æ–¹æ³•ä¸­ï¼Œå…ˆå­˜å‚¨ä¸€æ¡ `id` ä¸º `msg` çš„äº‹åŠ¡ç¼–å·ï¼ŒçŠ¶æ€ä¸º `RocketMQLocalTransactionState.UNKNOWN` çš„è®°å½•ã€‚
  * ç¬¬äºŒæ­¥ï¼Œè°ƒç”¨å¸¦æœ‰ **äº‹åŠ¡çš„** ä¸šåŠ¡ Service çš„æ–¹æ³•ã€‚åœ¨è¯¥ Service æ–¹æ³•ä¸­ï¼Œåœ¨é€»è¾‘éƒ½æ‰§è¡ŒæˆåŠŸçš„æƒ…å†µä¸‹ï¼Œæ›´æ–° `id` ä¸º `msg` çš„äº‹åŠ¡ç¼–å·ï¼ŒçŠ¶æ€å˜æ›´ä¸º `RocketMQLocalTransactionState.COMMIT` ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¼´éšè¿™ä¸ªäº‹åŠ¡çš„æäº¤ï¼Œæ›´æ–° `id` ä¸º `msg` çš„äº‹åŠ¡ç¼–å·çš„è®°å½•çš„çŠ¶ä¸º `RocketMQLocalTransactionState.COMMIT` ï¼Œç¾æ»‹æ»‹ã€‚ã€‚
  * ç¬¬ä¸‰æ­¥ï¼Œè¦ä»¥ `try-catch` çš„æ–¹å¼ï¼Œè°ƒç”¨ä¸šåŠ¡ Service çš„æ–¹æ³•ã€‚å¦‚æ­¤ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œå›æ»šäº‹åŠ¡çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨ `catch` ä¸­ï¼Œæ›´æ–° `id` ä¸º `msg` çš„äº‹åŠ¡ç¼–å·çš„è®°å½•çš„çŠ¶æ€ä¸º `RocketMQLocalTransactionState.ROLLBACK` ã€‚ğŸ˜­ æç«¯æƒ…å†µä¸‹ï¼Œå¯èƒ½æ›´æ–°å¤±è´¥ï¼Œåˆ™æ‰“å° error æ—¥å¿—ï¼Œå‘Šè­¦çŸ¥é“ï¼Œäººå·¥ä»‹å…¥ã€‚
  * å¦‚æ­¤ä¸‰æ­¥ä¹‹åï¼Œæˆ‘ä»¬åœ¨ `#executeLocalTransaction(...)` æ–¹æ³•ä¸­ï¼Œå°±å¯ä»¥é€šè¿‡æŸ¥æ‰¾æ•°æ®åº“ï¼Œ`id` ä¸º `msg` çš„äº‹åŠ¡ç¼–å·çš„è®°å½•çš„çŠ¶æ€ï¼Œç„¶åè¿”å›ã€‚

**ç›¸æ¯”æ¥è¯´** ï¼Œè‰¿è‰¿å€¾å‘ç¬¬äºŒç§ï¼Œå®ç°æ›´åŠ ç®€å•é€šç”¨ï¼Œå¯¹äºä¸šåŠ¡å¼€å‘è€…ï¼Œæ›´åŠ å‹å¥½ã€‚å’Œæœ‰å‡ ä¸ªæœ‹å‹æ²Ÿé€šäº†ä¸‹ï¼Œä»–ä»¬ä¹Ÿæ˜¯é‡‡ç”¨ç¬¬äºŒç§ã€‚

## 9.4 Demo07Consumer

åœ¨ `cn.iocoder.springboot.lab31.rocketmqdemo.consumer` åŒ…ä¸‹ï¼Œåˆ›å»º Demo03Consumer
ç±»ï¼Œå®ç° Rocket-Spring å®šä¹‰çš„ RocketMQListener æ¥å£ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    @Component
    @RocketMQMessageListener(
            topic = Demo07Message.TOPIC,
            consumerGroup = "demo07-consumer-group-" + Demo07Message.TOPIC
    )
    public class Demo07Consumer implements RocketMQListener<Demo07Message> {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Override
        public void onMessage(Demo07Message message) {
            logger.info("[onMessage][çº¿ç¨‹ç¼–å·:{} æ¶ˆæ¯å†…å®¹ï¼š{}]", Thread.currentThread().getId(), message);
        }
    
    }

  * å’Œ ã€Œ3.8 Demo1Consumerã€ æ˜¯ä¸€æ ·ï¼Œå°±æ˜¯æ¶ˆè´¹æ¶ˆæ¯ã€‚

## 9.5 ç®€å•æµ‹è¯•

åˆ›å»º Demo07ProducerTest æµ‹è¯•ç±»ï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ Demo07Producer å‘é€ **äº‹åŠ¡** æ¶ˆæ¯çš„æ–¹å¼ã€‚ä»£ç å¦‚ä¸‹ï¼š

    
    
    // Demo07ProducerTest.java
    
    @RunWith(SpringRunner.class)
    @SpringBootTest(classes = Application.class)
    public class Demo07ProducerTest {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Autowired
        private Demo07Producer producer;
    
        @Test
        public void testSendMessageInTransaction() throws InterruptedException {
            int id = (int) (System.currentTimeMillis() / 1000);
            SendResult result = producer.sendMessageInTransaction(id);
            logger.info("[testSendMessageInTransaction][å‘é€ç¼–å·ï¼š[{}] å‘é€ç»“æœï¼š[{}]]", id, result);
    
            // é˜»å¡ç­‰å¾…ï¼Œä¿è¯æ¶ˆè´¹
            new CountDownLatch(1).await();
        }
    
    }

æˆ‘ä»¬æ¥æ‰§è¡Œ `#testSendMessageInTransaction()` æ–¹æ³•ï¼Œæµ‹è¯•å‘é€ **äº‹åŠ¡** æ¶ˆæ¯ã€‚æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

    
    
    # TransactionListenerImpl æ‰§è¡Œ executeLocalTransaction æ–¹æ³•ï¼Œå…ˆæ‰§è¡Œæœ¬åœ°äº‹åŠ¡çš„é€»è¾‘
    2019-12-06 01:23:00.928  INFO 3205 --- [           main] p.Demo07Producer$TransactionListenerImpl : [executeLocalTransaction][æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œæ¶ˆæ¯ï¼šGenericMessage [payload=byte[17], headers={rocketmq_TOPIC=DEMO_07, rocketmq_FLAG=0, id=ce85ed2a-d7ae-9cc6-226d-a8beb2e219ab, contentType=application/json, rocketmq_TRANSACTION_ID=0AAB01730C8518B4AAC214E570BD0002, timestamp=1575480180928}] argï¼š1575480180]
    
    # Producer å‘é€äº‹åŠ¡æ¶ˆæ¯æˆåŠŸï¼Œä½†æ˜¯å› ä¸º executeLocalTransaction æ–¹æ³•è¿”å›çš„æ˜¯ UNKOWN çŠ¶æ€ï¼Œæ‰€ä»¥äº‹åŠ¡æ¶ˆæ¯å¹¶æœªæäº¤æˆ–è€…å›æ»š
    2019-12-06 01:23:00.930  INFO 3205 --- [           main] c.i.s.l.r.producer.Demo07ProducerTest    : [testSendMessageInTransaction][å‘é€ç¼–å·ï¼š[1575480180] å‘é€ç»“æœï¼š[SendResult [sendStatus=SEND_OK, msgId=0AAB01730C8518B4AAC214E570BD0002, offsetMsgId=null, messageQueue=MessageQueue [topic=DEMO_07, brokerName=broker-a, queueId=3], queueOffset=38]]]
    
    # RocketMQ Broker åœ¨å‘é€äº‹åŠ¡æ¶ˆæ¯ 30 ç§’åï¼Œå‘ç°äº‹åŠ¡æ¶ˆæ¯è¿˜æœªæäº¤æˆ–æ˜¯å›æ»šï¼Œæ‰€ä»¥å›æŸ¥ Producer ã€‚æ­¤æ—¶ï¼ŒcheckLocalTransaction æ–¹æ³•è¿”å› COMMIT ï¼Œæ‰€ä»¥è¯¥äº‹åŠ¡æ¶ˆæ¯è¢«æäº¤
    2019-12-06 01:23:35.155  INFO 3205 --- [pool-1-thread-1] p.Demo07Producer$TransactionListenerImpl : [checkLocalTransaction][å›æŸ¥æ¶ˆæ¯ï¼šGenericMessage [payload=byte[17], headers={rocketmq_QUEUE_ID=3, TRANSACTION_CHECK_TIMES=1, rocketmq_BORN_TIMESTAMP=1575480180925, rocketmq_TOPIC=DEMO_07, rocketmq_FLAG=0, rocketmq_MESSAGE_ID=0AAB017300002A9F0000000000132AC3, rocketmq_TRANSACTION_ID=0AAB01730C8518B4AAC214E570BD0002, rocketmq_SYS_FLAG=0, id=0fc2f199-25fb-5911-d577-f81b8003f0f8, CLUSTER=DefaultCluster, rocketmq_BORN_HOST=10.171.1.115, contentType=application/json, timestamp=1575480215155}]]
    
    # äº‹åŠ¡æ¶ˆæ¯è¢«æäº¤ï¼Œæ‰€ä»¥è¯¥æ¶ˆæ¯è¢« Consumer æ¶ˆè´¹
    2019-12-06 01:23:35.160  INFO 3205 --- [MessageThread_1] c.i.s.l.r.consumer.Demo07Consumer        : [onMessage][çº¿ç¨‹ç¼–å·:89 æ¶ˆæ¯å†…å®¹ï¼šDemo07Message{id=1575480180}]

  * æ•´ä¸ªçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œçœ‹çœ‹è‰¿è‰¿åœ¨æ—¥å¿—ä¸Šæ·»åŠ çš„è¯´æ˜ã€‚

## 9.6 @RocketMQTransactionListener

åœ¨ ã€Œ9.3 TransactionListenerImplã€ ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨äº† `@RocketMQTransactionListener` æ³¨è§£ï¼Œè®¾ç½®
MQ äº‹åŠ¡ç›‘å¬å™¨çš„ä¿¡æ¯ã€‚å…·ä½“å±æ€§å¦‚ä¸‹ï¼š

    
    
    // RocketMQTransactionListener.java
    
    public @interface RocketMQTransactionListener {
    
        /**
         * äº‹åŠ¡çš„ç”Ÿäº§è€…åˆ†ç»„
         *
         * Declare the txProducerGroup that is used to relate callback event to the listener, rocketMQTemplate must send a
         * transactional message with the declared txProducerGroup.
         * <p>
         * <p>It is suggested to use the default txProducerGroup if your system only needs to define a TransactionListener class.
         */
        String txProducerGroup() default RocketMQConfigUtils.ROCKETMQ_TRANSACTION_DEFAULT_GLOBAL_NAME;
    
        /**
         * Set ExecutorService params -- corePoolSize
         */
        int corePoolSize() default 1;
        /**
         * Set ExecutorService params -- maximumPoolSize
         */
        int maximumPoolSize() default 1;
        /**
         * Set ExecutorService params -- keepAliveTime
         */
        long keepAliveTime() default 1000 * 60; //60ms
        /**
         * Set ExecutorService params -- blockingQueueSize
         */
        int blockingQueueSize() default 2000;
    
        /**
         * The property of "access-key"
         */
        String accessKey() default "${rocketmq.producer.access-key}";
        /**
         * The property of "secret-key"
         */
        String secretKey() default "${rocketmq.producer.secret-key}";
    }

# 10\. æ¥å…¥é˜¿é‡Œäº‘çš„æ¶ˆæ¯é˜Ÿåˆ— RocketMQ

åœ¨é˜¿é‡Œäº‘ä¸Šï¼Œæä¾›æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æœåŠ¡ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿä½¿ç”¨ RocketMQ-Spring å®ç°é˜¿é‡Œäº‘ RocketMQ
çš„æ¶ˆæ¯çš„å‘é€ä¸æ¶ˆè´¹å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ **å¯ä»¥** ã€‚åœ¨ ã€Šé˜¿é‡Œäº‘ â€”â€” æ¶ˆæ¯é˜Ÿåˆ— MQ â€”â€” å¼€æº Java SDK æ¥å…¥è¯´æ˜ã€‹ ä¸­ï¼Œæåˆ°ç›®å‰å¼€æºçš„ Java SDK å¯ä»¥æ¥å…¥é˜¿é‡Œäº‘
RocketMQ æœåŠ¡ã€‚

> å¦‚æœæ‚¨å·²ä½¿ç”¨å¼€æº Java SDK è¿›è¡Œç”Ÿäº§ï¼Œåªéœ€å‚è€ƒæ–¹æ³•ï¼Œé‡æ–°é…ç½®å‚æ•°ï¼Œå³å¯å®ç°æ— ç¼ä¸Šäº‘ã€‚
>
> **å‰ææ¡ä»¶**
>
>   * å·²åœ¨é˜¿é‡Œäº‘ MQ æ§åˆ¶å°åˆ›å»ºèµ„æºï¼ŒåŒ…æ‹¬ Topicã€Group IDï¼ˆGIDï¼‰ã€æ¥å…¥ç‚¹ï¼ˆEndpointï¼‰ï¼Œä»¥åŠ AccessKeyId å’Œ
> AccessKeySecretã€‚
>   * å·²ä¸‹è½½å¼€æº RocketMQ 4.5.1 æˆ–ä»¥ä¸Šç‰ˆæœ¬ï¼Œä»¥æ”¯æŒè¿æ¥é˜¿é‡Œäº‘ MQã€‚
>

è¿™é‡Œï¼Œè‰¿è‰¿åˆ›å»ºäº† lab-31-rocketmq-ons ç¤ºä¾‹é¡¹ç›®ï¼Œä½¿ç”¨ RocketMQ-Spring æ¥å…¥é˜¿é‡Œäº‘ã€‚é‡ç‚¹çš„å·®å¼‚ï¼Œå°±åœ¨
`application.yaml` é…ç½®æ–‡ä»¶ï¼Œé…ç½®å¦‚ä¸‹ï¼š

    
    
    # rocketmq é…ç½®é¡¹ï¼Œå¯¹åº” RocketMQProperties é…ç½®ç±»
    rocketmq:
      name-server: http://onsaddr.mq-internet-access.mq-internet.aliyuncs.com:80 # é˜¿é‡Œäº‘ RocketMQ Namesrv
      access-channel: CLOUD # è®¾ç½®ä½¿ç”¨é˜¿é‡Œäº‘
      # Producer é…ç½®é¡¹
      producer:
        group: GID_PRODUCER_GROUP_YUNAI_TEST # ç”Ÿäº§è€…åˆ†ç»„
        access-key: # è®¾ç½®é˜¿é‡Œäº‘çš„ RocketMQ çš„ access key ï¼ï¼ï¼è¿™é‡Œæ¶‰åŠåˆ°éšç§ï¼Œæ‰€ä»¥è¿™é‡Œè‰¿è‰¿æ²¡æœ‰æä¾›
        secret-key: # è®¾ç½®é˜¿é‡Œäº‘çš„ RocketMQ çš„ secret key ï¼ï¼ï¼è¿™é‡Œæ¶‰åŠåˆ°éšç§ï¼Œæ‰€ä»¥è¿™é‡Œè‰¿è‰¿æ²¡æœ‰æä¾›

  * é‡ç‚¹ï¼Œå°±æ˜¯è®¾ç½®äº† `rocketmq.access-channel=CLOUD` ï¼Œè®¿é—®é˜¿é‡Œäº‘ RocketMQ æœåŠ¡ã€‚ 

ä»ä¸ªäººä½¿ç”¨æ„Ÿå—ä¸Šæ¥è¯´ï¼ŒRocketMQ æä¾›çš„ç‰¹æ€§ï¼Œå¯èƒ½æ˜¯æœ€ä¸ºä¸°å¯Œçš„ï¼Œå¯ä»¥è¯´æ˜¯æœ€é€‚åˆä¸šåŠ¡å›¢é˜Ÿçš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ã€‚è‰¿è‰¿æ˜¯ä» 2013 å¹´å¼€å§‹ç”¨ RocketMQ
çš„ï¼Œä¸»è¦è¸©çš„å‘ï¼Œéƒ½æ˜¯è‡ªå·±é”™è¯¯ä½¿ç”¨å¯¼è‡´çš„ã€‚ä¾‹å¦‚è¯´ï¼š

  * åˆšå¼€å§‹ç•¥å¾®æŠ é—¨ï¼Œåªæ­å»ºäº† RocketMQ ä¸€ä¸»ä¸€ä»é›†ç¾¤ï¼Œç»“æœæ°å¥½å€’éœ‰ï¼Œä¸å°å¿ƒæŒ‚äº†ä¸»ã€‚
  * å¤šä¸ª Topic å…¬ç”¨ä¸€ä¸ªæ¶ˆè´¹è€…é›†ç¾¤ï¼Œå¯¼è‡´ä½¿ç”¨ç›¸åŒçº¿ç¨‹æ± ã€‚ç»“æœï¼Œå˜¿~æœ‰ä¸ªæ¶ˆè´¹é€»è¾‘éœ€è¦è°ƒç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ŒæŸä¸€å¤©çªç„¶ç‰¹åˆ«æ…¢ï¼Œå¯¼è‡´æ¶ˆè´¹ç§¯å‹ï¼Œè¿›è€Œæ•´ä¸ªçº¿ç¨‹æ± å µå¡ã€‚
  * ç›¸åŒæ¶ˆè´¹è€…åˆ†ç»„ï¼Œè®¢é˜…äº†ä¸åŒçš„ Topic ï¼Œå¯¼è‡´ç›¸äº’è¦†ç›–ã€‚

å¦‚æœèƒ–å‹åœ¨ä½¿ç”¨é˜¿é‡Œäº‘çš„è¯ï¼Œå»ºè®®é‡çº§è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘å…ˆä½¿ç”¨ é˜¿é‡Œäº‘ â€”â€” æ¶ˆæ¯é˜Ÿåˆ— MQ æœåŠ¡ ã€‚æ¯•ç«Ÿæ­å»ºä¸€ä¸ªé«˜å¯ç”¨çš„ RocketMQ
é‡ä¸»ä¸¤ä»çš„é›†ç¾¤ï¼Œæœ€æœ€æœ€èµ·ç è¦ä¸¤ä¸ª ECS èŠ‚ç‚¹ã€‚åŒæ—¶ï¼Œéœ€è¦ä¸€å®šçš„ç»´æŠ¤å’Œç›‘æ§æˆæœ¬ã€‚ğŸ˜ˆ æˆ‘ä»¬ç›®å‰æœ‰ä¸ªé¡¹ç›®ï¼Œå°±æ˜¯ç›´æ¥ä½¿ç”¨é˜¿é‡Œäº‘çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ã€‚

æ¶ˆæ¯é˜Ÿåˆ—æ˜¯éå¸¸é‡è¦çš„ç»„ä»¶ï¼Œæ¨èé˜…è¯»ä¸‹ RocketMQ çš„æœ€ä½³å®è·µï¼š

  * ã€Šé˜¿é‡Œäº‘ â€”â€” æ¶ˆæ¯é˜Ÿåˆ— MQ æœåŠ¡ â€”â€” æœ€ä½³å®è·µã€‹
  * ã€ŠRocketMQ å®˜æ–¹æ–‡æ¡£ â€”â€” æœ€ä½³å®è·µã€‹

å¦å¤–ï¼Œå¦‚ä¸‹ **å®˜æ–¹** æ–‡æ¡£ï¼Œå»ºè®®é€šè¯» + é€šè¯» + é€šæ–­ï¼š

  * ã€ŠRocketMQ ç”¨æˆ·æŒ‡å—ã€‹ åŸºäº RocketMQ 3 çš„ç‰ˆæœ¬ã€‚
  * ã€ŠRocketMQ åŸç†ç®€ä»‹ã€‹ åŸºäº RocketMQ 3 çš„ç‰ˆæœ¬ã€‚
  * ã€ŠRocketMQ æœ€ä½³å®è·µã€‹ åŸºäº RocketMQ 3 çš„ç‰ˆæœ¬ã€‚
  * ã€ŠRocketMQ å¼€å‘è€…æŒ‡å—ã€‹ åŸºäº RocketMQ 4 çš„ç‰ˆæœ¬ã€‚
  * ã€Šé˜¿é‡Œäº‘ â€”â€” æ¶ˆæ¯é˜Ÿåˆ— MQã€‹ é˜¿é‡Œäº‘çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°±æ˜¯ RocketMQ çš„äº‘æœåŠ¡ã€‚

è¿™é‡Œï¼Œåœ¨é¢å¤–æ¨èä¸€äº›å†…å®¹ï¼š

  * ã€ŠRocketMQ å…¥é—¨ â€”â€” åŸç†ä¸å®è·µã€‹ ï¼Œä¸€æ–‡å¿«é€Ÿäº†è§£ RocketMQ çš„åŸç†ä¸å®è·µï¼Œéå¸¸ä¸é”™ï¼Œç¯‡å¹…ä¹Ÿåœ¨å¯æ¥å—çš„èŒƒå›´ä¹‹å†…ã€‚
  * ã€Šæ€§èƒ½æµ‹è¯• â€”â€” RocketMQ åŸºå‡†æµ‹è¯•ã€‹ ï¼Œæ¶ˆæ¯æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æˆ‘ä»¬éå¸¸é‡è¦çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Œé‚£ä¹ˆåˆ°åº•å®ƒçš„æ€§èƒ½æœ‰å¤šå¼ºï¼Œä½•ä¸ä¸Šæ‰‹æµ‹è¯•ä¸€æ³¢~
  * ã€ŠRocketMQ æºç è§£æç³»åˆ—ã€‹ ï¼ŒçŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚RocketMQ æ˜¯è‰¿è‰¿ç¬¬ä¸€ä¸ªç‰¹åˆ«å®Œå…¨çœ‹å®Œçš„å¼€æºä¸­é—´ä»¶ï¼Œæ”¶è·é¢‡ä¸°ã€‚

