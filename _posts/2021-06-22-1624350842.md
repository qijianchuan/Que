---
title: MongoDB之——基于Shell命令行操作记录
categories: 精通分布式数据库系列
tags: MongoDB
---
转载请注明出处：https://blog.csdn.net/l1028386804/article/details/79982083  

### 一、插入记录

下面我们来建立一个 test 的集合并写入一些数据. 建立两个对象 j 和 t , 并保存到集合中去.  
在例子里 “>” 来表示是 shell 输入提示符  

    
    
    > j = { name : "mongo" };
    {"name" : "mongo"}
    > t = { x : 3 };
    { "x" : 3 }
    > db.things.save(j);
    > db.things.save(t);
    > db.things.find();
    { "_id" : ObjectId("4c2209f9f3924d31102bd84a"), "name" : "mongo" }
    { "_id" : ObjectId("4c2209fef3924d31102bd84b"), "x" : 3 }
    >

有几点需要注意一下:  
1)不需要预先创建一个集合. 在第一次插入数据时候会自动创建.  
2)在文档中其实可以存储任何结构的数据, 当然在实际应用我们存储的还是相同类型文档的集合. 这个特性其实可以在应用里很灵活, 你不需要类似 alter
table 语句来修改你的数据结构  
3)每次插入数据时候集合中都会有一个 ID, 名字叫 _id.  
下面再加点数据:  

    
    
    > for( var i = 1; i < 10; i++ ) db.things.save( { x:4, j:i } ); > db.things.find();
    {"name" : "mongo" , "_id" : ObjectId("497cf60751712cf7758fbdbb")}
    {"x" : 3 , "_id" : ObjectId("497cf61651712cf7758fbdbc")}
    {"x" : 4 , "j" : 1 , "_id" : ObjectId("497cf87151712cf7758fbdbd")}
    {"x" : 4 , "j" : 2 , "_id" : ObjectId("497cf87151712cf7758fbdbe")}
    {"x" : 4 , "j" : 3 , "_id" : ObjectId("497cf87151712cf7758fbdbf")}
    {"x" : 4 , "j" : 4 , "_id" : ObjectId("497cf87151712cf7758fbdc0")}
    {"x" : 4 , "j" : 5 , "_id" : ObjectId("497cf87151712cf7758fbdc1")}
    {"x" : 4 , "j" : 6 , "_id" : ObjectId("497cf87151712cf7758fbdc2")}
    {"x" : 4 , "j" : 7 , "_id" : ObjectId("497cf87151712cf7758fbdc3")}
    {"x" : 4 , "j" : 8 , "_id" : ObjectId("497cf87151712cf7758fbdc4")}

请注意一下, 这里循环次数是 10, 但是只显示到第 8 条, 还有 2 条数据没有显示. 如果想继续查询下面的数据只需要使用”it”命令,
就会继续显示下面的数据:  

    
    
    { "_id" : ObjectId("4c220a42f3924d31102bd866"), "x" : 4, "j" : 17 }
    { "_id" : ObjectId("4c220a42f3924d31102bd867"), "x" : 4, "j" : 18 }
    has more
    > it
    { "_id" : ObjectId("4c220a42f3924d31102bd868"), "x" : 4, "j" : 19 }
    { "_id" : ObjectId("4c220a42f3924d31102bd869"), "x" : 4, "j" : 20 }

从技术上讲 find() 返回一个游标对象. 但在上面的例子里, 并没有拿到一个游标的以 shell 自动遍历游标, 返回一个初始化的 set,
并允许我们继续用 it 迭代输出  

### 二、查询记录

#### 1、普通查询

在没有深入查询之前, 我们先看看怎么从一个查询中返回一个游标对象. 可以简单的通过find() 来查询, 他返回一个任意结构的集合.
如果实现特定的查询稍后讲解.实现上面同样的查询, 然后通过 while 来输出:  

    
    
    > var cursor = db.things.find();
    > while (cursor.hasNext()) printjson(cursor.next());
    { "_id" : ObjectId("4c2209f9f3924d31102bd84a"), "name" : "mongo" }
    { "_id" : ObjectId("4c2209fef3924d31102bd84b"), "x" : 3 }
    { "_id" : ObjectId("4c220a42f3924d31102bd856"), "x" : 4, "j" : 1 }
    { "_id" : ObjectId("4c220a42f3924d31102bd857"), "x" : 4, "j" : 2 }
    { "_id" : ObjectId("4c220a42f3924d31102bd858"), "x" : 4, "j" : 3 }
    { "_id" : ObjectId("4c220a42f3924d31102bd859"), "x" : 4, "j" : 4 }
    { "_id" : ObjectId("4c220a42f3924d31102bd85a"), "x" : 4, "j" : 5 }

上面的例子显示了游标风格的迭代输出. hasNext() 函数告诉我们是否还有数据, 如果有则可以调用 next() 函数.当我们使用的是
JavaScript shell, 可以用到 JS 的特性, forEach 就可以输出游标了. 下面的例子就是使用 forEach() 来循环输出:
forEach() 必须定义一个函数供每个游标元素调用.  

    
    
    > db.things.find().forEach(printjson);
    { "_id" : ObjectId("4c2209f9f3924d31102bd84a"), "name" : "mongo" }
    { "_id" : ObjectId("4c2209fef3924d31102bd84b"), "x" : 3 }
    { "_id" : ObjectId("4c220a42f3924d31102bd856"), "x" : 4, "j" : 1 }
    { "_id" : ObjectId("4c220a42f3924d31102bd857"), "x" : 4, "j" : 2 }
    { "_id" : ObjectId("4c220a42f3924d31102bd858"), "x" : 4, "j" : 3 }
    { "_id" : ObjectId("4c220a42f3924d31102bd859"), "x" : 4, "j" : 4 }
    { "_id" : ObjectId("4c220a42f3924d31102bd85a"), "x" : 4, "j" : 5 }

在 MongoDB shell 里, 我们也可以把游标当作数组来用:  

    
    
    > var cursor = db.things.find();
    > printjson(cursor[4]);
    { "_id" : ObjectId("4c220a42f3924d31102bd858"), "x" : 4, "j" : 3 }

使用游标时候请注意占用内存的问题, 特别是很大的游标对象, 有可能会内存溢出. 所以应该用迭代的方式来输出. 下面的示例则是把游标转换成真实的数组类型:  

    
    
    > var arr = db.things.find().toArray();
    > arr[5];
    { "_id" : ObjectId("4c220a42f3924d31102bd859"), "x" : 4, "j" : 4 }

请注意这些特性只是在 MongoDB shell 里使用, 而不是所有的其他应用程序驱动都支持.MongoDB
游标对象不是没有快照，如果有其他用户在集合里第一次或者最后一次调用next(), 你可能得不到游标里的数据. 所以要明确的锁定你要查询的游标  

#### 2、条件查询

到这里我们已经知道怎么从游标里实现一个查询并返回数据对象, 下面就来看看怎么根据指定的条件来查询.下面的示例就是说明如何执行一个类似 SQL 的查询,
并演示了怎么在 MongoDB 里实现. 这是在 MongoDB shell 里查询, 当然你也可以用其他的应用程序驱动或者语言来实现:  

    
    
    SELECT * FROM things WHERE name="mongo"
    > db.things.find({name:"mongo"}).forEach(printjson);
    { "_id" : ObjectId("4c2209f9f3924d31102bd84a"), "name" : "mongo" }
    SELECT * FROM things WHERE x=4
    > db.things.find({x:4}).forEach(printjson);
    { "_id" : ObjectId("4c220a42f3924d31102bd856"), "x" : 4, "j" : 1 }
    { "_id" : ObjectId("4c220a42f3924d31102bd857"), "x" : 4, "j" : 2 }
    { "_id" : ObjectId("4c220a42f3924d31102bd858"), "x" : 4, "j" : 3 }
    { "_id" : ObjectId("4c220a42f3924d31102bd859"), "x" : 4, "j" : 4 }
    { "_id" : ObjectId("4c220a42f3924d31102bd85a"), "x" : 4, "j" : 5 }

查询条件是 { a:A, b:B, … } 类似 “where a==A and b==B and …” .上面显示的是所有的元素,
当然我们也可以返回特定的元素, 类似于返回表里某字段的值,只需要在 find({x:4}) 里指定元素的名字  

    
    
    SELECT j FROM things WHERE x=4
    > db.things.find({x:4}, {j:true}).forEach(printjson);
    { "_id" : ObjectId("4c220a42f3924d31102bd856"), "j" : 1 }
    { "_id" : ObjectId("4c220a42f3924d31102bd857"), "j" : 2 }
    { "_id" : ObjectId("4c220a42f3924d31102bd858"), "j" : 3 }
    { "_id" : ObjectId("4c220a42f3924d31102bd859"), "j" : 4 }
    { "_id" : ObjectId("4c220a42f3924d31102bd85a"), "j" : 5 }

#### 3、findOne()语法

为了方便考虑, MongoDB shell 避免游标可能带来的开销, 提供一个 findOne() 函数. 这个函数和 find() 函数一样,
不过它返回的是游标里第一条数据, 或者返回 null，即空数据.作为一个例子, name=”mongo” 可以用很多方法来实现, 可以用 next()
来循环游标或者当做数组返回第一个元素.  
但是用 findOne() 方法则更简单和高效:  

    
    
    > printjson(db.things.findOne({name:"mongo"}));
    { "_id" : ObjectId("4c2209f9f3924d31102bd84a"), "name" : "mongo" }

#### 4、通过 limit 限制结果集数量

如果需要限制结果集的长度, 那么可以调用 limit 方法.这是强烈推荐解决性能问题的方法, 就是通过限制条数来减少网络传输, 例如:  

    
    
    > db.things.find().limit(3);
    { "_id" : ObjectId("4c2209f9f3924d31102bd84a"), "name" : "mongo" }
    { "_id" : ObjectId("4c2209fef3924d31102bd84b"), "x" : 3 }
    { "_id" : ObjectId("4c220a42f3924d31102bd856"), "x" : 4, "j" : 1 }

### 三、修改记录

将 name 是 mongo 的记录的 name 修改为 mongo_new  

    
    
    > db.things.update({name:"mongo"},{$set:{name:"mongo_new"}});

我们来查询一下是否改过来了

    
    
    > db.things.find();
    { "_id" : ObjectId("4faa9e7dedd27e6d86d86371"), "x" : 3 }
    { "_id" : ObjectId("4faa9e7bedd27e6d86d86370"), "name" : "mongo_new" }

### 四、删除记录

将用户 name 是 mongo_new 的记录从集合 things 中删除  

    
    
    > db.things.remove({name:"mongo_new"});
    > db.things.find();
    { "_id" : ObjectId("4faa9e7dedd27e6d86d86371"), "x" : 3 }

经验证，该记录确实被删除了  

  

