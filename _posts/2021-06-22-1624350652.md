---
title: MongoDB之——性能监控
categories: 精通分布式数据库系列
tags: MongoDB
---
转载请注明出处：https://blog.csdn.net/l1028386804/article/details/80009283  

### 1、mongosniff

此工具可以从底层监控到底有哪些命令发送给了 MongoDB 去执行，从中就可以进行分析：  
以 root 身份执行：  

    
    
    ./mongosniff --source NET lo

然后其会监控位到本地以 localhost 监听默认 27017 端口的 MongoDB 的所有包请求，如执行”show dbs” 操作  

    
    
    [root@localhost bin]# ./mongo
    MongoDB shell version: 1.8.1
    connecting to: test
    > show dbs
    admin 0.0625GB
    foo 0.0625GB
    local (empty)
    test 0.0625GB
    >

那么你可以看到如下输出。  

    
    
    [root@localhost bin]# ./mongosniff --source NET lo
    sniffing... 27017
    127.0.0.1:38500 -->> 127.0.0.1:27017 admin.$cmd 60 bytes id:537ebe0f 1400815119
    query: { whatsmyuri: 1 } ntoreturn: 1 ntoskip: 0
    127.0.0.1:27017 <<-- 127.0.0.1:38500 78 bytes id:531c3855 1394358357 - 1400815119
    reply n:1 cursorId: 0
    { you: "127.0.0.1:38500", ok: 1.0 }
    127.0.0.1:38500 -->> 127.0.0.1:27017 admin.$cmd 80 bytes id:537ebe10 1400815120
    query: { replSetGetStatus: 1, forShell: 1 } ntoreturn: 1 ntoskip: 0
    127.0.0.1:27017 <<-- 127.0.0.1:38500 92 bytes id:531c3856 1394358358 - 1400815120
    reply n:1 cursorId: 0
    { errmsg: "not running with --replSet", ok: 0.0 }
    127.0.0.1:38500 -->> 127.0.0.1:27017 admin.$cmd 67 bytes id:537ebe11 1400815121
    query: { listDatabases: 1.0 } ntoreturn: -1 ntoskip: 0
    127.0.0.1:27017 <<-- 127.0.0.1:38500 293 bytes id:531c3857 1394358359 - 1400815121
    reply n:1 cursorId: 0
    { databases: [ { name: "foo", sizeOnDisk: 67108864.0, empty: false }, { name: "test",
    sizeOnDisk: 67108864.0, empty: false }, { name: "admin", sizeOnDisk: 67108864.0, empty: false },
    { name: "local", sizeOnDisk: 1.0, empty: true } ], totalSize: 201326592.0, ok: 1.0 }
    127.0.0.1:38500 -->> 127.0.0.1:27017 admin.$cmd 80 bytes id:537ebe12 1400815122
    query: { replSetGetStatus: 1, forShell: 1 } ntoreturn: 1 ntoskip: 0
    127.0.0.1:27017 <<-- 127.0.0.1:38500 92 bytes id:531c3858 1394358360 - 1400815122
    reply n:1 cursorId: 0
    { errmsg: "not running with --replSet", ok: 0.0 }

如果将这些输出到一个日志文件中，那么就可以保留下所有数据库操作的历史记录，对于后期的性能分析和安全审计等工作将是一个巨大的贡献。  

### 2、Mongostat

此工具可以快速的查看某组运行中的 MongoDB 实例的统计信息，用法如下：  

    
    
    [root@localhost bin]# ./mongostat

下面是执行结果(部分):  

    
    
    [root@localhost bin]# ./mongostat
    insert query update delete ...... locked % idx miss % qr|qw ar|aw conn time
    *0 *0 *0 *0 ...... 0 0 0|0 1|0 4 01:19:15
    *0 *0 *0 *0 ...... 0 0 0|0 1|0 4 01:19:16
    *0 *0 *0 *0 ...... 0 0 0|0 1|0 4 01:19:17

字段说明:  

  * insert: 每秒插入量
  * query: 每秒查询量
  * update: 每秒更新量
  * delete: 每秒删除量
  * locked: 锁定量
  * qr | qw: 客户端查询排队长度(读|写)
  * ar | aw: 活跃客户端量(读|写)
  * conn: 连接数
  * time: 当前时间

它每秒钟刷新一次状态值，提供良好的可读性，通过这些参数可以观察到一个整体的性能情况。  

### 3、db.serverStatus

这个命令是最常用也是最基础的查看实例运行状态的命令之一，下面我们看一下它的输出:  

    
    
    > db.serverStatus()
    {
    	"host" : "localhost.localdomain",
    	"version" : "1.8.1", --服务器版本
    	"process" : "mongod",
    	"uptime" : 3184, --启动时间(秒)
    	"uptimeEstimate" : 3174,
    	"localTime" : ISODate("2012-05-28T11:20:22.819Z"),
    	"globalLock" : {
    	"totalTime" : 3183918151,
    	"lockTime" : 10979,
    	"ratio" : 0.000003448267034299149,
    	"currentQueue" : {
    		"total" : 0, --当前全部队列量
    		"readers" : 0, --读请求队列量
    		"writers" : 0 --写请求队列量
    	},
    	"activeClients" : {
    		"total" : 0, --当前全部客户端连接量
    		"readers" : 0, --客户端读请求量
    		"writers" : 0 --客户端写请求量
    	}
    	},
    	"mem" : {
    		"bits" : 32, --32 位系统
    		"resident" : 20, --占用物量内存量
    		"virtual" : 126, --虚拟内存量
    		"supported" : true, --是否支持扩展内存
    		"mapped" : 32
    	},
    	"connections" : {
    		"current" : 1, --当前活动连接量
    		"available" : 818 --剩余空闲连接量
    	},
    	……
    	"indexCounters" : {
    		"btree" : {
    			"accesses" : 0, --索引被访问量
    			"hits" : 0, --索引命中量
    			"misses" : 0, --索引偏差量
    			"resets" : 0,
    			"missRatio" : 0 --索引偏差率(未命中率)
    		}
    	},
    	……
    	"network" : {
    		"bytesIn" : 1953, --发给此服务器的数据量(单位:byte)
    		"bytesOut" : 25744, --此服务器发出的数据量(单位:byte)
    		"numRequests" : 30 --发给此服务器的请求量
    	},
    	"opcounters" : {
    		"insert" : 0, --插入操作的量
    		"query" : 1, --查询操作的量
    		"update" : 0, --更新操作的量
    		"delete" : 0, --删除操作的量
    		"getmore" : 0,
    		"command" : 31 --其它操作的量
    	},
    	……
    	"ok" : 1
    }
    >

### 4、db.stats

db.stats 查看数据库状态信息。使用样例如下:  

    
    
    > db.stats()
    {
    	"db" : "test",
    	"collections" : 7, --collection 数量
    	"objects" : 28, --对象数量
    	"avgObjSize" : 50.57142857142857, --对象平均大小
    	"dataSize" : 1416, --数据大小
    	"storageSize" : 31744, --数据大小(含预分配空间)
    	"numExtents" : 7, --事件数量
    	"indexes" : 7, --索引数量
    	"indexSize" : 57344, --索引大小
    	"fileSize" : 50331648, --文件大小
    	"ok" : 1 --本次取 stats 是否正常
    }
    >

通过这个工具，可以查看所在数据库的基本信息。  

  

