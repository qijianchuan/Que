---
title: 怒肝四个月MySQL源码，我总结出这篇MySQL协议（详尽版）！！
categories: 精通MySQL系列
tags: mysql mysql源码 MySQL协议 数据同步 数据异构
---
## 写在前面

>
> 最近，在开发一个分库分表中间件，由于功能需求，需要分析MySQL协议，发现网上对于MySQL协议分析的文章大部分都过时了，原因是分析的MySQL版本太低了。怎么办呢？于是乎，我便硬着头皮开始啃MySQL源码，经过两个多月的整理，终于总结出这篇MySQL协议。
>
> 注：部分来自于互联网，感谢数据库大牛前辈们的默默付出！！

## 交互过程

MySQL客户端与服务器的交互主要分为两个阶段：握手认证阶段和命令执行阶段。

### 握手认证阶段

握手认证阶段为客户端与服务器建立连接后进行，交互过程如下：

  * 服务器 -> 客户端：握手初始化消息
  * 客户端 -> 服务器：登陆认证消息
  * 服务器 -> 客户端：认证结果消息

### 命令执行阶段

客户端认证成功后，会进入命令执行阶段，交互过程如下：

  * 客户端 -> 服务器：执行命令消息
  * 服务器 -> 客户端：命令执行结果

**MySQL客户端与服务器的完整交互过程如下** ：

[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-
GkdRdRi5-1605703163469)(http://hutaow.com/images/articles/201311/mysql_protocol_message.png)]

## 基本类型

### 整型值

MySQL报文中整型值分别有1、2、3、4、8字节长度，使用小字节序传输。

### 字符串（以NULL结尾）（Null-Terminated String）

字符串长度不固定，当遇到’NULL’（0x00）字符时结束。

### 二进制数据（长度编码）（Length Coded Binary）

数据长度不固定，长度值由数据前的1-9个字节决定，其中长度值所占的字节数不定，字节数由第1个字节决定，如下表：

第一个字节值| 后续字节数| 长度值说明  
---|---|---  
0-250| 0| 第一个字节值即为数据的真实长度  
251| 0| 空数据，数据的真实长度为零  
252| 2| 后续额外2个字节标识了数据的真实长度  
253| 3| 后续额外3个字节标识了数据的真实长度  
254| 8| 后续额外8个字节标识了数据的真实长度  
  
### 字符串（长度编码）（Length Coded String）

字符串长度不固定，无’NULL’（0x00）结束符，编码方式与上面的 Length Coded Binary 相同。

## 报文结构

报文分为消息头和消息体两部分，其中消息头占用固定的4个字节，消息体长度由消息头中的长度字段决定，报文结构如下：

![](data:image/png;base64,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)

### 消息头

**报文长度**

用于标记当前请求消息的实际数据长度值，以字节为单位，占用3个字节，最大值为 0xFFFFFF，即接近 16 MB 大小（比16MB少1个字节）。

**序号**

在一次完整的请求/响应交互过程中，用于保证消息顺序的正确，每次客户端发起请求时，序号值都会从0开始计算。

### 消息体

消息体用于存放请求的内容及响应的数据，长度由消息头中的长度值决定。

## 报文类型

### 登陆认证交互报文

**握手初始化报文（服务器 - > 客户端）**

![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAl0AAAJ+CAIAAAAG2CLkAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAgAElEQVR42u3d23ajSrJAUf//T3MeenQdtwWREZGAuMz5pO2tkmWbZJHc9LMAAP/141cAALoIALoIALoIALoIALoIALoIALoIAGd18ecXvyY4ZPitDS7jDuZH1uo4SnbtJzNcDVE4aOhmSgm0Nzf//We+a7oIXxu6Bhrcsot26cDJAxg4aJTt0MXVrVrgoC46rg97Da5gHPWPL25NP4ET5ovGHRwxXxyOrJ+gtMYn6CI8eJSV54vGJ+giPGZYJceULoIuwvOHVX5Aua4fvjN0V4eYcQf7jq+tQVc+HxUAXppVvwIA0EUA0EUA0EUA0EUA0EUA0EUA0EUA0EUA0EUA0EUAuGQXfwDgtnQRAI7vovn1bfYD+GMBtPqli7oIoIu6qIsAuqiLugigi7qoiwC6qIu6CIAuoosAZ3QRAF7RUfNF80UA80Vd1EUAXbx/F5PvoXf7nye1RBdvvZz8+Rbxf5YGbP4nnbyT1vnLavt18r/P1V9C9fvu8vMa4LrYGdK9murim2fVF1lOhmveyff5lfX4rbs4v5lyqZ9XF5/Txf98d100Zp7dxa1J3oO7+PVlvtrF6/x+DHPzxf4a4d9/Bl/f2k9y9E4kA2b3pT//9zphOZl8S6ujb/g+T+ji6g/1b+P19/+Kd8YOf2OZ3/PRf5fgN5n/PQQr0uT7n9+Fq4tv72KwvObXI5M7THTx4vO/o5eTxl8hmC9+vuy3uhhvN2w9ufq2h7/Gvf4uux9fjNeWO75PXdTFA+eLuvjaLh66nOzbxSCQk10cTtFmft59u3jE+5zcUKjmShd18fZdPOF8PF18QBeDqWdp4RkeX/z9Ul+cL67+vEd3ca+/iy7qoi7uNg+4byF08QrLyczxxV3e545dbE92T+7iocuJLuqiLuqiLh7exR3Xm7r47C6Koi6Wzx9rn981uR9MF+/VxUOXk/ZO+PwKcbj/dvjO21PY4flKmbwFL1I9vlgav43zhIMnZ/YnB7//3t9X7XRRPPxofplYDtFFy5kfzS8TLIe6eMIv6PG3QTeELCdYDtFFdBHgrC4CwCs6+q354jkf19I+Vf3u8y3zRTP+L46L9hUFllvuNF/8eheTp4DHX//9s8zfI/9nmy6yupAs6ZsozdwKeHhy/6Hjor3Va6FFF8sjp3HB7+qa4uuTUV1857Rv9bPShlcHDq+ci7M3vDRw93GxrH2gRP5SUWeaoItTXRzut2nfwVkX+VYXS58oNN/F08bFHccRunhSF9t7lvJNrY7/nxxdZMcuxpmMP7wpGE1LZT/qmeOi8V0sP5gvFrZh41siZdJbvVfTvcazdcqlBuSfRTH5Z2osS8kjiMeNi/hOeLfbvkQXL9rF4e0Bk58Umlwl/X6m+4Zz3HwxOdxKQ+/r46LXcvNFdHG8fyl/isH54/+nQhcNyM9Fa3gSyuq/zZ+ukv98xH272NuaNF9EF1NdXNIHEZM3+0+O/8YBGPNFGst55jhi9dMwkpO5g8ZF5uMv4g/BMF9EF3/yDxpdjB9Mzkev3x7rlEsNyM/ji3Fgqp1YPap3l3FhvogujnfgzH9cdWP8Nz4C1Hk3TM4XS3sjgoUwOWZPGxeWW3RxnwEw3HVZPRayJK7o+nxa/tjMlce29cvdu5hJVOMUnhPGRXU/avw2LMm8t4vJ2iXP7iuN//w27773BNHFN3dxqR+6Tl56sXSvX9xrXOTPiYvfRvvmA/CuLlbH3tYU89D7husiwUKeP7Gz+sXq/W4OGheTXczvQIIndzFz8L+0Kb31gqVLqns/0UXGsFXJpf4Kf1pYusooX9B2F/cdF8n9qJnLTixCvLSLpcMJmbMMtk7MK92wqvfDXmckW6dcc7KYn0LlF9TkftTTxkX12mK4axcB4BUd/dZ8EfNFgBvPF3VRFwF0URd1EUAXdVEXAXRRF3URQBd1URcBdFEXdRFAF+e7CAB3pIsAcHwXzccBsB9VFwHQRV0EQBd1EQBd1EUAdFEXAdBFXQRAF2e7CACv6Kj5IgDmi7oIgC7qIuw62DKjpnobKgMNdBGeOdL+PCE5ggw00EW45UxRF0EXDVf4/261uxh8fWu/a+brRijoInwtisvE8cV4Hvn5ssm+AroIX4viEfNFXQRdhPuNrvx+yx27GEw97UQFXYQrTh9Pmy+23w/ooi6CLoKhqotwmS72ziNN7i91MiroIryxr4Augi4CuggvG6iGFegiADyiiwDwio6aL0JvC/S0Vx7eptzYhC/MF3WRBw+Y34f6kje1yV9T+PlSw4s0tr6y+k3jN2/Ygi5Cc3K2Oi2LUzQs0OrtwvP3EE++h0xTPyMavxTooi6ii6kuJid5k11cfWPDb12afSZfAXRRF9HFcSb/7BSNB05yP2rQwuTBxfkuSiO6qIsYMH+PLyYL0RgUwZHC+KZxw3eeP76oi+iiLkJnvpgcDqWhkYlucD5qvprJ96CL6KIuwriLw/t9r/7b+M7gsa33kzktVhdBF+Hw+WLmOGLmczBWp335Yg1nmfGRy+T8UhfRRV2EzTnZVhczE8Hk8Ik/WyqYRK4GLH95iS6ii7oIU/PF4Xk3w5yUdoHmy3pcFw1zdFEX0cVOF5NX0O81sobXkwRz2dVZ6dZU1SKBLuoiujjuTaOLq6EKvhikK35j+VvkgC7qImSjWJovlu7W9vl464vJ29noIugiHNvFPy2s3nF02ek+cJk9scFRycYJQaCLughR3pbWaSl73Qdu8p0Dp3YRAF7RUfNFAMwXdREAXdRFAHRRFwHQRV0EAF0EAF0EgC90EQDuSBcB4Pgumo8DYD+qLgKgi7oIgC7qIgC6qIsA6KIuAqCLugiALs52EQBe0VHzRQDMF3URAF3URQB0URcB0EVdBABdBABdBABdBABdBABdBABdBABdBABdBABdBABdBABdBICHdBEAXtFR80UAzBd1EQBd1EXYY4Alh8PP/8p/C79n0EW4x+gqBaz6fF0EXQRd1EXQRXh3F4Ovb+13zXzdCAVdhO8MsMnji3FfP1852VdAF+FR80VdBF0EXUx1MZh62okKugivni8mvx2gi6CLgC7C6QNs/rr++DzS5P5SJ6OCLsLzp6GALoIuAroIrx+ohhXoIgA8oosA8IqOmi9iW3L1P7cW+NWvN0ZH6fWrL2W0wuHzRV1EF4ddTN7sO//6w8s5hg8AXYRvzhdX7w++9YkZW5c2Dh+v9nj4ZNBFXYRCF//UJbg9TfARGZ9f3JpKZjqdTN3wlqr+yuiiLkJqkf4Tj9/L+WrPlsrxxWRo4/cTzGu3pp4mjqCLsMN88bNepQR+zs/ie7wNjxou3f2ougi6CId0cfj8zJk1W3tWg1lgsotbM1FdBF2E2S6u7ket7jJdRufdDGv3OeMc9jtOr2ELugjNMbNalOCqieR5N6u1C16keopp/roR0EVdhFoUl8pFgfEO0iVxpusyOn+1et6NLoIuwm5FjCvY6+LWTHT1JJ1MNYO3VP3YZNBFXYQlTku7i8Hz8+VLdjEzf9VF0EXYoYvtDg1nfsvGbtXJLsbfy5gFXYRju5jZBZrs4lI5tXUZ3X8nnqqCLuoiZIvYzlh8THFJHICMOx3cE+Dz2zXuHge6qItQiNBqh4K5ZjKoyfuGD4db/h8auRjmPpcYALodNV8EwHxRFwHQRV0EQBd1EQBd1EUA0EUA0EUA0EUA0EUA0EUA0EUA0EUA0EUA0EUA0EUA0EUAeEgXAeAVHTVfBMB8URcB0EVdBEAXdREAXdRFANBFANBFAPhCFwHgjnQRAI7vovn4jfYb+CWA8YXjixi3YHyhixi3YHyhixi3YHyhixi3YHyhixi3YHyhixi3YHxx0S4CwCs6ar5oexYwvswXddG4BYwvXbx/F5PvoXf7nyct68btoQMsuVxZDnXR+lAXr/Kz/Xla718Zt0wuV5ZDXbQ+1MXDF0TLgS7qIsaX9aEuzv5F//1n8PWt/Qy927Ebt1aO5yyH7U8M4AHjy/pQF2vLwerfL95u+nzx3naWcWvNeM5y6K+si9aHunjU9pEucsfl0F9ZF60PdfELy8FN91NZY17hd3vCcmgnqi5aH+riN7ePjFtqo+vc5dAfXRetD3XRcmAVeenfqi5aEqwPdfHwHyw5f0+eTxXsKFh9vnFrbXip5dDJqK8dX9aHuigefjQrWfzJ/FC6aDnwo1nJ4k/mh9LFM/c/GLdYDnnz+HrP+lAX0UUwvji4iwDwio5+a764+mq7n49+3xs02J59/G9y8qqP4SvMvHPLzwV/P+3VY2k5eeqh03vsR53p4nLwjeSN26cOjN+HUpIXXczcgnJ4Evzq07bOp/98P8G9Lj//b+kiE8vPNcdX8q68k9tPpfXwLS4Wul8Xf7YNnzD8q5SevIxufVRdUJJf18WTVyirn9GztTw0lpxhwyb/7+frT25lWn6u+ftprPdW/1f8/OTS3lt/6uJJ88WZOeXkdtPunyt03MJkvTbfxXiSd1oXg7XVETPd6qakxenr3yXeTspvPOWnCrdb7dyyi6UReFAXM8vEQV08YnmyCst3Mc7knz4l65L/4tYHzGa24ZJzXMvPHbvYjmJ+4y8eAo3Zgi7utnOgtFIoPTPe4q528c8LDhfNreeXZiG6eNAuqdJ4biz8mY+Cml+/5Nd61fmf5ec646sxd09u5Q93t2aO++jil+eLpf1FQcbyfd3ankoe7xl+XRevMF9MLvalIZDZPZXvYnDIJ7MZNzML4YK/n+qOq+T6s/pR27p4eBcz3cof+fjM0sx8Mb/XPplDXbxIF4f3U870pnd8bngGRH5mmXz9zP4VRxavP77yUUwuh6VX3jq+cPGl5V3HF5PFmpkvDrfiM8+PX0cXvzhfzBxHzHzOQLA5FT8hM5HtHecOfkyLx03HVyld1ZVecmNu+E508bz5YmMDZ9/ji0v9nEPn3VxtYHweX4w3nhqH5fI7M0tdHO5HjcOfvLTD8nOd8dXYDxEfOE8eX0xuUeniDeaLwy42KtjonOs0bjpfnL8hSLyd3jtvPr8c5veX9M7atzhdf75YXQsFO8CCoaGLh3exd5L6QfPFzKQhOY90Xf+Tuphfm1RH0C5dzCzMw9qVdn6w3Op+N6U9BNX7LiUvOtLFchGr96/JN/LM81yM25t2cdnpLlkz94HbemPBDpXSmm44ZJKTSAvVHbuY+XowU0xu35svHvLXTc4CdVEX538b+flib0rXuN/N0joftbF/vlE+XXxkF4Njk/ajXuLzF3c5/te4tOPZn09t5RXs/FnqJwnnC3rc/VGT19GW3n/mpESL0NfHV+mi2/x+iHgBWyq70698qvP9uphc0WSuu9IGP3t+H0Njp8Uu94H7XI+0DxDG38KIeNj4mrknQ/sOSrWcvO26fgB4xXbP1+eLmC+C8cX95ou6aNwCxpcu6qJxCxhfuqiLxi1gfOmiLhq3gPGli7po3ALGly7qonELGF+6ON9FALgjXQSA47toPg5X2M8DOL4Ixi2gi2DcAroIxi2gi2DcAroIGF+gi4DxBffuIgC8oqO2Z8F8EYwvXQRdBONLF6/6B0v+enu3NfKH00Xjy/iyGOjibf5apQFWfb5xq4vGl/GFLhq3xq0uYnyhi08cxvlxG3x9a79Q5uv+4rpofBlfumjcXnfQBoMq3s79fOXk+EcXjS/jSxeN2+sO2sb2rHGrixhf6OJjB+2+4zbYNLaTRxeNL+NLF43bGwza47Znd3lv6KLxZXzpIqcOWuPWuMX4Qhdf8dfK71pJnv8W7NhZfX7yRdBF48v40kXj9hWbyegixpfxpYvGLbqI8WV86eLT//D+TLqI8YUugi4Cp3cRAF7RUduz19miOe3FfYaO+eJ7lv/JqzWGrzDzznf5qc/51d16+bQf9RJ/gN+HIpIni+evefp8qeHrt29M5Y+ui3df/reetnU9RpyEuJrD1z9ofB208LS3p3WRwRZWZtnKjNhgiA4364L3MBzV1YvAeHkXr7b8t//v5+tnBtcRPWsM0ngTYfWXP9PFiy+9uni/9UJ+Ca6uFzI37DhnexZdPH/5L/3fIC1HzHTzPdtxTlnaRTy//1kXGa8X4tXEn/G5136k/Db71s/i766Ld1z+twpXWpsHQ2CX/SiTBzLyu3Ma64Gt3eD5+aUusjluS5Oz9jbacDxUd40+5pC7Lr55+Z/ZWZJ5hcyMc2ZOVt2dU3r+cPtj98zrovliYb71uZ3b/naT42Hrnfvr6+Idl/94t2R8E9TkYYiZmdPXuxjfD7b6rnSRwnohufzF423H4+357cTMKgBdvOzyv/qV6kQwSEjpDJfGnpu99qNWJ77xXFwXrRP32V7OHEfJ3Kc/ntUl/3bJLWtLgi7eevlffQPBP5zZrZI5mDr5+9z3r7P1n5mzcHXR2rDzB/g8vhIvZI3DEsmZXH6lcK8FXRct/8PfXqOLw/2ocfiTl3ZU01uddPauu8hfzXW71YUuXnp7ef6oeJzArZVFtYuNIYEuXm35j18n/wbiQCb/b3t89T73+Pwuuk6D/dcLmb067f2cyRGbuSDMYqCL91r+d+li5vrF/GXE1fFVOgM2+O0lPz95l3jrIuP1wrLTqWWT94HLX+OcfBF08eLL/9ZXevtRt955ZrK11/iqbtru9ae879jXxausFErby71N2sZ94EonpOmiLj5g+S9dpzEzavJfvF0X7767SBcvsV74sy5ojNsd74O1jG7bkdnxYgHQxZsu/43/G890S2d1Bk9rj6/GftT2MvmMWyXr4rU2lhsDdUlcX9jYj3rfe/7qouV/ZvlfzfPwrZYugT95QDUuzTriu5gvAsA7tlPNF8F8EYwvXQRdBONLF0EXwfjSRdBFML50EXQR0EXQRUAXQReBL3QRAO5IFwHg+C6aj99ov4FfAoDji+gigC6iiwC6iC4C6CK6CKCL6CKALqKLABftIgC8oqPmi+aLAOaLuqiLALp4/y4m30Pv9j9PaokuAjy/i/n38OdpvX+liwC6eN0u/ue766IuAujibOH+/Wfw9a39rr3bsesigC5eq4urPYvnkZ8v3pt36iKALt57vqiLALqoi6kutj/ZUhcBdPHh88V7LQcGA4Au6qIuAryji6X9mcnzS4Mdp6vP10UAXbzWfFE8/GgAuigefjQAXTzyF/T426DrIoAuoosAZ3URAF7R0R17m7w6Ip7TxN+lPQ3aa/6UeZ0rXO9hvghw7Hzx5C7umNJ9U7F7F39GdBFAFwsJDF48o5qTZBfz3/egWw3oIsCFuvhnzhfcbiboRKaL8Txs+DjZ6fmy5r9p5gfszVkBdPGkLq6m4vfzt3aNTh5f7D2zNHltPO2ELu41rwXQxZPmi58zv3wtkrOx6q3ghlO9Xbr4Z2sg+X0bxxd1EeDeXcxM6TJnmuR/tq/MFz9nycM3YL4I8PAuru5HLc0XV6eb1fNo5rtY/b5bR1V1EeC9XQwKsTU7bJx3Uz3xZJc9k8vap23EXW/sv9VFgId08U8Ukw+2plPDHuwehupsuPQ6u1+/qIsA1+3iZxGHDZvv4pI7H3Wv2AzTHr9D12kAvG6+uFcXZyrS++6lDg3DvPoOd+yi6/oBbtnFeNoUzxczSWtf/j+5f7XRrdIZtr2rR3QR4PZdXN2xmbwVwOolgMM4lX81udvZZO7rVjoJVhcBbt/F4BKF/HxxWLule5hzaz56RG+CjYPS5DJ/5q0uAlxxvjjcsZkpa3U6NXzDw3vXHdTF4JLNrX7v2zZdBDi2iwDwio4e1Fu+vn3klwCwfPe8G3QRQBfRRQBdRBcBdNHvVxcBdFEXdRFAF3VRFwF0MX5d7m75uLeAxx577PHzHic/RkkXMWY89thjXbQfFQD7UXURAHQRAHQRAHQRAHQRAHQRAC7VRQB4RUfNFwEwX9RFAHRRF6E4nFYHQnI49G5DZaCBLsI9xlL8n8PCJUeQgQa6CBedKeoi6KIuQipsmRGx9c+Dr2/td8183QgFXYTvdHF1Nrk1aj6jVZ2GJvsK6CJ8oYv5LFXni7oIugg362Iw7Tu0i8HU005U0EX45nzxK11svFtAF0EXAV2EwwbS5H7L5PmlwY7T+Ps6GRV0EZ4/KwV0EXQR0EV4/UA1rEAXAeARXQSAV3TUfJGXbDAmv9h+2tK9UThwy/miLvLaLrYLasiALsLVu/izbfiE4H5smX+byW31fJzG529YGNBFXYT+fHFmThn/2/z9wavT08nb9IAu6iLv6mJyMndoFzOdPqiL0ogu6iKGxP/0L9+J0jPjPbHVLv55wWH/tp6f/+6gi7qI+WLt4F+ctOBjEatdjD/o8fPrW8+vbgeALuoiL+1iplv5k2g+szQzX9ya9m19MZ9JXUQXdRH688VSnKodGk46l9GnIgfPH35+srGMLuoiBkazE/E/XH3mLscXS0mOw6yLGP66CMfOF4ddbFSw0TnXaYAuwtTAaJyHctB8MUjj6ucPZxo/fB1RRBd1Ef4WsXr/mnwjnecCugi3GRW9WaAugi7qIm/PZLumjfupAroIl4viavPi+9q4iQzoIgC8o6PmiwCYL+oiALqoiwDooi4CoIu6CAC6CAC6CABf6OLq/Ts89thjjx//mLvTRY899thjXeT4LpqPA1gZ2o+qiwC6qIu6CKCLuqiLALqoi7oIoIu6qIsAuqiLugigi7o420UAeEVHzRcBzBfNF3URQBd1URcBdFEXdRFAF3VRFwF0EV0E0EV0EUAX0UUAXUQXAXQRXQTQRXQRQBfRRQBdRBcBdBFdBNBFdBFAF9FFAF3kIV0EgFd01HwRwHzRfFEXAXRRF3URQBd1URcBdFEXdRFAF9FFAF1EFwF0EV0E0EV0EUAX0UUAXUQXAXQRXQTQRXQRQBfRRQBdRBcBdBFdBNBFHtJFAHhFR80XAcwXzRd1EUAXdVEXAXRRF3URQBd1URcBdBFdBNBFdBFAF/lCFwHY8ntV6fF3H6/+dXQRQBd18eAumo8DYD+qLgKgi7oIgC7qIgC6qIsA6KIuAqCLugiALs52EQBe0VHzRQDMF3URAF3URQB0URcB0EVdBABdBABdBABdBABdBABdBABdBABdBABdBABdBABdBABdBICHdBEAXtFR80UAzBd1EQBd1EUAdFEXAdBFXQQAXQQAXQQAXQQAXQQAXQQAXQQAXQQAXQQAXQQAXQQAXQSAh3QRAF7RUfNFAMwXdREAXdRFAHRRFwHQRV0EAF0EAF0EgC908dPv/+Wxxx577LHHV3i8Witd9Nhjjz32WBcP7qL5OAD2o+oiALqoiwDooi4CoIu6CIAu6iIAuqiLAOjibBcB4BUdNV8EwHxRFwHQRV2Ew0Zd9XZTBhToIjx21DWCZ0CBLoIu6iLoItxzFOX3i251Mfj61utnvm4kgi7Cped/W9GKX+fzZZN9BXQRrt7F0nxRF0EXQRdTXQymnnaigi7Cq+eLyW8H6CLoIqCLcOEu9s4jTe4vdTIq6CI8P7eALoIuAroIrx+Qhg/oIgA8uosA8IqOmi/y+bde/c+tBWD1642lpfT61ZeqvsheP1Tj5z3zFa7zs+zy4vN/d8wXdZFju5i8KXb+9YeXPQwflBb4P98ruB/NXmv84esH91+dXGsMfbHQ7Ss7rbXQRS43X1xdj299ssTWJYD5KvzucT4hmR95x7uVBj918gc8dL2/41y/tB1Q7fTWxkom7dZmuqiLdNZxf9bUwW1cgvXO5xe3ppKZlWly1Vaah2X+s3Fr097MMq7vCfOh2uqjMi/P/+Z3nB2WFhJ0URcZrNn//N1XC7FUDsUlQxu/n2Ct2piEBZPgXTrXnqHmV/E7Dsxqd+OJdXXzYmsBa+yl6O0nQBd1kfIqu5TAz4rE90IbHjVcuvtRG11M/k52nJc3Nj4Oej+Nr+e3Nkq/5CO2SHRRF3WR/acy8fpxeM5InIHVlWOyi1uzrkt1MTkTrR4Mmxyejflx8m+RfJMzP2P7pCHrNF3URQpdXN2PWt1luuROXcnsHS3NUYL0XmQ/an4SmT9H6YR3lf/lt085ng//V3ZBo4u8YhlaLUp83mC+i5/F3XqR6imm+eNb+Rc5beG/wvmoS323bft8qCNmw7qILnJgFJfKRYHDScPwTNdldP5q9byby3axvfv0Cl1M7h7oFat33YUuooucUcThKq/Rxa2ZaFCIxnk3pYQkz4bdd1dq6YrJE7q4yw/b/gDnr8wXrdB0URfZc5WdWc1tPT9fvmQXk8cO2yd9DM+S3feXXDo+Fx8fPW2+mPwdxvvP97rWcHhlkSjqoi7SX8G1OzSc+W2tvya7GH+v9uo+Pvd1/n4rmVX5lbt4kfvAJefc6KIucmAXM7tAk11cKqe2LqP77yTzllzmk92qvnh8fDHThoPu5zK53/I6XQRdZIe1Tztj8THFJX02f7KLy8d5rcvGfsjSBKJ0j9a9VvTVm9AOf3ulQ3ft81xOWC30NmiMZXSR/TfM47NRenOarUBm7hue7FnmHx53X+yDJkZXO0J29EWckz+pNRUndREAXtFR80UAzBd1EQBd1EUAdFEXAdBFXQQAXQQAXQSAL3Rx9fprjz322OPHP+budNFjjz32WBc5vovm4wBWhvaj6iKALuqiLgLooi7qIoAu6qIuAuiiLuoigC7qoi4C6KIuznYRAF7RUfNFAPNF80VdBNBFXdRFgKd0Mfk2erdDe9IKXxcBnt/F/Dr5z9N6/0oXdRHgus34d09zXdRFAF2cKty//wy+vrXftffxFLoIoIvX6uJqz+J55OeL9+adugigi/eeL+qiLgLoYqqL7U/61UUAXXz4fPFefy9dBNBFXdRFgHd0sbQ/M3l+abDjdPX5uqiLALefOb3th9JFAAnxQ+kigIRMBOPxq3ddBNBFju8iALyio+aLALvPF5NXR8SvGX+j0qUUjdd/zPzYflSAR3Vx+FLDF9dFXQR41Hxx9dU+q1l68SV3s7dA6dXyoYWgeK0AAAHnSURBVMl/jkfpZXUR4BJd/FOvIHXBR14kZ3vDj84odW5mO2Cp32d8r/vy6CLAhbq4Gpvf68+tjxTule/Pd1n9h/nPlmp3MfPmD+pi8pV1EeAq88XVGVs+LcH8b2smuuQ+ZHgJ969O7kH9fD+Zz0MePr/0U+giwD26OHx+vG9za5dsfKBx6/Uzx+16M7bhnuTkj9ObausiwBW7uLoftTRfjCdVq99umf4M4R27OJzODp8f/2i6CHCbLgZ7O+PZW2aW2biu4/wuxoc2469sbUnoIsD9uvh5Lkz+osNgCrWMdoEmo5vZj7rv8cX8fHG4TaCLAHfq4urZoaWZX9y5fE5mvrJa1lIFG51znQbAY+eLe3Vxl+c3GrYa5sbVGvHO4aDBrusHeHIX412Iw058Pj9zH5ytRC3dE0qX294QThcBbtbF1aN38fUJwXG+eC9ocg4avP/btUAXAb7Zxd7levGc7zNU7XvcLOF5N6Ubn+qiLgKk5ovD+5o27kf6eSlk0NGl+Nka1Q+0Ml8EgNds95gvAuw7X+QV80VdBNBFXdRFAF3URV0E0EVd1EUAXdRFXQTQRV3URQBd1MX5LgLAHekiABzZRQB4xX5XvwIA0EUA0EUA0EUA0EUA0EUA0EUA0EUA0EUAOMz/Ab4AvanPvWzMAAAAAElFTkSuQmCC)

**服务协议版本号** ：该值由 PROTOCOL_VERSION
宏定义决定（参考MySQL源代码`/include/mysql_version.h`头文件定义）

**服务版本信息** ：该值为字符串，由 MYSQL_SERVER_VERSION
宏定义决定（参考MySQL源代码`/include/mysql_version.h`头文件定义）

**服务器线程ID** ：服务器为当前连接所创建的线程ID。

**挑战随机数**
：MySQL数据库用户认证采用的是挑战/应答的方式，服务器生成该挑战数并发送给客户端，由客户端进行处理并返回相应结果，然后服务器检查是否与预期的结果相同，从而完成用户认证的过程。

**服务器权能标志** ：用于与客户端协商通讯方式，各标志位含义如下（参考MySQL源代码`/include/mysql_com.h`中的宏定义）：

标志位名称| 标志位| 说明  
---|---|---  
CLIENT_LONG_PASSWORD| 0x0001| new more secure passwords  
CLIENT_FOUND_ROWS| 0x0002| Found instead of affected rows  
CLIENT_LONG_FLAG| 0x0004| Get all column flags  
CLIENT_CONNECT_WITH_DB| 0x0008| One can specify db on connect  
CLIENT_NO_SCHEMA| 0x0010| Do not allow database.table.column  
CLIENT_COMPRESS| 0x0020| Can use compression protocol  
CLIENT_ODBC| 0x0040| Odbc client  
CLIENT_LOCAL_FILES| 0x0080| Can use LOAD DATA LOCAL  
CLIENT_IGNORE_SPACE| 0x0100| Ignore spaces before ‘(’  
CLIENT_PROTOCOL_41| 0x0200| New 4.1 protocol  
CLIENT_INTERACTIVE| 0x0400| This is an interactive client  
CLIENT_SSL| 0x0800| Switch to SSL after handshake  
CLIENT_IGNORE_SIGPIPE| 0x1000| IGNORE sigpipes  
CLIENT_TRANSACTIONS| 0x2000| Client knows about transactions  
CLIENT_RESERVED| 0x4000| Old flag for 4.1 protocol  
CLIENT_SECURE_CONNECTION| 0x8000| New 4.1 authentication  
CLIENT_MULTI_STATEMENTS| 0x0001 0000| Enable/disable multi-stmt support  
CLIENT_MULTI_RESULTS| 0x0002 0000| Enable/disable multi-results  
  
**字符编码** ：标识服务器所使用的字符集。

**服务器状态** ：状态值定义如下（参考MySQL源代码`/include/mysql_com.h`中的宏定义）：

状态名称| 状态值  
---|---  
SERVER_STATUS_IN_TRANS| 0x0001  
SERVER_STATUS_AUTOCOMMIT| 0x0002  
SERVER_STATUS_CURSOR_EXISTS| 0x0040  
SERVER_STATUS_LAST_ROW_SENT| 0x0080  
SERVER_STATUS_DB_DROPPED| 0x0100  
SERVER_STATUS_NO_BACKSLASH_ESCAPES| 0x0200  
SERVER_STATUS_METADATA_CHANGED| 0x0400  
  
**登陆认证报文（客户端 - > 服务器）**

**MySQL 4.0 及之前的版本**

![](data:image/png;base64,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)

**MySQL 4.1 及之后的版本**

![](data:image/png;base64,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)

**客户端权能标志**
：用于与客户端协商通讯方式，标志位含义与握手初始化报文中的相同。客户端收到服务器发来的初始化报文后，会对服务器发送的权能标志进行修改，保留自身所支持的功能，然后将权能标返回给服务器，从而保证服务器与客户端通讯的兼容性。

**最大消息长度** ：客户端发送请求报文时所支持的最大消息长度值。

**字符编码** ：标识通讯过程中使用的字符编码，与服务器在认证初始化报文中发送的相同。

**用户名** ：客户端登陆用户的用户名称。

**挑战认证数据** ：客户端用户密码使用服务器发送的挑战随机数进行加密后，生成挑战认证数据，然后返回给服务器，用于对用户身份的认证。

**数据库名称** ：当客户端的权能标志位 CLIENT_CONNECT_WITH_DB 被置位时，该字段必须出现。

### 客户端命令请求报文（客户端 -> 服务器）

![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAp8AAACRCAIAAAAKH0QGAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAFdklEQVR42u3c266bOhRAUf7/p+lDpagNxrGNjW9jPG3tk1O1CcsTE5LjBADWcngKAEDdAQB1BwDUHQBQdwBA3QFA3QEAdQcA1B0AeLnuBwDQiboDgLrn1N0Vj+GuwHhRAFZf59Vd3QFQd3VXdwDUHXUHQN1RdwDUHXUHQN3VHQB1P31XHQAseDZg727vDsDWe3d1V3cA1B11B0DdUXcA1B0vCoC6q7u6A6Du6q7uAKg76g6AuqPuAKg76g6g7uqu7gCou7qrOwDqjroDoO6oOwDqjroDqLu6qzsA6g4ATHw2YO9u7w7A1nt3dVd3ANS9Z8yO/y1cSnVntDVoh7kDde/zL/x6WNn/pe7w5GhceO5A3SsvHOpuZUTdQd2X2rs/r3vk93dXFAuuNKo7K60p6cf/C3NXdvEf1H2dugeXgPje4vqHl+1F1J099+Kt587Rjrqre94eQt2hSt2bzp2jHXVX92qrzOBXAq13LFn3yGUAl+VRd3WvvIcYf/2F9fbuDn5MorqrO6g7qPs8dc+6Qp54L27kkmDw8eqOunecOzfMo+7L7t2lUd1x0IK6q7u6g4MW1H31ui92Zc9CibkDdVd32yAA1B0AmOhswN7d3h2Arffu6q7uAKg76g6AuqPuAKg7XhQAdVd3dQdA3dVd3QFQd9QdAHVH3QFQd9QdQN3VXd0BUHd1V3cA1B11B0DdUXcA1B11B1B3dVd3ANQdAJj4bMDe3d4dgK337uqu7gCoO+oOgLqj7gCoO14UAHVXd3UHQN3VXd0BWLvuAMD71B0A1B0AWOZKvqcAANQdAFB3AEDdAQB1BwDUHQDUHQBQ937/quNo+nigeIiujzSAoO7qDkNP3N00fX4f+QF4r+7TDd7fv3DuTmLSfyYMeCjGA3+dOAczVF/nn9Z9tLHMXTJGXmKePPOWS147SnO/EDt4NlD2Tdqwdr+71X38HKY8cZMGfqLXBYtU5AzAJh6zM1bdh5rDf1eK69oR/KverSmzBH6K14U9d+13G/HglXl1hxbreWHdxxnCxEt5Xw8LLjpzBX7w14WdF6b4wfn1g7pDiyX9qDW6wXP5YTcctR7WaA9U9ipM/bqwxpJ0dxt8/FKZm+fZYVKqrPMb7d2DT9yZcJ9Owd1A9u4QaXbKNbDILx29mKb+dT/He989slJk/VW97w6J59PBrgeTHz+NVncMVPX1fJF75mvV3T3zUCX5iXPqoIXh7pkfaiaL6+7z7tCi6z/fQVR3OPt+3n2ixeX6IdqUK36uCkLd/XrkTpdI2s0g1JzN9U5/Cu7CtaxAu9gnng0YQ1D3vN63eDzw1eyfQ/Tz++mMIai7usMQRS/7Aom7/bpJBHUHANQdANQdAFiw7t4GA4AOhe74bTYAgLoDAOoOAOqu7gCg7uoOAOoOAKg7AKDuAKDu6g4A6u6baAFgwTMDTwEAqDsAoO4AgLoDAOoOs81e8t2wiY/8ephPu4C6Ay+F/PPz9Ye6JwHqDupeZ4cBpAc+XvfjnrrDhuvG23W3gsCTut9N0PPfm02Yvd/d6m75gEbjk7t3/5wr5O74gUlXiVZ1t15Awegmpjdr7oJ/iAmF2QPfoe4WDsid27tL8c/fd7/+3pYdFgj823WPnGW4GAjxUUqve9Y8qjsMPv4FV+zs3WGmHXz6dvzng4M33qfctQfYu3vfHWrWve7eXd1hybSf7pmHkYf2a8NdcPEtZdAiX5JjTmHGtJ8+7w4TTW/uh9yCgxZ/9/36h5tTmC7tzesO1K17fIAjb6VHduSRt+SdiMOOy46nAMav+8//6vPugLrDEHW/XjYv++obdQfUHUYpfcUGqzug7gCg7gCAugMA6g4AqDsAoO4AoO4AwHz+AE1F3RdUxr4qAAAAAElFTkSuQmCC)

**命令**
：用于标识当前请求消息的类型，例如切换数据库（0x02）、查询命令（0x03）等。命令值的取值范围及说明如下表（参考MySQL源代码`/include/mysql_com.h`头文件中的定义）：

类型值| 命令| 功能| 关联函数  
---|---|---|---  
0x00| COM_SLEEP| （内部线程状态）| （无）  
0x01| COM_QUIT| 关闭连接| mysql_close  
0x02| COM_INIT_DB| 切换数据库| mysql_select_db  
0x03| COM_QUERY| SQL查询请求| mysql_real_query  
0x04| COM_FIELD_LIST| 获取数据表字段信息| mysql_list_fields  
0x05| COM_CREATE_DB| 创建数据库| mysql_create_db  
0x06| COM_DROP_DB| 删除数据库| mysql_drop_db  
0x07| COM_REFRESH| 清除缓存| mysql_refresh  
0x08| COM_SHUTDOWN| 停止服务器| mysql_shutdown  
0x09| COM_STATISTICS| 获取服务器统计信息| mysql_stat  
0x0A| COM_PROCESS_INFO| 获取当前连接的列表| mysql_list_processes  
0x0B| COM_CONNECT| （内部线程状态）| （无）  
0x0C| COM_PROCESS_KILL| 中断某个连接| mysql_kill  
0x0D| COM_DEBUG| 保存服务器调试信息| mysql_dump_debug_info  
0x0E| COM_PING| 测试连通性| mysql_ping  
0x0F| COM_TIME| （内部线程状态）| （无）  
0x10| COM_DELAYED_INSERT| （内部线程状态）| （无）  
0x11| COM_CHANGE_USER| 重新登陆（不断连接）| mysql_change_user  
0x12| COM_BINLOG_DUMP| 获取二进制日志信息| （无）  
0x13| COM_TABLE_DUMP| 获取数据表结构信息| （无）  
0x14| COM_CONNECT_OUT| （内部线程状态）| （无）  
0x15| COM_REGISTER_SLAVE| 从服务器向主服务器进行注册| （无）  
0x16| COM_STMT_PREPARE| 预处理SQL语句| mysql_stmt_prepare  
0x17| COM_STMT_EXECUTE| 执行预处理语句| mysql_stmt_execute  
0x18| COM_STMT_SEND_LONG_DATA| 发送BLOB类型的数据| mysql_stmt_send_long_data  
0x19| COM_STMT_CLOSE| 销毁预处理语句| mysql_stmt_close  
0x1A| COM_STMT_RESET| 清除预处理语句参数缓存| mysql_stmt_reset  
0x1B| COM_SET_OPTION| 设置语句选项| mysql_set_server_option  
0x1C| COM_STMT_FETCH| 获取预处理语句的执行结果| mysql_stmt_fetch  
  
**参数**
：内容是用户在MySQL客户端输入的命令（不包括每行命令结尾的";"分号）。另外这个字段的字符串不是以NULL字符结尾，而是通过消息头中的长度值计算而来。

例如：当我们在MySQL客户端中执行`use hutaow;`命令时（切换到`hutaow`数据库），发送的请求报文数据会是下面的样子：

    
    
    0x02 0x68 0x75 0x74 0x61 0x6f 0x77
    

其中，`0x02`为请求类型值`COM_INIT_DB`，后面的`0x68 0x75 0x74 0x61 0x6f
0x77`为ASCII字符`hutaow`。

**COM_QUIT 消息报文**

**功能** ：关闭当前连接（客户端退出），无参数。

**COM_INIT_DB 消息报文**

**功能** ：切换数据库，对应的SQL语句为`USE`。

字节| 说明  
---|---  
n| 数据库名称（字符串到达消息尾部时结束，无结束符）  
  
**COM_QUERY 消息报文**

**功能** ：最常见的请求消息类型，当用户执行SQL语句时发送该消息。

字节| 说明  
---|---  
n| SQL语句（字符串到达消息尾部时结束，无结束符）  
  
**COM_FIELD_LIST 消息报文**

**功能** ：查询某表的字段（列）信息，等同于SQL语句`SHOW [FULL] FIELDS FROM ...`。

字节| 说明  
---|---  
n| 表格名称（Null-Terminated String）  
n| 字段（列）名称或通配符（可选）  
  
**COM_CREATE_DB 消息报文**

**功能** ：创建数据库，该消息已过时，而被SQL语句`CREATE DATABASE`代替。

字节| 说明  
---|---  
n| 数据库名称（字符串到达消息尾部时结束，无结束符）  
  
**COM_DROP_DB 消息报文**

**功能** ：删除数据库，该消息已过时，而被SQL语句`DROP DATABASE`代替。

字节| 说明  
---|---  
n| 数据库名称（字符串到达消息尾部时结束，无结束符）  
  
**COM_REFRESH 消息报文**

**功能** ：清除缓存，等同于SQL语句`FLUSH`，或是执行`mysqladmin flush-foo`命令时发送该消息。

字节| 说明  
---|---  
1| 清除缓存选项（位图方式存储，各标志位含义如下）  
| 0x01: REFRESH_GRANT  
| 0x02: REFRESH_LOG  
| 0x04: REFRESH_TABLES  
| 0x08: REFRESH_HOSTS  
| 0x10: REFRESH_STATUS  
| 0x20: REFRESH_THREADS  
| 0x40: REFRESH_SLAVE  
| 0x80: REFRESH_MASTER  
  
**COM_SHUTDOWN 消息报文**

**功能** ：停止MySQL服务。执行`mysqladmin shutdown`命令时发送该消息。

字节| 说明  
---|---  
1| 停止服务选项  
| 0x00: SHUTDOWN_DEFAULT  
| 0x01: SHUTDOWN_WAIT_CONNECTIONS  
| 0x02: SHUTDOWN_WAIT_TRANSACTIONS  
| 0x08: SHUTDOWN_WAIT_UPDATES  
| 0x10: SHUTDOWN_WAIT_ALL_BUFFERS  
| 0x11: SHUTDOWN_WAIT_CRITICAL_BUFFERS  
| 0xFE: KILL_QUERY  
| 0xFF: KILL_CONNECTION  
  
**COM_STATISTICS 消息报文**

**功能** ：查看MySQL服务的统计信息（例如运行时间、每秒查询次数等）。执行`mysqladmin status`命令时发送该消息，无参数。

**COM_PROCESS_INFO 消息报文**

**功能** ：获取当前活动的线程（连接）列表。等同于SQL语句`SHOW PROCESSLIST`，或是执行`mysqladmin
processlist`命令时发送该消息，无参数。

**COM_PROCESS_KILL 消息报文**

**功能** ：要求服务器中断某个连接。等同于SQL语句`KILL`。

字节| 说明  
---|---  
4| 连接ID号（小字节序）  
  
**COM_DEBUG 消息报文**

**功能** ：要求服务器将调试信息保存下来，保存的信息多少依赖于编译选项设置（debug=no|yes|full）。执行`mysqladmin
debug`命令时发送该消息，无参数。

**COM_PING 消息报文**

**功能** ：该消息用来测试连通性，同时会将服务器的无效连接（超时）计数器清零。执行`mysqladmin ping`命令时发送该消息，无参数。

**COM_CHANGE_USER 消息报文**

**功能** ：在不断连接的情况下重新登陆，该操作会销毁MySQL服务器端的会话上下文（包括临时表、会话变量等）。有些连接池用这种方法实现清除会话上下文。

字节| 说明  
---|---  
n| 用户名（字符串以NULL结尾）  
n| 密码（挑战数）  
| MySQL 3.23 版本：Null-Terminated String（长度9字节）  
| MySQL 4.1 版本：Length Coded String（长度1+21字节）  
n| 数据库名称（Null-Terminated String）  
2| 字符编码  
  
**COM_BINLOG_DUMP 消息报文**

**功能**
：该消息是备份连接时由从服务器向主服务器发送的最后一个请求，主服务器收到后，会响应一系列的报文，每个报文都包含一个二进制日志事件。如果主服务器出现故障时，会发送一个EOF报文。

字节| 说明  
---|---  
4| 二进制日志数据的起始位置（小字节序）  
4| 二进制日志数据标志位（目前未使用，永远为0x00）  
4| 从服务器的服务器ID值（小字节序）  
n| 二进制日志的文件名称（可选，默认值为主服务器上第一个有效的文件名）  
  
**COM_TABLE_DUMP 消息报文**

**功能** ：将数据表从主服务器复制到从服务器中，执行SQL语句`LOAD TABLE ... FROM
MASTER`时发送该消息。目前该消息已过时，不再使用。

字节| 说明  
---|---  
n| 数据库名称（Length Coded String）  
n| 数据表名称（Length Coded String）  
  
**COM_REGISTER_SLAVE 消息报文**

**功能** ：在从服务器`report_host`变量设置的情况下，当备份连接时向主服务器发送的注册消息。

字节| 说明  
---|---  
4| 从服务器ID值（小字节序）  
n| 主服务器IP地址（Length Coded String）  
n| 主服务器用户名（Length Coded String）  
n| 主服务器密码（Length Coded String）  
2| 主服务器端口号  
4| 安全备份级别（由MySQL服务器`rpl_recovery_rank`变量设置，暂时未使用）  
4| 主服务器ID值（值恒为0x00）  
  
**COM_PREPARE 消息报文**

**功能** ：预处理SQL语句，使用带有"?"占位符的SQL语句时发送该消息。

字节| 说明  
---|---  
n| 带有"?"占位符的SQL语句（字符串到达消息尾部时结束，无结束符）  
  
**COM_EXECUTE 消息报文**

**功能** ：执行预处理语句。

字节| 说明  
---|---  
4| 预处理语句的ID值  
1| 标志位  
| 0x00: CURSOR_TYPE_NO_CURSOR  
| 0x01: CURSOR_TYPE_READ_ONLY  
| 0x02: CURSOR_TYPE_FOR_UPDATE  
| 0x04: CURSOR_TYPE_SCROLLABLE  
4| 保留（值恒为0x01）  
如果参数数量大于0|  
n| 空位图（Null-Bitmap，长度 = (参数数量 + 7) / 8 字节）  
1| 参数分隔标志  
如果参数分隔标志值为1|  
n| 每个参数的类型值（长度 = 参数数量 * 2 字节）  
n| 每个参数的值  
  
**COM_LONG_DATA 消息报文**

该消息报文有两种形式，一种用于发送二进制数据，另一种用于发送文本数据。

**功能** ：用于发送二进制（BLOB）类型的数据（调用`mysql_stmt_send_long_data`函数）。

字节| 说明  
---|---  
4| 预处理语句的ID值（小字节序）  
2| 参数序号（小字节序）  
n| 数据负载（数据到达消息尾部时结束，无结束符）  
  
**功能** ：用于发送超长字符串类型的数据（调用`mysql_send_long_data`函数）

字节| 说明  
---|---  
4| 预处理语句的ID值（小字节序）  
2| 参数序号（小字节序）  
2| 数据类型（未使用）  
n| 数据负载（数据到达消息尾部时结束，无结束符）  
  
**COM_CLOSE_STMT 消息报文**

**功能** ：销毁预处理语句。

字节| 说明  
---|---  
4| 预处理语句的ID值（小字节序）  
  
**COM_RESET_STMT 消息报文**

**功能** ：将预处理语句的参数缓存清空。多数情况和`COM_LONG_DATA`一起使用。

字节| 说明  
---|---  
4| 预处理语句的ID值（小字节序）  
  
**COM_SET_OPTION 消息报文**

**功能** ：设置语句选项，选项值为`/include/mysql_com.h`头文件中定义的`enum_mysql_set_option`枚举类型：

  * MYSQL_OPTION_MULTI_STATEMENTS_ON
  * MYSQL_OPTION_MULTI_STATEMENTS_OFF

字节| 说明  
---|---  
2| 选项值（小字节序）  
  
**COM_FETCH_STMT 消息报文**

**功能** ：获取预处理语句的执行结果（一次可以获取多行数据）。

字节| 说明  
---|---  
4| 预处理语句的ID值（小字节序）  
4| 数据的行数（小字节序）  
  
### 服务器响应报文（服务器 -> 客户端）

当客户端发起认证请求或命令请求后，服务器会返回相应的执行结果给客户端。客户端在收到响应报文后，需要首先检查第1个字节的值，来区分响应报文的类型。

响应报文类型| 第1个字节取值范围  
---|---  
OK 响应报文| 0x00  
Error 响应报文| 0xFF  
Result Set 报文| 0x01 - 0xFA  
Field 报文| 0x01 - 0xFA  
Row Data 报文| 0x01 - 0xFA  
EOF 报文| 0xFE  
  
注：响应报文的第1个字节在不同类型中含义不同，比如在OK报文中，该字节并没有实际意义，值恒为0x00；而在Result
Set报文中，该字节又是长度编码的二进制数据结构（Length Coded Binary）中的第1字节。

**响应报文**

客户端的命令执行正确时，服务器会返回OK响应报文。

**MySQL 4.0 及之前的版本**

字节| 说明  
---|---  
1| OK报文，值恒为0x00  
1-9| 受影响行数（Length Coded Binary）  
1-9| 索引ID值（Length Coded Binary）  
2| 服务器状态  
n| 服务器消息（字符串到达消息尾部时结束，无结束符）  
  
**MySQL 4.1 及之后的版本**

字节| 说明  
---|---  
1| OK报文，值恒为0x00  
1-9| 受影响行数（Length Coded Binary）  
1-9| 索引ID值（Length Coded Binary）  
2| 服务器状态  
2| 告警计数  
n| 服务器消息（字符串到达消息尾部时结束，无结束符，可选）  
  
**受影响行数** ：当执行`INSERT`/`UPDATE`/`DELETE`语句时所影响的数据行数。

**索引ID值**
：该值为`AUTO_INCREMENT`索引字段生成，如果没有索引字段，则为0x00。注意：当`INSERT`插入语句为多行数据时，该索引ID值为第一个插入的数据行索引值，而非最后一个。

**服务器状态** ：客户端可以通过该值检查命令是否在事务处理中。

**告警计数** ：告警发生的次数。

**服务器消息** ：服务器返回给客户端的消息，一般为简单的描述性字符串，可选字段。

**响应报文**

**MySQL 4.0 及之前的版本**

字节| 说明  
---|---  
1| Error报文，值恒为0xFF  
2| 错误编号（小字节序）  
n| 服务器消息  
  
**MySQL 4.1 及之后的版本**

字节| 说明  
---|---  
1| Error报文，值恒为0xFF  
2| 错误编号（小字节序）  
1| 服务器状态标志，恒为’#'字符  
5| 服务器状态（5个字符）  
n| 服务器消息  
  
**错误编号** ：错误编号值定义在源代码`/include/mysqld_error.h`头文件中。

**服务器状态**
：服务器将错误编号通过`mysql_errno_to_sqlstate`函数转换为状态值，状态值由5字节的ASCII字符组成，定义在源代码`/include/sql_state.h`头文件中。

**服务器消息** ：错误消息字符串到达消息尾时结束，长度可以由消息头中的长度值计算得出。消息长度为0-512字节。

**Result Set 消息**

当客户端发送查询请求后，在没有错误的情况下，服务器会返回结果集（Result Set）给客户端。

Result Set 消息分为五部分，结构如下：

结构| 说明  
---|---  
[Result Set Header]| 列数量  
[Field]| 列信息（多个）  
[EOF]| 列结束  
[Row Data]| 行数据（多个）  
[EOF]| 数据结束  
  
**Result Set Header 结构**

字节| 说明  
---|---  
1-9| Field结构计数（Length Coded Binary）  
1-9| 额外信息（Length Coded Binary）  
  
**Field结构计数** ：用于标识Field结构的数量，取值范围0x00-0xFA。

**额外信息** ：可选字段，一般情况下不应该出现。只有像`SHOW COLUMNS`这种语句的执行结果才会用到额外信息（标识表格的列数量）。

**Field 结构**

Field为数据表的列信息，在Result Set中，Field会连续出现多次，次数由Result Set Header结构中的IField结构计数值决定。

**MySQL 4.0 及之前的版本**

字节| 说明  
---|---  
n| 数据表名称（Length Coded String）  
n| 列（字段）名称（Length Coded String）  
4| 列（字段）长度（Length Coded String）  
2| 列（字段）类型（Length Coded String）  
2| 列（字段）标志（Length Coded String）  
1| 整型值精度  
n| 默认值（Length Coded String）  
  
**MySQL 4.1 及之后的版本**

字节| 说明  
---|---  
n| 目录名称（Length Coded String）  
n| 数据库名称（Length Coded String）  
n| 数据表名称（Length Coded String）  
n| 数据表原始名称（Length Coded String）  
n| 列（字段）名称（Length Coded String）  
4| 列（字段）原始名称（Length Coded String）  
1| 填充值  
2| 字符编码  
4| 列（字段）长度  
1| 列（字段）类型  
2| 列（字段）标志  
1| 整型值精度  
2| 填充值（0x00）  
n| 默认值（Length Coded String）  
  
**目录名称** ：在4.1及之后的版本中，该字段值为"def"。

**数据库名称** ：数据库名称标识。

**数据表名称** ：数据表的别名（`AS`之后的名称）。

**数据表原始名称** ：数据表的原始名称（`AS`之前的名称）。

**列（字段）名称** ：列（字段）的别名（`AS`之后的名称）。

**列（字段）原始名称** ：列（字段）的原始名称（`AS`之前的名称）。

**字符编码** ：列（字段）的字符编码值。

**列（字段）长度** ：列（字段）的长度值，真实长度可能小于该值，例如`VARCHAR(2)`类型的字段实际只能存储1个字符。

**列（字段）类型**
：列（字段）的类型值，取值范围如下（参考源代码`/include/mysql_com.h`头文件中的`enum_field_type`枚举类型定义）：

类型值| 名称  
---|---  
0x00| FIELD_TYPE_DECIMAL  
0x01| FIELD_TYPE_TINY  
0x02| FIELD_TYPE_SHORT  
0x03| FIELD_TYPE_LONG  
0x04| FIELD_TYPE_FLOAT  
0x05| FIELD_TYPE_DOUBLE  
0x06| FIELD_TYPE_NULL  
0x07| FIELD_TYPE_TIMESTAMP  
0x08| FIELD_TYPE_LONGLONG  
0x09| FIELD_TYPE_INT24  
0x0A| FIELD_TYPE_DATE  
0x0B| FIELD_TYPE_TIME  
0x0C| FIELD_TYPE_DATETIME  
0x0D| FIELD_TYPE_YEAR  
0x0E| FIELD_TYPE_NEWDATE  
0x0F| FIELD_TYPE_VARCHAR (new in MySQL 5.0)  
0x10| FIELD_TYPE_BIT (new in MySQL 5.0)  
0xF6| FIELD_TYPE_NEWDECIMAL (new in MYSQL 5.0)  
0xF7| FIELD_TYPE_ENUM  
0xF8| FIELD_TYPE_SET  
0xF9| FIELD_TYPE_TINY_BLOB  
0xFA| FIELD_TYPE_MEDIUM_BLOB  
0xFB| FIELD_TYPE_LONG_BLOB  
0xFC| FIELD_TYPE_BLOB  
0xFD| FIELD_TYPE_VAR_STRING  
0xFE| FIELD_TYPE_STRING  
0xFF| FIELD_TYPE_GEOMETRY  
  
**列（字段）标志** ：各标志位定义如下（参考源代码`/include/mysql_com.h`头文件中的宏定义）：

标志位| 名称  
---|---  
0x0001| NOT_NULL_FLAG  
0x0002| PRI_KEY_FLAG  
0x0004| UNIQUE_KEY_FLAG  
0x0008| MULTIPLE_KEY_FLAG  
0x0010| BLOB_FLAG  
0x0020| UNSIGNED_FLAG  
0x0040| ZEROFILL_FLAG  
0x0080| BINARY_FLAG  
0x0100| ENUM_FLAG  
0x0200| AUTO_INCREMENT_FLAG  
0x0400| TIMESTAMP_FLAG  
0x0800| SET_FLAG  
  
**数值精度** ：该字段对`DECIMAL`和`NUMERIC`类型的数值字段有效，用于标识数值的精度（小数点位置）。

**默认值** ：该字段用在数据表定义中，普通的查询结果中不会出现。

**附** ：Field结构的相关处理函数：

  * 客户端：`/client/client.c`源文件中的`unpack_fields`函数
  * 服务器：`/sql/sql_base.cc`源文件中的`send_fields`函数

**EOF 结构**

EOF结构用于标识Field和Row Data的结束，在预处理语句中，EOF也被用来标识参数的结束。

**MySQL 4.0 及之前的版本**

字节| 说明  
---|---  
1| EOF值（0xFE）  
  
**MySQL 4.1 及之后的版本**

字节| 说明  
---|---  
1| EOF值（0xFE）  
2| 告警计数  
2| 状态标志位  
  
**告警计数** ：服务器告警数量，在所有数据都发送给客户端后该值才有效。

**状态标志位** ：包含类似`SERVER_MORE_RESULTS_EXISTS`这样的标志位。

**注** ：由于EOF值与其它Result Set结构共用1字节，所以在收到报文后需要对EOF包的真实性进行校验，校验条件为：

  * 第1字节值为0xFE
  * 包长度小于9字节

**附** ：EOF结构的相关处理函数：

  * 服务器：`protocol.cc`源文件中的`send_eof`函数

**Row Data 结构**

在Result Set消息中，会包含多个Row Data结构，每个Row Data结构又包含多个字段值，这些字段值组成一行数据。

字节| 说明  
---|---  
n| 字段值（Length Coded String）  
…| （一行数据中包含多个字段值）  
  
**字段值** ：行数据中的字段值，字符串形式。

**附** ：Row Data结构的相关处理函数：

  * 客户端：`/client/client.c`源文件中的`read_rows`函数

**Row Data 结构（二进制数据）**

该结构用于传输二进制的字段值，既可以是服务器返回的结果，也可以是由客户端发送的（当执行预处理语句时，客户端使用Result Set消息来发送参数及数据）。

字节| 说明  
---|---  
1| 结构头（0x00）  
(列数量 + 7 + 2) / 8| 空位图  
n| 字段值  
…| （一行数据中包含多个字段值）  
  
**空位图** ：前2个比特位被保留，值分别为0和1，以保证不会和OK、Error包的首字节冲突。在MySQL
5.0及之后的版本中，这2个比特位的值都为0。

**字段值** ：行数据中的字段值，二进制形式。

**PREPARE_OK 响应报文（Prepared Statement）**

用于响应客户端发起的预处理语句报文，组成结构如下：

结构| 说明  
---|---  
[PREPARE_OK]| PREPARE_OK结构  
如果参数数量大于0|  
[Field]| 与Result Set消息结构相同  
[EOF]|  
如果列数大于0|  
[Field]| 与Result Set消息结构相同  
[EOF]|  
  
其中 PREPARD_OK 的结构如下：

字节| 说明  
---|---  
1| OK报文，值为0x00  
4| 预处理语句ID值  
2| 列数量  
2| 参数数量  
1| 填充值（0x00）  
2| 告警计数  
  
**Parameter 响应报文（Prepared Statement）**

预处理语句的值与参数正确对应后，服务器会返回 Parameter 报文。

字节| 说明  
---|---  
2| 类型  
2| 标志  
1| 数值精度  
4| 字段长度  
  
**类型** ：与 Field 结构中的字段类型相同。

**标志** ：与 Field 结构中的字段标志相同。

**数值精度** ：与 Field 结构中的数值精度相同。

**字段长度** ：与 Field 结构中的字段长度相同。

## 代码分析

    
    
    议程
    协议头
    协议类型 网络协议相关函数 NET缓冲 VIO缓冲 MySQL API
    

**协议头**

● 数据变成在网络里传输的数据,需要额外的在头部添加4 个字节的包头.

. packet length(3字节), 包体的长度

. packet number(1字节), 从0开始的递增的

● sql “select 1” 的网络协议是？

**协议头**

● packet length三个字节意味着MySQL packet最大16M大于16M则被分包(net_write_command,
my_net_write)

● packet number分包从0开始,依次递增.每一次执行sql, packet_number清零(sql/net_serv.c:net_clear)

**协议类型**

● handshake

● auth

● ok|error

● resultset

​ ○ header

​ ○ field

​ ○ eof

​ ○ row

● command packet

**连接时的交互**

**协议说明**

● 协议内字段分三种形式

​ ○ 固定长度(include/my_global.h)

​ ■ uint*korr 解包 *

​ ■ int*store 封包

​ ○ length coded binary(sql-common/pack.c)

​ ■ net_field_length 解包

​ ■ net_store_length 封包

​ ○ null-terminated string

● length coded binary

​ ○ 避免binary unsafe string, 字符串的长度保存在字符串的前面

​ ■ length<251 1 byte

​ ■ length <256^2 3 byte(第一个byte是252)

​ ■ length<256^3 4byte(第一个byte是253)

​ ■ else 9byte(第一个byte是254)

**handshake packet**

● 该协议由服务端发送客户端

● 括号内为字节数,字节数为n为是null-terminated string;字节数为大写的N表示length code binary.

● salt就是scramble.分成两个部分是为了兼容4.1版本

● sql_connect.cc:check_connection

● sql_client.c:mysql_real_connect

**auth packet**

● 该协议是从客户端对密码使用scramble加密后发送到服务端

● 其中databasename是可选的.salt就是加密后的密码.

● sql_client.c:mysql_real_connect

● sql_connect.c:check_connection

**ok packet**

● ok包,命令和insert,update,delete的返回结果

● 包体首字节为0.

● insert_id, affect_rows也是一并发过来.

● src/protocol.cc:net_send_ok

**error packet**

● 错误的命令,非法的sql的返回包

● 包体首字节为255.

● error code就是CR_***,include/errmsg.h  
● sqlstate marker是#

● sqlstate是错误状态,include/sql_state.h

● message是错误的信息

● sql/protocol.cc:net_send_error_packet

**resultset packet**

● 结果集的数据包,由多个packet组合而成

● 例如查询一个结构集,顺序如下:  
○ header  
○ field1…fieldN  
○ eof  
○ row1…rowN  
○ eof

● sql/client.c:cli_read_query_result

● 下面是一个sql "select * from d"查询结果集的例子,结果 集是6行，3个字段  
○ 公式：假设结果集有N行, M个字段.则包的个数为，header(1) + field (M) + eof(1) + row(N) + eof(1)  
○ 所以这个例子的MySQL packet的个数是12个

**resultset packet - header**

● field packet number决定了接下来的field packet的个数.

● 一个返回6行记录,3个字段的查询语句

**resultset packet - field**

● 结果集中一个字段一个field packet.

● tables_alias是sql语句里表的别名,org_table才是表的真 实名字.

● sql/protocol.cc:Protocol::send_fields

● sql/client.c:cli_read_query_result

**resultset packet - eof**

● eof包是用于分割field packet和row packet.

● 包体首字节为254

● sql/protocol.cc:net_send_eof

**resultset packet - row**

● row packet里才是真正的数据包.一行数据一个packet.

● row里的每个字段都是length coded binary

● 字段的个数在header packet里

● sql/client.c:cli_read_rows

**command packet**

● 命令包,包括我们的sql语句还有一些常见的命令.

● 包体首字母表示命令的类型(include/mysql_com.h),大 部分命令都是COM_QUERY.

**网络协议关键函数**

● net_write_command(sql/net_serv.cc)所有的sql最终调用这个命令发送出去.

● my_net_write(sql/net_serv.cc)连接阶段的socket write操作调用这个函数.

● my_net_read读取包,会判断包大小,是否是分包

● my_real_read解析MySQL packet,第一次读取4字节,根据packet length再读取余下来的长度

● cli_safe_read客户端解包函数,包含了my_net_read

**NET缓冲**

● 每次socket操作都会先把数据写,读到net->buff,这是一 个缓冲区, 减少系统调用调用的次数.

● 当写入的数据和buff内的数据超过buff大小才会发出一次 write操作,然后再把要写入的buff里插入数, 写入不会
导致buff区区域扩展.(sql/net_serv.cc: net_write_buff).

● net->buff大小初始net->max_packet, 读取会导致会导致 buff的realloc最大net->max_packet_size

● 一次sql命令的结束都会调用net_flush,把buff里的数据 都写到socket里.

**VIO缓冲**

● 从my_read_read可以看出每次packet读取都是按需读取， 为了减少系统调用,vio层面加了一个read_buffer.

● 每次读取前先判断vio->read_buffer所需数据的长度是 否足够.如果存在则直接copy. 如果不够,则触发一次 socket read
读取2048个字(vio/viosocket.c: vio_read_buff)

**MySQL API**

● 数据从mysql_send_query处发送给服务端,实际调用的是 net_write_command.

● cli_read_query_result解析header packet, field packet,获 得field_count的个数

● mysql_store_result解析了row packet,并存储在result- >data里

● myql_fetch_row其实遍历result->data

**PACKET NUMBER**

在做proxy的时候在这里迷糊过,翻了几遍代码才搞明白，细节如下： 客户端服务端的net->pkt_nr都从0开始.接受包时比较packet number
和net->pkt_nr是否相等,否则报packet number乱序,连接报错;相等则pkt_nr自增.发送包时把net->pkt_nr作为packet
number发送,然后对net->pkt_nr进行自增保持和对端的同步.

**接收包**

    
    
    sql/net_serv.c:my_real_read
         if (net->buff[net->where_b + 3] != (uchar) net->pkt_nr)
    

**发送包**

    
    
    sql/net_serv.c:my_net_write
       int3store(buff,len);
       buff[3]= (uchar) net->pkt_nr++;
    

我们来几个具体场景的packet number, net->pkt_nr的变化

**连接**

    
    
     c ———–> s 0  connect
     c <—-0——s 1  handshake
     c —–1—–>s 1  auth
     c <—–2——s 0  ok
    

开始两方都为0,服务端发送handshake packet(pkt=0)之后自增为1,然后等待对端发送过来pkt=1的包

**查询**

每次查询,服务客户端都会对net->pkt_nr进行清零

    
    
    include/mysql_com.h
     #define net_new_transaction(net) ((net)->pkt_nr=0)
    sql/sql_parse.cc:do_command
       net_new_transaction(net);
    sql/client.c:cli_advanced_command
       net_clear(&mysql->net, (command != COM_QUIT));
    

开始两方net->pkt_nr皆为0, 命令发送后客户端端为1,服务端开始发送分包,分包的pkt_nr的依次递增,客户端的net->pkt_nr也随之增加.

    
    
     c ——0—–> s 0  query
     c <—-1——s 2  resultset
     c <—-2——s 3  resultset
    

**解包的细节**

my_net_read负责解包，首先读取4个字节，判断packet
number是否等于net->pkt_nr然后再次读取packet_number长度的包体。

伪代码如下：

    
    
    remain=4
    for(i = 0; i < 2; i++) {
        //数据是否读完
        while (remain>0)  {
            length = read(fd, net->buff, remain)
            remain = remain - length
        }
        //第一次
        if (i=0) {
            remain = uint3korr(net->buff+net->where_b);
        }
    }
    

**网络层优化**

从ppt里可以看到,一个resultset packet由多个包组成,如果每次读写包都导致系统调用那肯定是不合理,常规优化方法:写大包加预读

**NET- >BUFF**

每个包发送到网络或者从网络读包都会先把数据包保存在net->buff里,待到net->buff满了或者一次命令结束才会通过socket发出给对端.net->buff有个初始大小(net->max_packet),会随读取数据的增多而扩展.

**VIO- >READ_BUFFER**

每次从网络读包,并不是按包的大小读取,而是会尽量读取2048个字节,这样一个resultset包的读取不会再引起多次的系统调用了.header
packet读取完毕后, 接下来的field,eof, row apcket读取仅仅需要从vio-read_buffer拷贝指定字节的数据即可.

**MYSQL API说明**

api和MySQL客户端都会使用sql/client.c这个文件,解包的过程都是使用sql/client.c:cli_read_query_result.

mysql_store_result来解析row packet,并把数据存储到res->data里,此时所有数据都存内存里了.

mysql_fetch_row仅仅是使用内部的游标,遍历result->data里的数据

    
    
    if (!res->data_cursor)
    {
        DBUG_PRINT("info",("end of data"));
        DBUG_RETURN(res->current_row=(MYSQL_ROW) NULL);
    }
    tmp = res->data_cursor->data;
    res->data_cursor = res->data_cursor->next;
    DBUG_RETURN(res->current_row=tmp);
    

mysql_free_result是把result->data指定的行数据释放掉.

