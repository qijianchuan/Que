---
title: 高可用之——节流
categories: 精通高可用系列
tags: 高可用 高并发 限流 节流
---
在特定时间窗口内对重复的相同事件最多只处理一次，或者需要限制多个连续相同事件的最小执行时间间隔，可以使用节流（Throttle）实现，可以防止多个相同事件连续重复执行。节流主要的用法有：throttleFirst、throttleLast、throttleWithTimeout。

### 一、throttleFirst/throttleLast

throttleFirst/throttleLast指的是在一个事件窗口内，如果有重复的多个相同事件需要处理，则只处理第一个或者最后一个。  
一个场景是网页中的resize、scroll和mousemove事件。当改变浏览器大小时，会触发resize事件，当滚动页面元素时会触发scroll事件。当快速连续执行这些操作时，可能造成UI反应慢、浏览器卡顿，所以可以使用节流解决这个问题。  
对于前端开发，可以使用jquery-throttle-debounce-plugin实现，而Android开发可以使用RxAndroid实现。

### 二、throttleWithTimeout

throttleWithTimeout也叫做debounce（去抖），限制两个连续事件的先后执行时间不得小于某个时间窗口。当两个连续事件的间隔时间小于最小间隔时间窗口，就会丢弃上一个事件，而如果最后一个事件等待了最小间隔时间窗口后，还没有新的事件到来，就会处理最后一个事件。  
一个场景是搜索关键词自动补全，如果用户每录入一个字就发送一次请求，而先输入的字的自动补全会被很快到来的下一个字符覆盖掉，那么会导致先期的自动补全是无用的。throttleWithTimeout可以解决这个问题，通过它来减少频繁的网络请求，避免每输入一个字就导致一次请求。  
使用RxJava 1.2.0实现的测试代码。

    
    
    Observable.create(new Observable.OnSubscribe<Integer>(){
    	@Override
    	public void call(Subscriber<? super Integer> subscriber){
    		//next实现：Thread.sleep(millis); subscriber.onNext(i);
    		next(subscriber, 1, 0); //0ms 
    		next(subscriber, 2, 50); //50ms
    		next(subscriber, 3, 50); //100ms
    		next(subscriber, 4, 30); //130ms
    		next(subscriber, 5, 40); //170ms
    		next(subscriber, 6, 130); //300ms
    		subscriber.onCompleted();
    	}
    }).subscribeOn(Schedulers.newThread())
    .throttleWithTimeout(100, TimeUnit.MILLISECONDS)
    .subscribe(new Subscriber<Integer>(){
    	......
    	@Override
    	public void onNext(Integer i){
    		System.out.println("======>>>" + i);
    	}
    });

——总结自涛哥的《亿级流量网站架构核心技术》

