---
title: è‚äº†å¾ˆä¹…ï¼Œå†°æ²³æ•´ç†å‡ºè¿™ä»½4ä¸‡å­—çš„SpringCloudä¸SpringCloudAlibabaå­¦ä¹ ç¬”è®°ï¼ï¼
categories: ç²¾é€šå¾®æœåŠ¡ç³»åˆ—
tags: SpringCloud CloudAlibaba å¾®æœåŠ¡ åˆ†å¸ƒå¼ å†°æ²³
---
# å†™åœ¨å‰é¢

ä¸å°‘å°ä¼™ä¼´è®©æˆ‘æ•´ç†ä¸‹æœ‰å…³SpringCloudå’ŒSpringCloudAlibabaçš„çŸ¥è¯†ç‚¹ï¼Œç»è¿‡3å¤©çš„æ”¶é›†å’Œæ•´ç†ï¼Œå†°æ²³æ•´ç†å‡ºè¿™ä»½4ä¸‡å­—çš„SpringCloudä¸SpringCloudAlibabaå­¦ä¹ ç¬”è®°ï¼ï¼

æ–‡ç« å·²æ”¶å½•åˆ°ï¼š

https://github.com/sunshinelyz/technology-binghe

https://gitee.com/binghe001/technology-binghe

# SpringCloud

## æœåŠ¡æ³¨å†Œä¸­å¿ƒ

### eureka

ap é«˜å¯ç”¨ åˆ†å¸ƒå¼å®¹é”™

    
    
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
    eureka:
      instance:
        hostname: eureka7003.com #eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°
        instance-id: payment8001 
        prefer-ip-address: true
      client:
        register-with-eureka: false     #falseè¡¨ç¤ºä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±ã€‚
        fetch-registry: false     #falseè¡¨ç¤ºè‡ªå·±ç«¯å°±æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œæˆ‘çš„èŒè´£å°±æ˜¯ç»´æŠ¤æœåŠ¡å®ä¾‹ï¼Œå¹¶ä¸éœ€è¦å»æ£€ç´¢æœåŠ¡
        service-url:
          #é›†ç¾¤æŒ‡å‘å…¶å®ƒeureka
          #defaultZone: http://eureka7002.com:7002/eureka/
          #å•æœºå°±æ˜¯7001è‡ªå·±
          defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/
        #server:
        #å…³é—­è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œä¿è¯ä¸å¯ç”¨æœåŠ¡è¢«åŠæ—¶è¸¢é™¤
        #enable-self-preservation: false
        #eviction-interval-timer-in-ms: 2000
    

#### Ribbon å¯ç”¨è´Ÿè½½å‡è¡¡

    
    
    @EnableEurekaServer
    @EnableDiscoveryClient
    
    @LoadBalanced
    public RestTemplate getTemp() {
        return new RestTemplate();
    }
    

### zookepper

cp å¼ºä¸€è‡´ åˆ†å¸ƒå¼å®¹é”™

    
    
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-zookeeper-discovery</artifactId>
        <exclusions>
            <exclusion>
                <groupId>org.apache.zookeeper</groupId>
                <artifactId>zookeeper</artifactId>
            </exclusion>
        </exclusions>
    </dependency>
    <dependency>
        <groupId>org.apache.zookeeper</groupId>
        <artifactId>zookeeper</artifactId>
        <version>3.6.1</version>
    </dependency>
    spring:
      application:
        name: cloud-zoo-consumer-order
      cloud:
        zookeeper:
          connect-string: 192.168.10.58:2181
    @SpringBootApplication
    @EnableDiscoveryClient
    

### consul

cp å¼ºä¸€è‡´ åˆ†å¸ƒå¼å®¹é”™

    
    
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-consul-discovery</artifactId>
    </dependency>
    spring:
      application:
        name: consul-payment-provider
      cloud:
        consul:
          host: 192.168.10.58
          port: 8500
          discovery:
            service-name: ${spring.application.name}
    @SpringBootApplication
    @EnableDiscoveryClient
    

## æœåŠ¡è°ƒç”¨è´Ÿè½½å‡è¡¡

### Ribbon

#### Ribbon åˆ‡æ¢ è´Ÿè½½è§„åˆ™

  1. åœ¨springboot åŒ…æ‰«æå¤–å±‚å»ºç«‹ é…ç½®

    
    
    @Configuration
    public class Myrule {
        @Bean
        public IRule initRule() {
            return new RandomRule();
        }
    }
    

  1. å¯åŠ¨ç±»ç»™æŒ‡å®šæœåŠ¡åŠ è½½éšæœºæ–¹æ³•

    
    
    @RibbonClient(name = "CLOUD-PAYMENT-SERVICE", configuration = Myrule.class)
    

### OpenFeign

  1. æ·»åŠ mavenä¾èµ–

    
    
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-openfeign</artifactId>
    </dependency>
    

  1. å¯åŠ¨ç±»å¯ç”¨Feign

    
    
    @SpringBootApplication
    @EnableEurekaClient
    @EnableDiscoveryClient
    @EnableFeignClients
    

  1. æ–°å»ºæ¥å£ å¹¶æ³¨å†ŒFeignä¿¡æ¯

    
    
    @Component
    @FeignClient(value = "CLOUD-PAYMENT-SERVICE")  //æä¾›æ–¹æœåŠ¡å
    public interface Service {
        @GetMapping(value = "/payment/get/{id}")
        Response<Payment> getPaymentById(@PathVariable("id") Long id);
    }
    

  1. æä¾›æ–¹æ¥å£æ¼”ç¤º

    
    
    @GetMapping(value = "/payment/get/{id}")
    public Response<Payment> getPaymentById(@PathVariable("id") Long id) {
        Payment payment = paymentService.getPaymentById(id);
    
        if (payment != null) {
            return Result.success(200, "æŸ¥è¯¢æˆåŠŸ,serverPort:  " + serverPort, payment);
        } else {
            return Result.success(444, "æ²¡æœ‰å¯¹åº”è®°å½•,æŸ¥è¯¢ID: " + id, null);
        }
    }
    

#### OpenFeignè¶…æ—¶è®¾ç½®

    
    
    ribbon:
    #æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥æ‰€ç”¨çš„æ—¶é—´ï¼Œé€‚ç”¨äºç½‘ç»œçŠ¶å†µæ­£å¸¸çš„æƒ…å†µä¸‹,ä¸¤ç«¯è¿æ¥æ‰€ç”¨çš„æ—¶é—´
      ReadTimeout: 5000
    #æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥åä»æœåŠ¡å™¨è¯»å–åˆ°å¯ç”¨èµ„æºæ‰€ç”¨çš„æ—¶é—´
      ConnectTimeout: 5000
    

#### OpenFeign æ—¥å¿—æ‰“å°åŠŸèƒ½

  1. é…ç½®Openfeign æ—¥å¿—çº§åˆ«

    
    
    @Configuration
    public class FeignLogConfig {
        @Bean
        public Logger.Level getLevel() {
            return Logger.Level.FULL;
        }
    }
    

  1. yml é¡¹ç›®é…ç½®æ–‡ä»¶ä¸­,ç»™æŒ‡å®šFeign interface é…ç½®æ—¥å¿—çº§åˆ«

    
    
    logging:
      level:
        ml.ytooo.feignservice.Service: debug
    

### Hystrix æœåŠ¡æ²»ç†

  * æœåŠ¡é™çº§ å‡ºé™©å¼‚å¸¸æ—¶,è¿”å›å‹å¥½æç¤º,é˜²æ­¢ç¨‹åºå¼‚å¸¸æˆ–è€…é˜»å¡
  * æœåŠ¡ç†”æ–­ ä¿é™©ä¸,å½“è¶…å‡ºæœåŠ¡æ‰¿è½½èƒ½åŠ›æ—¶,è¿”å›æç¤º,æ‹’ç»è¯·æ±‚
  * æœåŠ¡é™æµ é—¸é—¨,é…ç½®æœåŠ¡æ‰¿è½½èƒ½åŠ›

#### Hystrix

##### æœåŠ¡é™çº§

###### å½“æœåŠ¡å¤„ç†è¶…æ—¶æˆ–è€…è¿è¡Œå¼‚å¸¸æ—¶,å¯åŠ¨å¤‡é€‰æ–¹æ¡ˆè¿”å›ç»™è°ƒç”¨è€…é¢„æœŸç»“æœ

ä¸»æ–¹æ³•

    
    
    @EnableCircuitBreaker
    

éœ€è¦é™çº§å¤„ç†çš„ç¨‹åº

å…¶ä¸­

  * paymentInfo_TimeOut ä¸ºé¢„è®¡è¶…æ—¶ç¨‹åº
  * paymentInfo_TimeOut_Handler ä¸ºè¶…æ—¶å¤‡é€‰æ–¹æ¡ˆ

    
    
    @HystrixCommand(fallbackMethod = "paymentInfo_TimeOut_Handler", commandProperties = {
                @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "3000")
    })
    public String paymentInfo_TimeOut(Integer id) {
    
        int time = 5;
        try { TimeUnit.MILLISECONDS.sleep(time * 1000); } catch (InterruptedException e) { e.printStackTrace(); }
        return "çº¿ç¨‹æ± :  " + Thread.currentThread().getName() + " paymentInfo_TimeOut,id:  " + id + "\t" + "O(âˆ©_âˆ©)Oå“ˆå“ˆ~" + "  è€—æ—¶(ç§’): " + time;
    }
    
    public String paymentInfo_TimeOut_Handler(Integer id) {
        return "çº¿ç¨‹æ± :  " + Thread.currentThread().getName() + " paymentInfo_TimeOut_Handler,id:  " + id + "\t" + "o(â•¥ï¹â•¥)o";
    }
    

###### å…¨å±€é™çº§å¤„ç†

**é…ç½® defaultFallback çš„èµ°è‡ªå·±çš„é™çº§æ–¹æ³•,æœªé…ç½®çš„èµ° é»˜è®¤@DefaultProperties æŒ‡å®šçš„é™çº§æ–¹æ³•**

    
    
    @RestController
    @Slf4j
    @DefaultProperties(defaultFallback = "globle",commandProperties = {
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "1500")
    })
    public class Controller {
        @HystrixCommand
        @GetMapping("/timeout/{id}")
        public String paymentInfo_TimeOut(@PathVariable("id") Integer id) {
            String result = feignService.paymentInfo_TimeOut(id);
            log.info("*****result: " + result);
            return result;
        }
        public String globle() {
            return "å…¨å±€";
        }
    }
    

###### é€šè¿‡OpenFeign é…ç½®å…¶æä¾›æ–¹å…¨å±€é™çº§é…ç½®

  1. æ–°å¢feignè°ƒç”¨æ¥å£çš„å®ç°ç±» FeignServiceImpl,å®ç°å…¨éƒ¨æ–¹æ³•å¹¶åšé™çº§å¤„ç†

    
    
    @Service
    public class FeignServiceImpl implements FeignService {
        @Override
        public String paymentInfo_OK(Integer id) {
            return "é™çº§ -- paymentInfo_OK";
        }
        @Override
        public String paymentInfo_TimeOut(Integer id) {
            return "é™çº§ -- paymentInfo_TimeOut";
        }
    }
    

  1. feignè°ƒç”¨æ¥å£æ·»åŠ æ³¨è§£

    
    
    @FeignClient(value = "CLOUD-PROVIDER-HYSTYRIX-PAYMENT",fallback = FeignServiceImpl.class)
    

##### æœåŠ¡ç†”æ–­

  * æœåŠ¡è¿‡è½½æ—¶,æ‹’ç»è¿æ¥è¯·æ±‚ç›´æ¥è°ƒç”¨é™çº§æ–¹æ³•,è¿”å›å¼‚å¸¸
  * è¯·æ±‚ä¸‹é™æ—¶,æ…¢æ…¢æ¢å¤è¯¥æœåŠ¡è®¿é—®,ç›´è¾¾å®Œå…¨æ¢å¤

é…ç½®æœåŠ¡çš„ç†”æ–­:

ä¸€ä¸‹é…ç½®åœ¨ 10s å†… ,10æ¬¡è¯·æ±‚æœ‰60% å¤±è´¥,åˆ™ç†”æ–­

**HystrixProperty** é…ç½®ä½äº HystrixCommandProperties.class ç±»ä¸­

    
    
    //=====æœåŠ¡ç†”æ–­
    @HystrixCommand(fallbackMethod = "paymentCircuitBreaker_fallback",commandProperties = { //
            @HystrixProperty(name = "circuitBreaker.enabled",value = "true"),// æ˜¯å¦å¼€å¯æ–­è·¯å™¨
            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold",value = "10"),// è¯·æ±‚æ¬¡æ•°
            @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds",value = "10000"), // æ—¶é—´çª—å£æœŸ
            @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage",value = "60"),// å¤±è´¥ç‡è¾¾åˆ°å¤šå°‘ç™¾åˆ†ç™¾åè·³é—¸
    })
    public String paymentCircuitBreaker(@PathVariable("id") Integer id)
    {
        if(id < 0)
        {
            throw new RuntimeException("******id ä¸èƒ½è´Ÿæ•°");
        }
        String serialNumber = IdUtil.simpleUUID();
    
        return Thread.currentThread().getName()+"\t"+"è°ƒç”¨æˆåŠŸï¼Œæµæ°´å·: " + serialNumber;
    }
    public String paymentCircuitBreaker_fallback(@PathVariable("id") Integer id) //ç†”æ–­åé™çº§æ–¹æ³•
    {
        return "id ä¸èƒ½è´Ÿæ•°ï¼Œè¯·ç¨åå†è¯•ï¼Œ/(ã„’oã„’)/~~   id: " +id;
    }
    

**æ•ˆæœ:** å½“è¿ç»­ä½¿ç”¨ -100 è¯·æ±‚æ—¶, è¿”å› â€œid ä¸èƒ½è´Ÿæ•°â€, ä½¿ç”¨100è¯·æ±‚ä¹Ÿè¿”å› â€œid ä¸èƒ½è´Ÿæ•°â€ ,ç»§ç»­è¿ç»­ä½¿ç”¨ 100è¯·æ±‚,
æœåŠ¡æ…¢æ…¢æ¢å¤

##### æœåŠ¡é™æµ

ä½¿ç”¨ springcloud é˜¿é‡Œå·´å·´ sentinel æ›¿ä»£

## Gateway ç½‘å…³

### Gateway

#### Gateway é¡¹ç›®é…ç½®

  1. æ·»åŠ mavenä¾èµ–

    
    
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>
    

  1. ç§»é™¤ä»¥ä¸‹ä¾èµ–

    
    
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    

  1. yml é…ç½® (åç»­ç§»æ­¥é…ç½®ä¸­å¿ƒ)

    
    
    spring:
      application:
        name: cloud-gateaway-gateaway
      cloud:
        gateway:
          discovery:
            locator:
              enabled: true
          routes:
            - id: payment_get
            #   uri: http://127.0.0.1:8001    #å•ä¸€èŠ‚ç‚¹
              uri : lb://CLOUD-PAYMENT-SERVICE  /#å¯ç”¨ æ³¨å†Œä¸­å¿ƒé›†ç¾¤
              predicates:
                - Path=/payment/get/**
    

  1. æ³¨å†Œè¿› Eureka æ³¨å†Œä¸­å¿ƒ

#### Gateway åŠ¨æ€è·¯ç”±

  1. å¼€å¯ ç½‘å…³å‘ç°æ³¨å†Œä¸­å¿ƒæœåŠ¡

    
    
    spring:
      application:
        name: cloud-gateaway-gateaway
      cloud:
        gateway:
          discovery:
            locator:
              enabled: true
    

#### Gateway æ–­è¨€

æ–­è¨€æ˜¯åˆ¤æ–­è½¬å‘è¯·æ±‚çš„æ¡ä»¶

    
    
    predicates:
     - After=2020-02-21T15:51:37.485+08:00[Asia/Shanghai]
    

  1. After,Before,Between é…ç½®è½¬å‘ç”Ÿæ•ˆæ—¶é—´

    
    
    public static void main(String[] args) {
        ZonedDateTime now = ZonedDateTime.now();
        System.out.println(now);
    }
    // 2020-08-24T14:23:57.171+08:00[Asia/Shanghai]
    

  1. Cookie è¯·æ±‚éœ€æºå¸¦æŒ‡å®šCookieæ‰å¯ä»¥è®¿é—®

    
    
    predicates:
      - Cookie=name,ytooo   # key,value
    

  1. Header â‰ˆ Cookie

    
    
    predicates:
      - Header=name,ytooo   # key,value
    

#### Gateway è¿‡æ»¤å™¨

  1. (é»˜è®¤è¿‡æ»¤å™¨) å®˜æ–¹æä¾›ä¸€ç³»åˆ—è¿‡æ»¤å™¨,ä¾›æˆ‘ä»¬ åœ¨è¯·æ±‚è½¬å‘ä¹‹å‰,å¯¹è¯·æ±‚è¿›è¡ŒåŠ å·¥å¤„ç†

    
    
    filters:
      - AddRequestParamter=rowid,1024
    

  1. è‡ªå®šä¹‰è¿‡æ»¤å™¨

è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨

    
    
    @Component
    @Slf4j
    public class GatewayLogFilter implements GlobalFilter, Ordered {
    
        @Override
        public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
            log.info("=====================è¿›å…¥å…¨å±€è¿‡æ»¤å™¨=====================");
            String name = exchange.getRequest().getQueryParams().getFirst("name");
            if (null == name) {
                exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);
                return exchange.getResponse().setComplete();
            }
            return chain.filter(exchange);
        }
    
        @Override
        public int getOrder() {
            return 0;
        }
    }
    

## SpringCloud Config åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ, BUS æ¶ˆæ¯æ€»çº¿

### åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ SpringCloud Config

#### æœåŠ¡ç«¯é…ç½®

  1. å»ºç«‹gitä»“åº“ https://github.com/sunshinelyz/cloud-config
  2. å¼•å…¥ maven

    
    
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-config-server</artifactId>
    </dependency>
    

3.å¯åŠ¨ç±»ä½¿é…ç½®ç”Ÿæ•ˆ

    
    
    @SpringBootApplication
    @EnableEurekaClient
    @EnableConfigServer
    public class ConfigMain3344 {
        public static void main(String[] args) {
            SpringApplication.run(ConfigMain3344.class, args);
        }
    }
    

  1. é…ç½® é…ç½®æ–‡ä»¶

    
    
    spring:
      application:
        name: cloud-config-center
      cloud:
        config:
          server:
            git:
              uri: https://github.com/sunshinelyz/cloud-config
              search-paths:
                - cloud-config
          label: master
    

  1. è¯·æ±‚è®¿é—® : http://127.0.0.1:3344/master/config-dev.yml

#### å®¢æˆ·ç«¯é…ç½®

  1. å¼•å…¥ maven

    
    
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-config-client</artifactId>
    </dependency>
    

  1. é…ç½® é…ç½®æ–‡ä»¶

    
    
    spring:
      application:
        name: cloud-condig-client
      cloud:
        config:
          label: master  # åˆ†æ”¯
          name: config # é…ç½®æ–‡ä»¶åç§°
          profile: dev   # ç‰ˆæœ¬
          uri: http://127.0.0.1:3344 # configæœåŠ¡ç«¯åœ°å€
    

#### æ‰‹åŠ¨åˆ·æ–°å®¢æˆ·ç«¯é…ç½®

ä¸å»ºè®®ä½¿ç”¨

### æ¶ˆæ¯æ€»çº¿ Bus

#### è®¾è®¡é€»è¾‘

ä½¿ç”¨æ¶ˆæ¯æ€»çº¿è§¦å‘æœåŠ¡ç«¯çš„ bus/refresh ç«¯ç‚¹,åˆ·æ–°æ‰€æœ‰å®¢æˆ·ç«¯configé…ç½®

#### åˆå§‹æ¡ä»¶

å®¢æˆ·ç«¯,æœåŠ¡ç«¯éƒ½éœ€è¦å®ç°Springcloud ConfigåŠŸèƒ½

#### æœåŠ¡ç«¯é…ç½®

  1. å¼•å…¥mavenä¾èµ–

    
    
    <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-bus-amqp</artifactId>
    </dependency>
    

  1. é…ç½®æ–‡ä»¶ä¸­é…ç½®æ¶ˆæ¯é˜Ÿåˆ—ä¿¡æ¯

    
    
    # é…ç½®æ¶ˆæ¯é˜Ÿåˆ—
    rabbitmq:
      host: 192.168.10.58
      port: 5672
      username: ytooo
      password: ytooo
    

  1. é…ç½®æ–‡ä»¶ä¸­é…ç½®BUSæ€»çº¿æš´éœ²ä¿¡æ¯

    
    
    # é…ç½®busæš´éœ²ç«¯ç‚¹
    management:
      endpoints:
        web:
          exposure:
            include: "bus-refresh"
    

  1. é…ç½®æ–‡ä»¶é¢„è§ˆ

    
    
    server:
      port: 3344
    spring:
      application:
        name: cloud-config-center
      cloud:
        config:
          server:
            git:
              uri: https://github.com/sunshinelyz/cloud-config
              search-paths:
                - cloud-config
          label: master
      # é…ç½®æ¶ˆæ¯é˜Ÿåˆ—
      rabbitmq:
        host: 192.168.10.58
        port: 5672
        username: ytooo
        password: ytooo
    eureka:
      instance:
        prefer-ip-address: true
        instance-id: cloud-config-center-3344
      client:
        fetch-registry: true
        register-with-eureka: true
        service-url:
          defaultZone: http://eureka7001.com:7001/eureka/ #,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/
    # é…ç½®busæš´éœ²ç«¯ç‚¹
    management:
      endpoints:
        web:
          exposure:
            include: "bus-refresh"
    

#### å®¢æˆ·ç«¯é…ç½®

  1. å¼•å…¥mavenä¾èµ–

    
    
    <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-bus-amqp</artifactId>
    </dependency>
    

  1. é…ç½®æ–‡ä»¶ä¸­é…ç½®æ¶ˆæ¯é˜Ÿåˆ—ä¿¡æ¯

    
    
    # é…ç½®æ¶ˆæ¯é˜Ÿåˆ—
    rabbitmq:
      host: 192.168.10.58
      port: 5672
      username: ytooo
      password: ytooo
    

  1. é…ç½®æš´éœ²ç«¯ç‚¹

    
    
    # é…ç½®æš´éœ²ç«¯ç‚¹
    management:
      endpoints:
        web:
          exposure:
            include: "*"
    

  1. è°ƒç”¨é…ç½®ç±»æ·»åŠ  @RefreshScope

    
    
    @RestController
    @RefreshScope
    public class Controller {
        @Value("${config.info}")
        private String configInfo;
        @GetMapping(value = "/test")
        public String test() {
            return configInfo;
        }
    }
    

#### åˆ·æ–°é…ç½®

POST è¯·æ±‚configæœåŠ¡ç«¯ http://127.0.0.1:3344/actuator/bus-refresh

**åˆ·æ–°æˆåŠŸ**

#### å®šç‚¹é€šçŸ¥

POST è¯·æ±‚configæœåŠ¡ç«¯ http://127.0.0.1:3344/actuator/bus-refresh/{destination}

destination: æ³¨å†Œä¸­å¿ƒæœåŠ¡åç§°:ç«¯å£å·

ğŸŒ°: http://127.0.0.1:3344/actuator/bus-refresh/cloud-condig-client:3366

## SpringCloud Stream æ¶ˆæ¯é©±åŠ¨

æ¶ˆæ¯é©±åŠ¨,ç»Ÿä¸€å„ç§æ¶ˆæ¯ä¸­é—´ä»¶ä¸­çš„å·®å¼‚,æä¾›ç»Ÿä¸€ç®€å•çš„è°ƒç”¨æ–¹å¼,å±è”½æ¶ˆæ¯ä¸­é—´ä»¶å…·ä½“è°ƒç”¨å®ç°

### SpringCloud Stream æ¶ˆæ¯æä¾›è€…é¡¹ç›®é…ç½® (ç®€å•ä½¿ç”¨)

  1. æ·»åŠ mavenä¾èµ–

    
    
    <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-stream-rabbit</artifactId>
    </dependency>
    

  1. é…ç½®æ–‡ä»¶æ·»åŠ Streamé…ç½®

    
    
    spring:
      application:
        name: cloud-stream-provider
      cloud:
        stream:
          binders: # åœ¨æ­¤å¤„é…ç½®è¦ç»‘å®šçš„rabbitmqçš„æœåŠ¡ä¿¡æ¯ï¼›
            defaultRabbit: # è¡¨ç¤ºå®šä¹‰çš„åç§°ï¼Œç”¨äºäºbindingæ•´åˆ
              type: rabbit # æ¶ˆæ¯ç»„ä»¶ç±»å‹
              environment: # è®¾ç½®rabbitmqçš„ç›¸å…³çš„ç¯å¢ƒé…ç½®
                spring:
                  rabbitmq:
                    host: 192.168.10.58
                    port: 5672
                    username: ytooo
                    password: ytooo
          bindings: # æœåŠ¡çš„æ•´åˆå¤„ç†
            output: # è¿™ä¸ªåå­—æ˜¯ä¸€ä¸ªé€šé“çš„åç§°
              destination: studyExchange # è¡¨ç¤ºè¦ä½¿ç”¨çš„Exchangeåç§°å®šä¹‰
              content-type: application/json # è®¾ç½®æ¶ˆæ¯ç±»å‹ï¼Œæœ¬æ¬¡ä¸ºjsonï¼Œæ–‡æœ¬åˆ™è®¾ç½®â€œtext/plainâ€
              binder: defaultRabbit # è®¾ç½®è¦ç»‘å®šçš„æ¶ˆæ¯æœåŠ¡çš„å…·ä½“è®¾ç½®
    

  1. å®šä¹‰æ¶ˆæ¯æ¨é€ç®¡é“

    
    
    @EnableBinding(Source.class) //å®šä¹‰æ¶ˆæ¯æ¨é€ç®¡é“
    public class MsgProviderImpl implements MsgProvider {
    }
    

  1. å®šä¹‰æ¶ˆæ¯å‘é€ç®¡é“

    
    
    @Autowired
    private MessageChannel out; //å®šä¹‰æ¶ˆæ¯å‘é€ç®¡é“
    

  1. buildæ¶ˆæ¯å®ä½“å¹¶å‘é€

    
    
    Message<String> message = MessageBuilder.withPayload(msg).build();
    out.send(message);
    

  1. æ¶ˆæ¯æ¥æ”¶æ–¹ yml é…ç½®

    
    
    spring:
      application:
        name: cloud-stream-rabbitmq-consumer
      cloud:
        stream:
          binders: # åœ¨æ­¤å¤„é…ç½®è¦ç»‘å®šçš„rabbitmqçš„æœåŠ¡ä¿¡æ¯ï¼›
            defaultRabbit: # è¡¨ç¤ºå®šä¹‰çš„åç§°ï¼Œç”¨äºäºbindingæ•´åˆ
              type: rabbit # æ¶ˆæ¯ç»„ä»¶ç±»å‹
              environment: # è®¾ç½®rabbitmqçš„ç›¸å…³çš„ç¯å¢ƒé…ç½®
                spring:
                  rabbitmq:
                    host: 192.168.10.58
                    port: 5672
                    username: ytooo
                    password: ytooo
          bindings: # æœåŠ¡çš„æ•´åˆå¤„ç†
            input: # è¿™ä¸ªåå­—æ˜¯ä¸€ä¸ªé€šé“çš„åç§°                                   
              destination: studyExchange # è¡¨ç¤ºè¦ä½¿ç”¨çš„Exchangeåç§°å®šä¹‰       éœ€ä¸æä¾›æ–¹ç›¸åŒ
              content-type: application/json # è®¾ç½®æ¶ˆæ¯ç±»å‹ï¼Œæœ¬æ¬¡ä¸ºjsonï¼Œæ–‡æœ¬åˆ™è®¾ç½®â€œtext/plainâ€
              binder: defaultRabbit # è®¾ç½®è¦ç»‘å®šçš„æ¶ˆæ¯æœåŠ¡çš„å…·ä½“è®¾ç½®
    

  1. æ¥æ”¶æ–¹ç›‘å¬æ¥å£é…ç½®

    
    
    @EnableBinding(Sink.class)
    public class ReceiveMsgImpl implements ReceiveMsg {
    }
    

  1. æ¥æ”¶æ–¹æ³¨è§£

    
    
    @StreamListener(Sink.INPUT)
    public void receive(Message<String> message) {
        System.out.println("å®¢æœç«¯8803æ”¶åˆ°æ¶ˆæ¯: " + message.getPayload());
    }
    

### SpringCloud Stream åˆ†ç»„æ¶ˆè´¹ & æŒä¹…åŒ–

  * å¯¹äºä¸åŒçš„ç»„ä¸­,æ¶ˆæ¯æ˜¯ä¼šè¢«é‡å¤æ¶ˆè´¹çš„(é‡å¤æ¶ˆè´¹)
  * åŒä¸€ä¸ªç»„å†…,æœåŠ¡ä¹‹é—´å­˜åœ¨ç«äº‰å…³ç³»,åªè¢«æ¶ˆè´¹ä¸€æ¬¡(é›†ç¾¤ç¯å¢ƒ,é¿å…é‡å¤æ¶ˆè´¹)

#### åˆ†ç»„é…ç½®æ–‡ä»¶é…ç½®

    
    
    bindings: # æœåŠ¡çš„æ•´åˆå¤„ç†
      input: # è¿™ä¸ªåå­—æ˜¯ä¸€ä¸ªé€šé“çš„åç§°
        destination: studyExchange # è¡¨ç¤ºè¦ä½¿ç”¨çš„Exchangeåç§°å®šä¹‰
        content-type: application/json # è®¾ç½®æ¶ˆæ¯ç±»å‹ï¼Œæœ¬æ¬¡ä¸ºjsonï¼Œæ–‡æœ¬åˆ™è®¾ç½®â€œtext/plainâ€
        binder: defaultRabbit # è®¾ç½®è¦ç»‘å®šçš„æ¶ˆæ¯æœåŠ¡çš„å…·ä½“è®¾ç½®
        group: ytooo           #  é…ç½®æ¥æ”¶æ–¹æ‰€åœ¨ç»„
    

#### groupåˆ†ç»„ æŒä¹…åŒ–

å½“ä¸é…ç½®åˆ†ç»„æ—¶,é‡å¯æœåŠ¡,ä¸ä¼šè‡ªåŠ¨è·å–ä¹‹å‰æœªæ¶ˆè´¹çš„æœåŠ¡  
åä¹‹,é…ç½®äº†åˆ†ç»„,å¯åŠ¨æ—¶,è‡ªåŠ¨è·å–ä¹‹å‰æœªæ¶ˆè´¹çš„æ¶ˆæ¯

## Sleuth åˆ†å¸ƒå¼è¯·æ±‚é“¾è·¯è·Ÿè¸ª

åœ¨æœåŠ¡ä¸­åŠ ä¸Šä¾èµ–

    
    
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-zipkin</artifactId>
    </dependency>
    

ä¿®æ”¹application.ymlé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹

    
    
    spring:  
      zipkin:
        base-url: http://localhost:9411
      sleuth:
        sampler:
          probability: 1 # é‡‡æ ·ç‡å€¼ä»‹äº0~1ä¹‹é—´ï¼Œ1è¡¨ç¤ºå…¨éƒ¨é‡‡é›†
    

# SpringCloud Alibaba

## Nacos æ³¨å†Œä¸­å¿ƒ

### æ·»åŠ ä¾èµ–

    
    
    <dependency>
      <groupId>com.alibaba.cloud</groupId>
      <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
    

### é¡¹ç›®é…ç½®æ–‡ä»¶

    
    
    spring:
      application:
        name: cloudalibaba-nacos-consumer-order
      cloud:
        nacos:
          discovery:
            server-addr: 192.168.10.58:8848
    

### ä¸»ç¨‹åºå¯åŠ¨

    
    
    @EnableDiscoveryClient
    

### ç»“åˆ Openfeign è°ƒç”¨ æœåŠ¡

## Nacos configé…ç½®ä¸­å¿ƒ

  1. æ·»åŠ maven ä¾èµ–

    
    
    <dependency>
      <groupId>com.alibaba.cloud</groupId>
      <artifactId>spring-cloud-alibaba-nacos-config</artifactId>
    </dependency>
    

  1. bootstrap.ymlä¸­æ·»åŠ  é…ç½®ä¸­å¿ƒç›¸å…³é…ç½®

    
    
    spring:
      application:
        name: cloudalibaba-nacos-config-cclient
      cloud:
        nacos:
          discovery:
            server-addr: 192.168.10.58:8848
          config:
            server-addr: 192.168.10.58:8848
            file-extension: yaml
      profiles:
        active: dev
    

  1. ä¸šåŠ¡ç±» æ·»åŠ  @RefreshScope æ¥è‡ªåŠ¨åˆ·æ–°

    
    
    @RestController
    @RefreshScope
    public class Controller {
    

  1. é…ç½®æ–‡ä»¶ä¸­é…ç½®æ ¼å¼

åœ¨ Nacos Spring Cloud ä¸­ï¼ŒdataId çš„å®Œæ•´æ ¼å¼å¦‚ä¸‹ï¼š

**prefixâˆ’{prefix}-prefixâˆ’{spring.profiles.active}.${file-extension}**

  * prefix é»˜è®¤ä¸º spring.application.name çš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.prefixæ¥é…ç½®ã€‚
  * spring.profiles.active å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profileï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ Spring Bootæ–‡æ¡£ã€‚ æ³¨æ„ï¼šå½“ spring.profiles.active ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ - ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ prefix.{prefix}.prefix.{file-extension}
  * file-exetension ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.file-extension æ¥é…ç½®ã€‚ç›®å‰åªæ”¯æŒ properties å’Œ yaml ç±»å‹ã€‚

æœ¬å®ä¾‹ä¸­æ–‡ä»¶åç§°åº”ä¸º: cloudalibaba-nacos-config-cclient-dev.yaml

### Nacos configé…ç½®ä¸­å¿ƒ åˆ†ç±»é…ç½®

Nacos ä½¿ç”¨3å±‚æ¥éš”ç¦»æœåŠ¡

  * NameSpace å‘½åç©ºé—´,é»˜è®¤ public
  * Group ç»„, é»˜è®¤ DEFAULT_GROUP
  * Service å¾®æœåŠ¡, ä¸€ä¸ªService å¯ä»¥åŒ…å«å¤šä¸ªClusteré›†ç¾¤,é»˜è®¤Clusterä¸º DEFAULT **å¯ä»¥ç”¨äº†åŒºåˆ†åœ°åŸŸ,æ¥åšåœ°åŸŸå®¹ç¾**

yml ä¸­é…ç½®åˆ†ç»„ä¿¡æ¯group ,å’Œå‘½åç©ºé—´ namespace

    
    
    spring:
      application:
        name: cloudalibaba-nacos-config-cclient
      cloud:
        nacos:
          discovery:
            server-addr: 192.168.10.58:8848
          config:
            server-addr: 192.168.10.58:8848
            file-extension: yaml
            group: dev
            namespace: a2438b02-01e1-4a3c-959c-600d93183d22 # ä½¿ç”¨å‘½åç©ºé—´ID
    

## Sentinel æœåŠ¡ç†”æ–­ä¸é™çº§

  * å•ç‹¬çš„ç»„ä»¶
  * å¯ä»¥ç•Œé¢åŒ–,ç»†ç²’åº¦ç»Ÿä¸€é…ç½®

### Sentinel æœåŠ¡è¢«ç®¡æ–¹ é…ç½®

  1. maven ä¾èµ–

    
    
    <dependency>
      <groupId>com.alibaba.csp</groupId>
      <artifactId>sentinel-datasource-nacos</artifactId>   <!-- SentinelæŒä¹…åŒ– -->
    </dependency>
    <dependency>
      <groupId>com.alibaba.cloud</groupId>
      <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
    </dependency>
    

  1. yml ä¸­é…ç½® sentinel dashboard ç›‘æ§

    
    
    spring:
      application:
        name: cloudalibaba-sentinel-service
      cloud:
        nacos:
          discovery:
            server-addr: 192.168.10.58:8848
        sentinel:
          transport:
            dashboard: 192.168.10.58:8888 # sentinel dashboard åœ°å€
    

é…ç½®é™çº§æ–¹æ³•: æ­¤æ–¹æ³•åªé’ˆå¯¹é¡µé¢ä¸­é…ç½®çš„æŒ‡å®š é™çº§é™æµçƒ­ç‚¹ç­‰æ–¹æ³•

    
    
    @GetMapping(value = "/hot")
    @SentinelResource(value = "hot", blockHandler = "deal_hot")
    public String hot(String p1, String p2) {
        return "========================== çƒ­ç‚¹é€šè¿‡ ==========================";
    }
    
    public String deal_hot(String p1, String p2, BlockException e) {
        return "========================== çƒ­ç‚¹é™çº§ ==========================";
    }
    

## seata åˆ†å¸ƒå¼äº‹åŠ¡

  * å…¨å±€äº‹åŠ¡id
  * TC äº‹åŠ¡åè°ƒè€… ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çŠ¶æ€,é©±åŠ¨å…¨å±€äº‹åŠ¡çš„æäº¤æˆ–å›æ»š
  * TM äº‹åŠ¡ç®¡ç†å™¨ å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´,å¼€å§‹å…¨å±€äº‹åŠ¡.æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡
  * RM èµ„æºç®¡ç†å™¨ ç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æº,ä¸TCäº¤è°ˆæ¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€,å¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡çš„æäº¤æˆ–å›æ»š

**å¥½äº†ï¼Œä»Šå¤©å°±åˆ°è¿™å„¿å§ï¼Œæˆ‘æ˜¯å†°æ²³ï¼Œå¤§å®¶æœ‰å•¥é—®é¢˜å¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ï¼Œä¹Ÿå¯ä»¥åŠ æˆ‘å¾®ä¿¡ï¼šsun_shine_lyzï¼Œæˆ‘æ‹‰ä½ è¿›ç¾¤ï¼Œä¸€èµ·äº¤æµæŠ€æœ¯ï¼Œä¸€èµ·è¿›é˜¶ï¼Œä¸€èµ·ç‰›é€¼~~**

